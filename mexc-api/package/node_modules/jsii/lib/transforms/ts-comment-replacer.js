"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.TsCommentReplacer = void 0;
const ts = require("typescript");
/**
 * Machinery to replace physical doc comments in the AST with synthetic ones
 *
 * We use this to slightly tweak the comment blocks that we emit to the .js
 * and .d.ts files.
 *
 * The process is as follows:
 *
 * - Iterate over all nodes of the AST. Do the analysis that we require, remember
 *   the Nodes we want to replace the comments of in a table.
 * - When we're ready to emit JS/DTS, use transforms to replace the physical with
 *   synthetic comments by looking up the visited Nodes in the table.
 * - During transformation, we are given a "shadow copy" (?) of the actual node,
 *   so we need to resolve it to the OriginalNode (which is the one that the assembler
 *   saw) -- note that only _original_ nodes have SourceFiles attached.
 *
 * It must be done this way because:
 *
 * - Comments don't have a node in the AST. Instead, comments are called "trivia"
 *   and are discovered by _scanning the source file between two token positions_
 *   in an on-demand fashion.
 * - The only way to "add" comments to a node is to call addSyntheticComment,
 *   which remembers the comment we'd like to emit on the EmitNode of the corresponding
 *   AST Node (the printer will respect this SyntheticComment when printing everything
 *   back out again).
 * - EmitNodes are used for bookkeeping, and are cleared between different passes of
 *   the compiler. We can therefore not add the synthetic comments in the assembler
 *   pass, we have to be able to do it on-demand in a special "transform" pass.
 */
class TsCommentReplacer {
    constructor() {
        this.nodes = new Map();
    }
    /**
     * Override the doc comment of an AST node
     */
    overrideNodeDocComment(node, docstring) {
        this.nodes.set(node, { contents: docstring });
    }
    /**
     * Return the set of Transformers to be used in TSC's program.emit()
     */
    makeTransformers() {
        // eslint-disable-next-line @typescript-eslint/no-this-alias
        const self = this;
        const transformerFactory = (ctx) => {
            return (input) => {
                if (ts.isSourceFile(input)) {
                    return replaceSourceFile(input);
                }
                // I don't know what a Bundle is but seems we don't need it
                return input;
            };
            function replaceSourceFile(source) {
                return ts.visitEachChild(source, visitor, ctx);
                function visitor(node) {
                    const handled = self.handleNode(node, source);
                    return ts.visitEachChild(handled, visitor, ctx);
                }
            }
        };
        return {
            // This needs to be here to properly transform .js generation
            before: [transformerFactory],
            // This needs to be here to properly transform .d.ts generation
            afterDeclarations: [transformerFactory],
        };
    }
    handleNode(node, source) {
        const original = ts.getOriginalNode(node);
        const doOverride = this.nodes.get(original);
        if (doOverride) {
            whiteoutLeadingComments(original, source);
            this.addTsdocComment(node, doOverride.contents);
        }
        return node;
    }
    /**
     * Add a synthetic comment formatted like a TSDoc block
     *
     * A multiline trivia comment looks like "/ * (...content...) * / (newline?)".
     *
     * The TypeScript printer will take care of indentation.
     */
    addTsdocComment(node, text) {
        const lines = text.trim().split('\n');
        // eslint-disable-next-line prettier/prettier
        const commentContents = ['*\n', ...lines.map((l) => ` * ${l}\n`), ` `].join('');
        ts.addSyntheticLeadingComment(node, ts.SyntaxKind.MultiLineCommentTrivia, commentContents, true);
    }
}
exports.TsCommentReplacer = TsCommentReplacer;
/**
 * In the given source file, replace the extent of the trivia with whitespace
 *
 * This will make it invisible when the printer calls getLeadingTrivia(),
 * which will make it not render it out again. The only comments that
 * will be rendered after this will be synthetic comments.
 */
function whiteoutLeadingComments(node, source) {
    let text = source.getFullText();
    ts.forEachLeadingCommentRange(text, node.getFullStart(), (pos, end, kind) => {
        if (kind === ts.SyntaxKind.MultiLineCommentTrivia) {
            text = text.slice(0, pos).padEnd(end, ' ') + text.slice(end);
        }
    });
    if (source.text !== text) {
        source.text = text;
        source.lineMap = ts.computeLineStarts(text);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHMtY29tbWVudC1yZXBsYWNlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInRzLWNvbW1lbnQtcmVwbGFjZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsaUNBQWlDO0FBRWpDOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0dBNEJHO0FBQ0gsTUFBYSxpQkFBaUI7SUFBOUI7UUFDbUIsVUFBSyxHQUFHLElBQUksR0FBRyxFQUFxQixDQUFDO0lBNEV4RCxDQUFDO0lBMUVDOztPQUVHO0lBQ0ksc0JBQXNCLENBQUMsSUFBYSxFQUFFLFNBQWlCO1FBQzVELElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRSxFQUFFLFFBQVEsRUFBRSxTQUFTLEVBQUUsQ0FBQyxDQUFDO0lBQ2hELENBQUM7SUFFRDs7T0FFRztJQUNJLGdCQUFnQjtRQUNyQiw0REFBNEQ7UUFDNUQsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDO1FBRWxCLE1BQU0sa0JBQWtCLEdBQUcsQ0FBQyxHQUE2QixFQUFFLEVBQUU7WUFDM0QsT0FBTyxDQUFzQyxLQUFRLEVBQUssRUFBRTtnQkFDMUQsSUFBSSxFQUFFLENBQUMsWUFBWSxDQUFDLEtBQUssQ0FBQyxFQUFFO29CQUMxQixPQUFPLGlCQUFpQixDQUFDLEtBQUssQ0FBTSxDQUFDO2lCQUN0QztnQkFDRCwyREFBMkQ7Z0JBQzNELE9BQU8sS0FBSyxDQUFDO1lBQ2YsQ0FBQyxDQUFDO1lBRUYsU0FBUyxpQkFBaUIsQ0FBQyxNQUFxQjtnQkFDOUMsT0FBTyxFQUFFLENBQUMsY0FBYyxDQUFDLE1BQU0sRUFBRSxPQUFPLEVBQUUsR0FBRyxDQUFDLENBQUM7Z0JBRS9DLFNBQVMsT0FBTyxDQUFDLElBQWE7b0JBQzVCLE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxFQUFFLE1BQU0sQ0FBQyxDQUFDO29CQUM5QyxPQUFPLEVBQUUsQ0FBQyxjQUFjLENBQUMsT0FBTyxFQUFFLE9BQU8sRUFBRSxHQUFHLENBQUMsQ0FBQztnQkFDbEQsQ0FBQztZQUNILENBQUM7UUFDSCxDQUFDLENBQUM7UUFFRixPQUFPO1lBQ0wsNkRBQTZEO1lBQzdELE1BQU0sRUFBRSxDQUFDLGtCQUFrQixDQUFDO1lBQzVCLCtEQUErRDtZQUMvRCxpQkFBaUIsRUFBRSxDQUFDLGtCQUFrQixDQUFDO1NBQ3hDLENBQUM7SUFDSixDQUFDO0lBRU8sVUFBVSxDQUFvQixJQUFPLEVBQUUsTUFBcUI7UUFDbEUsTUFBTSxRQUFRLEdBQUcsRUFBRSxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUMxQyxNQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUU1QyxJQUFJLFVBQVUsRUFBRTtZQUNkLHVCQUF1QixDQUFDLFFBQVEsRUFBRSxNQUFNLENBQUMsQ0FBQztZQUMxQyxJQUFJLENBQUMsZUFBZSxDQUFDLElBQUksRUFBRSxVQUFVLENBQUMsUUFBUSxDQUFDLENBQUM7U0FDakQ7UUFDRCxPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7SUFFRDs7Ozs7O09BTUc7SUFDSyxlQUFlLENBQUMsSUFBYSxFQUFFLElBQVk7UUFDakQsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUV0Qyw2Q0FBNkM7UUFDN0MsTUFBTSxlQUFlLEdBQUcsQ0FBQyxLQUFLLEVBQUUsR0FBRyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUN6RSxFQUFFLENBQ0gsQ0FBQztRQUVGLEVBQUUsQ0FBQywwQkFBMEIsQ0FDM0IsSUFBSSxFQUNKLEVBQUUsQ0FBQyxVQUFVLENBQUMsc0JBQXNCLEVBQ3BDLGVBQWUsRUFDZixJQUFJLENBQ0wsQ0FBQztJQUNKLENBQUM7Q0FDRjtBQTdFRCw4Q0E2RUM7QUFNRDs7Ozs7O0dBTUc7QUFDSCxTQUFTLHVCQUF1QixDQUFDLElBQWEsRUFBRSxNQUFxQjtJQUNuRSxJQUFJLElBQUksR0FBRyxNQUFNLENBQUMsV0FBVyxFQUFFLENBQUM7SUFDaEMsRUFBRSxDQUFDLDBCQUEwQixDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsWUFBWSxFQUFFLEVBQUUsQ0FBQyxHQUFHLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxFQUFFO1FBQzFFLElBQUksSUFBSSxLQUFLLEVBQUUsQ0FBQyxVQUFVLENBQUMsc0JBQXNCLEVBQUU7WUFDakQsSUFBSSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxHQUFHLEVBQUUsR0FBRyxDQUFDLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztTQUM5RDtJQUNILENBQUMsQ0FBQyxDQUFDO0lBQ0gsSUFBSSxNQUFNLENBQUMsSUFBSSxLQUFLLElBQUksRUFBRTtRQUN4QixNQUFNLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztRQUNsQixNQUFjLENBQUMsT0FBTyxHQUFJLEVBQVUsQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsQ0FBQztLQUMvRDtBQUNILENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyB0cyBmcm9tICd0eXBlc2NyaXB0JztcblxuLyoqXG4gKiBNYWNoaW5lcnkgdG8gcmVwbGFjZSBwaHlzaWNhbCBkb2MgY29tbWVudHMgaW4gdGhlIEFTVCB3aXRoIHN5bnRoZXRpYyBvbmVzXG4gKlxuICogV2UgdXNlIHRoaXMgdG8gc2xpZ2h0bHkgdHdlYWsgdGhlIGNvbW1lbnQgYmxvY2tzIHRoYXQgd2UgZW1pdCB0byB0aGUgLmpzXG4gKiBhbmQgLmQudHMgZmlsZXMuXG4gKlxuICogVGhlIHByb2Nlc3MgaXMgYXMgZm9sbG93czpcbiAqXG4gKiAtIEl0ZXJhdGUgb3ZlciBhbGwgbm9kZXMgb2YgdGhlIEFTVC4gRG8gdGhlIGFuYWx5c2lzIHRoYXQgd2UgcmVxdWlyZSwgcmVtZW1iZXJcbiAqICAgdGhlIE5vZGVzIHdlIHdhbnQgdG8gcmVwbGFjZSB0aGUgY29tbWVudHMgb2YgaW4gYSB0YWJsZS5cbiAqIC0gV2hlbiB3ZSdyZSByZWFkeSB0byBlbWl0IEpTL0RUUywgdXNlIHRyYW5zZm9ybXMgdG8gcmVwbGFjZSB0aGUgcGh5c2ljYWwgd2l0aFxuICogICBzeW50aGV0aWMgY29tbWVudHMgYnkgbG9va2luZyB1cCB0aGUgdmlzaXRlZCBOb2RlcyBpbiB0aGUgdGFibGUuXG4gKiAtIER1cmluZyB0cmFuc2Zvcm1hdGlvbiwgd2UgYXJlIGdpdmVuIGEgXCJzaGFkb3cgY29weVwiICg/KSBvZiB0aGUgYWN0dWFsIG5vZGUsXG4gKiAgIHNvIHdlIG5lZWQgdG8gcmVzb2x2ZSBpdCB0byB0aGUgT3JpZ2luYWxOb2RlICh3aGljaCBpcyB0aGUgb25lIHRoYXQgdGhlIGFzc2VtYmxlclxuICogICBzYXcpIC0tIG5vdGUgdGhhdCBvbmx5IF9vcmlnaW5hbF8gbm9kZXMgaGF2ZSBTb3VyY2VGaWxlcyBhdHRhY2hlZC5cbiAqXG4gKiBJdCBtdXN0IGJlIGRvbmUgdGhpcyB3YXkgYmVjYXVzZTpcbiAqXG4gKiAtIENvbW1lbnRzIGRvbid0IGhhdmUgYSBub2RlIGluIHRoZSBBU1QuIEluc3RlYWQsIGNvbW1lbnRzIGFyZSBjYWxsZWQgXCJ0cml2aWFcIlxuICogICBhbmQgYXJlIGRpc2NvdmVyZWQgYnkgX3NjYW5uaW5nIHRoZSBzb3VyY2UgZmlsZSBiZXR3ZWVuIHR3byB0b2tlbiBwb3NpdGlvbnNfXG4gKiAgIGluIGFuIG9uLWRlbWFuZCBmYXNoaW9uLlxuICogLSBUaGUgb25seSB3YXkgdG8gXCJhZGRcIiBjb21tZW50cyB0byBhIG5vZGUgaXMgdG8gY2FsbCBhZGRTeW50aGV0aWNDb21tZW50LFxuICogICB3aGljaCByZW1lbWJlcnMgdGhlIGNvbW1lbnQgd2UnZCBsaWtlIHRvIGVtaXQgb24gdGhlIEVtaXROb2RlIG9mIHRoZSBjb3JyZXNwb25kaW5nXG4gKiAgIEFTVCBOb2RlICh0aGUgcHJpbnRlciB3aWxsIHJlc3BlY3QgdGhpcyBTeW50aGV0aWNDb21tZW50IHdoZW4gcHJpbnRpbmcgZXZlcnl0aGluZ1xuICogICBiYWNrIG91dCBhZ2FpbikuXG4gKiAtIEVtaXROb2RlcyBhcmUgdXNlZCBmb3IgYm9va2tlZXBpbmcsIGFuZCBhcmUgY2xlYXJlZCBiZXR3ZWVuIGRpZmZlcmVudCBwYXNzZXMgb2ZcbiAqICAgdGhlIGNvbXBpbGVyLiBXZSBjYW4gdGhlcmVmb3JlIG5vdCBhZGQgdGhlIHN5bnRoZXRpYyBjb21tZW50cyBpbiB0aGUgYXNzZW1ibGVyXG4gKiAgIHBhc3MsIHdlIGhhdmUgdG8gYmUgYWJsZSB0byBkbyBpdCBvbi1kZW1hbmQgaW4gYSBzcGVjaWFsIFwidHJhbnNmb3JtXCIgcGFzcy5cbiAqL1xuZXhwb3J0IGNsYXNzIFRzQ29tbWVudFJlcGxhY2VyIHtcbiAgcHJpdmF0ZSByZWFkb25seSBub2RlcyA9IG5ldyBNYXA8dHMuTm9kZSwgTm9kZURvY3M+KCk7XG5cbiAgLyoqXG4gICAqIE92ZXJyaWRlIHRoZSBkb2MgY29tbWVudCBvZiBhbiBBU1Qgbm9kZVxuICAgKi9cbiAgcHVibGljIG92ZXJyaWRlTm9kZURvY0NvbW1lbnQobm9kZTogdHMuTm9kZSwgZG9jc3RyaW5nOiBzdHJpbmcpOiB2b2lkIHtcbiAgICB0aGlzLm5vZGVzLnNldChub2RlLCB7IGNvbnRlbnRzOiBkb2NzdHJpbmcgfSk7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJuIHRoZSBzZXQgb2YgVHJhbnNmb3JtZXJzIHRvIGJlIHVzZWQgaW4gVFNDJ3MgcHJvZ3JhbS5lbWl0KClcbiAgICovXG4gIHB1YmxpYyBtYWtlVHJhbnNmb3JtZXJzKCk6IHRzLkN1c3RvbVRyYW5zZm9ybWVycyB7XG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby10aGlzLWFsaWFzXG4gICAgY29uc3Qgc2VsZiA9IHRoaXM7XG5cbiAgICBjb25zdCB0cmFuc2Zvcm1lckZhY3RvcnkgPSAoY3R4OiB0cy5UcmFuc2Zvcm1hdGlvbkNvbnRleHQpID0+IHtcbiAgICAgIHJldHVybiA8VCBleHRlbmRzIHRzLkJ1bmRsZSB8IHRzLlNvdXJjZUZpbGU+KGlucHV0OiBUKTogVCA9PiB7XG4gICAgICAgIGlmICh0cy5pc1NvdXJjZUZpbGUoaW5wdXQpKSB7XG4gICAgICAgICAgcmV0dXJuIHJlcGxhY2VTb3VyY2VGaWxlKGlucHV0KSBhcyBUO1xuICAgICAgICB9XG4gICAgICAgIC8vIEkgZG9uJ3Qga25vdyB3aGF0IGEgQnVuZGxlIGlzIGJ1dCBzZWVtcyB3ZSBkb24ndCBuZWVkIGl0XG4gICAgICAgIHJldHVybiBpbnB1dDtcbiAgICAgIH07XG5cbiAgICAgIGZ1bmN0aW9uIHJlcGxhY2VTb3VyY2VGaWxlKHNvdXJjZTogdHMuU291cmNlRmlsZSk6IHRzLlNvdXJjZUZpbGUge1xuICAgICAgICByZXR1cm4gdHMudmlzaXRFYWNoQ2hpbGQoc291cmNlLCB2aXNpdG9yLCBjdHgpO1xuXG4gICAgICAgIGZ1bmN0aW9uIHZpc2l0b3Iobm9kZTogdHMuTm9kZSk6IHRzLk5vZGUge1xuICAgICAgICAgIGNvbnN0IGhhbmRsZWQgPSBzZWxmLmhhbmRsZU5vZGUobm9kZSwgc291cmNlKTtcbiAgICAgICAgICByZXR1cm4gdHMudmlzaXRFYWNoQ2hpbGQoaGFuZGxlZCwgdmlzaXRvciwgY3R4KTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH07XG5cbiAgICByZXR1cm4ge1xuICAgICAgLy8gVGhpcyBuZWVkcyB0byBiZSBoZXJlIHRvIHByb3Blcmx5IHRyYW5zZm9ybSAuanMgZ2VuZXJhdGlvblxuICAgICAgYmVmb3JlOiBbdHJhbnNmb3JtZXJGYWN0b3J5XSxcbiAgICAgIC8vIFRoaXMgbmVlZHMgdG8gYmUgaGVyZSB0byBwcm9wZXJseSB0cmFuc2Zvcm0gLmQudHMgZ2VuZXJhdGlvblxuICAgICAgYWZ0ZXJEZWNsYXJhdGlvbnM6IFt0cmFuc2Zvcm1lckZhY3RvcnldLFxuICAgIH07XG4gIH1cblxuICBwcml2YXRlIGhhbmRsZU5vZGU8VCBleHRlbmRzIHRzLk5vZGU+KG5vZGU6IFQsIHNvdXJjZTogdHMuU291cmNlRmlsZSk6IFQge1xuICAgIGNvbnN0IG9yaWdpbmFsID0gdHMuZ2V0T3JpZ2luYWxOb2RlKG5vZGUpO1xuICAgIGNvbnN0IGRvT3ZlcnJpZGUgPSB0aGlzLm5vZGVzLmdldChvcmlnaW5hbCk7XG5cbiAgICBpZiAoZG9PdmVycmlkZSkge1xuICAgICAgd2hpdGVvdXRMZWFkaW5nQ29tbWVudHMob3JpZ2luYWwsIHNvdXJjZSk7XG4gICAgICB0aGlzLmFkZFRzZG9jQ29tbWVudChub2RlLCBkb092ZXJyaWRlLmNvbnRlbnRzKTtcbiAgICB9XG4gICAgcmV0dXJuIG5vZGU7XG4gIH1cblxuICAvKipcbiAgICogQWRkIGEgc3ludGhldGljIGNvbW1lbnQgZm9ybWF0dGVkIGxpa2UgYSBUU0RvYyBibG9ja1xuICAgKlxuICAgKiBBIG11bHRpbGluZSB0cml2aWEgY29tbWVudCBsb29rcyBsaWtlIFwiLyAqICguLi5jb250ZW50Li4uKSAqIC8gKG5ld2xpbmU/KVwiLlxuICAgKlxuICAgKiBUaGUgVHlwZVNjcmlwdCBwcmludGVyIHdpbGwgdGFrZSBjYXJlIG9mIGluZGVudGF0aW9uLlxuICAgKi9cbiAgcHJpdmF0ZSBhZGRUc2RvY0NvbW1lbnQobm9kZTogdHMuTm9kZSwgdGV4dDogc3RyaW5nKSB7XG4gICAgY29uc3QgbGluZXMgPSB0ZXh0LnRyaW0oKS5zcGxpdCgnXFxuJyk7XG5cbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgcHJldHRpZXIvcHJldHRpZXJcbiAgICBjb25zdCBjb21tZW50Q29udGVudHMgPSBbJypcXG4nLCAuLi5saW5lcy5tYXAoKGwpID0+IGAgKiAke2x9XFxuYCksIGAgYF0uam9pbihcbiAgICAgICcnLFxuICAgICk7XG5cbiAgICB0cy5hZGRTeW50aGV0aWNMZWFkaW5nQ29tbWVudChcbiAgICAgIG5vZGUsXG4gICAgICB0cy5TeW50YXhLaW5kLk11bHRpTGluZUNvbW1lbnRUcml2aWEsXG4gICAgICBjb21tZW50Q29udGVudHMsXG4gICAgICB0cnVlLFxuICAgICk7XG4gIH1cbn1cblxuaW50ZXJmYWNlIE5vZGVEb2NzIHtcbiAgcmVhZG9ubHkgY29udGVudHM6IHN0cmluZztcbn1cblxuLyoqXG4gKiBJbiB0aGUgZ2l2ZW4gc291cmNlIGZpbGUsIHJlcGxhY2UgdGhlIGV4dGVudCBvZiB0aGUgdHJpdmlhIHdpdGggd2hpdGVzcGFjZVxuICpcbiAqIFRoaXMgd2lsbCBtYWtlIGl0IGludmlzaWJsZSB3aGVuIHRoZSBwcmludGVyIGNhbGxzIGdldExlYWRpbmdUcml2aWEoKSxcbiAqIHdoaWNoIHdpbGwgbWFrZSBpdCBub3QgcmVuZGVyIGl0IG91dCBhZ2Fpbi4gVGhlIG9ubHkgY29tbWVudHMgdGhhdFxuICogd2lsbCBiZSByZW5kZXJlZCBhZnRlciB0aGlzIHdpbGwgYmUgc3ludGhldGljIGNvbW1lbnRzLlxuICovXG5mdW5jdGlvbiB3aGl0ZW91dExlYWRpbmdDb21tZW50cyhub2RlOiB0cy5Ob2RlLCBzb3VyY2U6IHRzLlNvdXJjZUZpbGUpIHtcbiAgbGV0IHRleHQgPSBzb3VyY2UuZ2V0RnVsbFRleHQoKTtcbiAgdHMuZm9yRWFjaExlYWRpbmdDb21tZW50UmFuZ2UodGV4dCwgbm9kZS5nZXRGdWxsU3RhcnQoKSwgKHBvcywgZW5kLCBraW5kKSA9PiB7XG4gICAgaWYgKGtpbmQgPT09IHRzLlN5bnRheEtpbmQuTXVsdGlMaW5lQ29tbWVudFRyaXZpYSkge1xuICAgICAgdGV4dCA9IHRleHQuc2xpY2UoMCwgcG9zKS5wYWRFbmQoZW5kLCAnICcpICsgdGV4dC5zbGljZShlbmQpO1xuICAgIH1cbiAgfSk7XG4gIGlmIChzb3VyY2UudGV4dCAhPT0gdGV4dCkge1xuICAgIHNvdXJjZS50ZXh0ID0gdGV4dDtcbiAgICAoc291cmNlIGFzIGFueSkubGluZU1hcCA9ICh0cyBhcyBhbnkpLmNvbXB1dGVMaW5lU3RhcnRzKHRleHQpO1xuICB9XG59XG4iXX0=