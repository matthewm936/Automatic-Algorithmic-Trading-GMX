"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.loadProjectInfo = void 0;
const spec = require("@jsii/spec");
const fs = require("fs-extra");
const log4js = require("log4js");
const path = require("path");
const semver = require("semver");
const semver_intersect_1 = require("semver-intersect");
const ts = require("typescript");
const jsii_diagnostic_1 = require("./jsii-diagnostic");
const utils_1 = require("./utils");
// eslint-disable-next-line @typescript-eslint/no-var-requires, @typescript-eslint/no-require-imports
const spdx = require('spdx-license-list/simple');
const LOG = log4js.getLogger('jsii/package-info');
async function loadProjectInfo(projectRoot) {
    var _a, _b, _c, _d, _e, _f, _g, _h, _j, _k, _l, _m, _o, _p, _q, _r, _s;
    const packageJsonPath = path.join(projectRoot, 'package.json');
    // eslint-disable-next-line @typescript-eslint/no-var-requires,@typescript-eslint/no-require-imports
    const pkg = require(packageJsonPath);
    const diagnostics = [];
    let bundleDependencies;
    for (const name of (_b = (_a = pkg.bundleDependencies) !== null && _a !== void 0 ? _a : pkg.bundledDependencies) !== null && _b !== void 0 ? _b : []) {
        const version = (_c = pkg.dependencies) === null || _c === void 0 ? void 0 : _c[name];
        if (!version) {
            throw new Error(`The "package.json" file has "${name}" in "bundleDependencies", but it is not declared in "dependencies"`);
        }
        if (pkg.peerDependencies && name in pkg.peerDependencies) {
            throw new Error(`The "package.json" file has "${name}" in "bundleDependencies", and also in "peerDependencies"`);
        }
        bundleDependencies = bundleDependencies !== null && bundleDependencies !== void 0 ? bundleDependencies : {};
        bundleDependencies[name] = _resolveVersion(version, projectRoot).version;
    }
    // Check peerDependencies are also in devDependencies
    // You need this to write tests properly. There are probably cases where
    // it makes sense to have this different, so most of what this checking
    // produces is warnings, not errors.
    const devDependencies = (_d = pkg.devDependencies) !== null && _d !== void 0 ? _d : {};
    for (const [name, rng] of Object.entries((_e = pkg.peerDependencies) !== null && _e !== void 0 ? _e : {})) {
        const range = new semver.Range(_resolveVersion(rng, projectRoot).version);
        const minVersion = (_f = semver.minVersion(range)) === null || _f === void 0 ? void 0 : _f.raw;
        if (!(name in devDependencies) ||
            devDependencies[name] !== `${minVersion}`) {
            diagnostics.push(jsii_diagnostic_1.JsiiDiagnostic.JSII_0006_MISSING_DEV_DEPENDENCY.createDetached(name, `${rng}`, `${minVersion}`, `${devDependencies[name]}`));
            continue;
        }
    }
    const transitiveAssemblies = {};
    const assemblyCache = new Map();
    const dependencies = await _loadDependencies(pkg.dependencies, projectRoot, transitiveAssemblies, assemblyCache, new Set(Object.keys(bundleDependencies !== null && bundleDependencies !== void 0 ? bundleDependencies : {})));
    const peerDependencies = await _loadDependencies(pkg.peerDependencies, projectRoot, transitiveAssemblies, assemblyCache);
    const transitiveDependencies = Object.values(transitiveAssemblies);
    const metadata = mergeMetadata({
        jsii: {
            pacmak: {
                // When `true`, `jsii-pacmak` will use the `Jsii$Default` implementation in code generation even for dependencies.
                hasDefaultInterfaces: true,
            },
        },
    }, (_g = pkg.jsii) === null || _g === void 0 ? void 0 : _g.metadata);
    const projectInfo = {
        projectRoot,
        packageJson: pkg,
        name: _required(pkg.name, 'The "package.json" file must specify the "name" attribute'),
        version: _required(pkg.version, 'The "package.json" file must specify the "version" attribute'),
        deprecated: pkg.deprecated,
        stability: _validateStability(pkg.stability, pkg.deprecated),
        author: _toPerson(_required(pkg.author, 'The "package.json" file must specify the "author" attribute'), 'author'),
        repository: _toRepository(_required(pkg.repository, 'The "package.json" file must specify the "repository" attribute')),
        license: _validateLicense(pkg.license),
        keywords: pkg.keywords,
        main: _required(pkg.main, 'The "package.json" file must specify the "main" attribute'),
        types: _required(pkg.types, 'The "package.json" file must specify the "types" attribute'),
        dependencies,
        peerDependencies,
        dependencyClosure: transitiveDependencies,
        bundleDependencies,
        targets: {
            ..._required(pkg.jsii, 'The "package.json" file must specify the "jsii" attribute').targets,
            js: { npm: pkg.name },
        },
        metadata,
        jsiiVersionFormat: _validateVersionFormat((_h = pkg.jsii.versionFormat) !== null && _h !== void 0 ? _h : 'full'),
        description: pkg.description,
        homepage: pkg.homepage,
        contributors: (_j = pkg.contributors) === null || _j === void 0 ? void 0 : _j.map((contrib, index) => _toPerson(contrib, `contributors[${index}]`, 'contributor')),
        excludeTypescript: (_l = (_k = pkg.jsii) === null || _k === void 0 ? void 0 : _k.excludeTypescript) !== null && _l !== void 0 ? _l : [],
        projectReferences: (_m = pkg.jsii) === null || _m === void 0 ? void 0 : _m.projectReferences,
        tsc: {
            outDir: (_p = (_o = pkg.jsii) === null || _o === void 0 ? void 0 : _o.tsc) === null || _p === void 0 ? void 0 : _p.outDir,
            rootDir: (_r = (_q = pkg.jsii) === null || _q === void 0 ? void 0 : _q.tsc) === null || _r === void 0 ? void 0 : _r.rootDir,
        },
        bin: pkg.bin,
        diagnostics: _loadDiagnostics((_s = pkg.jsii) === null || _s === void 0 ? void 0 : _s.diagnostics),
    };
    return { projectInfo, diagnostics };
}
exports.loadProjectInfo = loadProjectInfo;
function _guessRepositoryType(url) {
    if (url.endsWith('.git')) {
        return 'git';
    }
    const parts = /^([^:]+):\/\//.exec(url);
    if ((parts === null || parts === void 0 ? void 0 : parts[1]) !== 'http' && (parts === null || parts === void 0 ? void 0 : parts[1]) !== 'https') {
        return parts[1];
    }
    throw new Error(`The "package.json" file must specify the "repository.type" attribute (could not guess from ${url})`);
}
async function _loadDependencies(dependencies, searchPath, transitiveAssemblies, assemblyCache, bundled = new Set()) {
    if (!dependencies) {
        return {};
    }
    const packageVersions = {};
    for (const name of Object.keys(dependencies)) {
        if (bundled.has(name)) {
            continue;
        }
        const { version: versionString, localPackage } = _resolveVersion(dependencies[name], searchPath);
        const version = new semver.Range(versionString);
        if (!version) {
            throw new Error(`Invalid semver expression for ${name}: ${versionString}`);
        }
        const pkg = _tryResolveAssembly(name, localPackage, searchPath);
        LOG.debug(`Resolved dependency ${name} to ${pkg}`);
        // eslint-disable-next-line no-await-in-loop
        const assm = await loadAndValidateAssembly(pkg, assemblyCache);
        if (!semver.satisfies(assm.version, version)) {
            throw new Error(`Declared dependency on version ${versionString} of ${name}, but version ${assm.version} was found`);
        }
        packageVersions[assm.name] =
            packageVersions[assm.name] != null
                ? semver_intersect_1.intersect(versionString, packageVersions[assm.name])
                : versionString;
        transitiveAssemblies[assm.name] = assm;
        const pkgDir = path.dirname(pkg);
        if (assm.dependencies) {
            // eslint-disable-next-line no-await-in-loop
            await _loadDependencies(assm.dependencies, pkgDir, transitiveAssemblies, assemblyCache);
        }
    }
    return packageVersions;
}
/**
 * Load a JSII filename and validate it; cached to avoid redundant loads of the same JSII assembly
 */
async function loadAndValidateAssembly(jsiiFileName, cache) {
    if (!cache.has(jsiiFileName)) {
        try {
            cache.set(jsiiFileName, await fs.readJson(jsiiFileName));
        }
        catch (e) {
            throw new Error(`Error loading ${jsiiFileName}: ${e}`);
        }
    }
    return cache.get(jsiiFileName);
}
function _required(value, message) {
    if (value == null) {
        throw new Error(message);
    }
    return value;
}
function _toPerson(value, field, defaultRole = field) {
    if (typeof value === 'string') {
        value = utils_1.parsePerson(value);
    }
    return {
        name: _required(value.name, `The "package.json" file must specify the "${field}.name" attribute`),
        roles: value.roles ? [...new Set(value.roles)] : [defaultRole],
        email: value.email,
        url: value.url,
        organization: value.organization ? value.organization : undefined,
    };
}
function _toRepository(value) {
    if (typeof value === 'string') {
        value = utils_1.parseRepository(value);
    }
    return {
        url: _required(value.url, 'The "package.json" file must specify the "repository.url" attribute'),
        type: value.type || _guessRepositoryType(value.url),
        directory: value.directory,
    };
}
function _tryResolveAssembly(mod, localPackage, searchPath) {
    if (localPackage) {
        const result = path.join(localPackage, '.jsii');
        if (!fs.existsSync(result)) {
            throw new Error(`Assembly does not exist: ${result}`);
        }
        return result;
    }
    try {
        const paths = [searchPath, path.join(searchPath, 'node_modules')];
        return require.resolve(path.join(mod, '.jsii'), { paths });
    }
    catch {
        throw new Error(`Unable to locate jsii assembly for "${mod}". If this module is not jsii-enabled, it must also be declared under bundledDependencies.`);
    }
}
function _validateLicense(id) {
    if (id === 'UNLICENSED') {
        return id;
    }
    if (!spdx.has(id)) {
        throw new Error(`Invalid license identifier "${id}", see valid license identifiers at https://spdx.org/licenses/`);
    }
    return id;
}
function _validateVersionFormat(format) {
    if (format !== 'short' && format !== 'full') {
        throw new Error(`Invalid jsii.versionFormat "${format}", it must be either "short" or "full" (the default)`);
    }
    return format;
}
function _validateStability(stability, deprecated) {
    if (!stability && deprecated) {
        stability = spec.Stability.Deprecated;
    }
    else if (deprecated && stability !== spec.Stability.Deprecated) {
        throw new Error(`Package is deprecated (${deprecated}), but it's stability is ${stability} and not ${spec.Stability.Deprecated}`);
    }
    if (!stability) {
        return undefined;
    }
    if (!Object.values(spec.Stability).includes(stability)) {
        throw new Error(`Invalid stability "${stability}", it must be one of ${Object.values(spec.Stability).join(', ')}`);
    }
    return stability;
}
/**
 * Resolves an NPM package specifier to a version range
 *
 * If it was already a version range, return it. If it the
 * package references a local file, return the version that
 * package is at.
 */
function _resolveVersion(dep, searchPath) {
    const matches = /^file:(.+)$/.exec(dep);
    if (!matches) {
        return { version: dep };
    }
    const localPackage = path.resolve(searchPath, matches[1]);
    return {
        // Rendering as a caret version to maintain uniformity against the "standard".
        // eslint-disable-next-line @typescript-eslint/no-require-imports,@typescript-eslint/no-var-requires
        version: `^${require(path.join(localPackage, 'package.json')).version}`,
        localPackage,
    };
}
/**
 * Merges two metadata blocks together.
 *
 * @param base the base values
 * @param user the user-supplied values, which can override the `base` values
 *
 * @returns the merged metadata block
 */
function mergeMetadata(base, user) {
    if (user == null) {
        return base;
    }
    return mergeObjects(base, user);
    function mergeObjects(base, override) {
        const result = {};
        const allKeys = Array.from(new Set([...Object.keys(base), ...Object.keys(override)])).sort();
        for (const key of allKeys) {
            const baseValue = base[key];
            const overrideValue = override[key];
            if (typeof baseValue === 'object' && typeof overrideValue === 'object') {
                if (overrideValue != null) {
                    result[key] = mergeObjects(baseValue, overrideValue);
                }
            }
            else {
                result[key] = overrideValue !== null && overrideValue !== void 0 ? overrideValue : baseValue;
            }
        }
        return result;
    }
}
function _loadDiagnostics(entries) {
    if (entries === undefined || Object.keys(entries).length === 0) {
        return undefined;
    }
    const result = {};
    for (const code of Object.keys(entries)) {
        let category;
        switch (entries[code].trim().toLowerCase()) {
            case 'error':
                category = ts.DiagnosticCategory.Error;
                break;
            case 'warning':
                category = ts.DiagnosticCategory.Warning;
                break;
            case 'suggestion':
                category = ts.DiagnosticCategory.Suggestion;
                break;
            case 'message':
                category = ts.DiagnosticCategory.Message;
                break;
            default:
                throw new Error(`Invalid category '${entries[code]}' for code '${code}'`);
        }
        result[code] = category;
    }
    return result;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvamVjdC1pbmZvLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsicHJvamVjdC1pbmZvLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLG1DQUFtQztBQUNuQywrQkFBK0I7QUFDL0IsaUNBQWlDO0FBQ2pDLDZCQUE2QjtBQUM3QixpQ0FBaUM7QUFDakMsdURBQTZDO0FBQzdDLGlDQUFpQztBQUVqQyx1REFBbUQ7QUFDbkQsbUNBQXVEO0FBRXZELHFHQUFxRztBQUNyRyxNQUFNLElBQUksR0FBZ0IsT0FBTyxDQUFDLDBCQUEwQixDQUFDLENBQUM7QUFFOUQsTUFBTSxHQUFHLEdBQUcsTUFBTSxDQUFDLFNBQVMsQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDO0FBa0QzQyxLQUFLLFVBQVUsZUFBZSxDQUNuQyxXQUFtQjs7SUFFbkIsTUFBTSxlQUFlLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUUsY0FBYyxDQUFDLENBQUM7SUFDL0Qsb0dBQW9HO0lBQ3BHLE1BQU0sR0FBRyxHQUFHLE9BQU8sQ0FBQyxlQUFlLENBQUMsQ0FBQztJQUVyQyxNQUFNLFdBQVcsR0FBb0IsRUFBRSxDQUFDO0lBRXhDLElBQUksa0JBQTBELENBQUM7SUFDL0QsS0FBSyxNQUFNLElBQUksZ0JBQUksR0FBRyxDQUFDLGtCQUFrQixtQ0FBSSxHQUFHLENBQUMsbUJBQW1CLG1DQUFJLEVBQUUsRUFBRTtRQUMxRSxNQUFNLE9BQU8sU0FBRyxHQUFHLENBQUMsWUFBWSwwQ0FBRyxJQUFJLENBQUMsQ0FBQztRQUN6QyxJQUFJLENBQUMsT0FBTyxFQUFFO1lBQ1osTUFBTSxJQUFJLEtBQUssQ0FDYixnQ0FBZ0MsSUFBSSxxRUFBcUUsQ0FDMUcsQ0FBQztTQUNIO1FBRUQsSUFBSSxHQUFHLENBQUMsZ0JBQWdCLElBQUksSUFBSSxJQUFJLEdBQUcsQ0FBQyxnQkFBZ0IsRUFBRTtZQUN4RCxNQUFNLElBQUksS0FBSyxDQUNiLGdDQUFnQyxJQUFJLDJEQUEyRCxDQUNo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QUFDLElBQUksQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDLFdBQVcsRUFBRSxFQUFFO1lBQzFDLEtBQUssT0FBTztnQkFDVixRQUFRLEdBQUcsRUFBRSxDQUFDLGtCQUFrQixDQUFDLEtBQUssQ0FBQztnQkFDdkMsTUFBTTtZQUNSLEtBQUssU0FBUztnQkFDWixRQUFRLEdBQUcsRUFBRSxDQUFDLGtCQUFrQixDQUFDLE9BQU8sQ0FBQztnQkFDekMsTUFBTTtZQUNSLEtBQUssWUFBWTtnQkFDZixRQUFRLEdBQUcsRUFBRSxDQUFDLGtCQUFrQixDQUFDLFVBQVUsQ0FBQztnQkFDNUMsTUFBTTtZQUNSLEtBQUssU0FBUztnQkFDWixRQUFRLEdBQUcsRUFBRSxDQUFDLGtCQUFrQixDQUFDLE9BQU8sQ0FBQztnQkFDekMsTUFBTTtZQUNSO2dCQUNFLE1BQU0sSUFBSSxLQUFLLENBQ2IscUJBQXFCLE9BQU8sQ0FBQyxJQUFJLENBQUMsZUFBZSxJQUFJLEdBQUcsQ0FDekQsQ0FBQztTQUNMO1FBQ0QsTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLFFBQVEsQ0FBQztLQUN6QjtJQUNELE9BQU8sTUFBTSxDQUFDO0FBQ2hCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBzcGVjIGZyb20gJ0Bqc2lpL3NwZWMnO1xuaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMtZXh0cmEnO1xuaW1wb3J0ICogYXMgbG9nNGpzIGZyb20gJ2xvZzRqcyc7XG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0ICogYXMgc2VtdmVyIGZyb20gJ3NlbXZlcic7XG5pbXBvcnQgeyBpbnRlcnNlY3QgfSBmcm9tICdzZW12ZXItaW50ZXJzZWN0JztcbmltcG9ydCAqIGFzIHRzIGZyb20gJ3R5cGVzY3JpcHQnO1xuXG5pbXBvcnQgeyBKc2lpRGlhZ25vc3RpYyB9IGZyb20gJy4vanNpaS1kaWFnbm9zdGljJztcbmltcG9ydCB7IHBhcnNlUGVyc29uLCBwYXJzZVJlcG9zaXRvcnkgfSBmcm9tICcuL3V0aWxzJztcblxuLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby12YXItcmVxdWlyZXMsIEB0eXBlc2NyaXB0LWVzbGludC9uby1yZXF1aXJlLWltcG9ydHNcbmNvbnN0IHNwZHg6IFNldDxzdHJpbmc+ID0gcmVxdWlyZSgnc3BkeC1saWNlbnNlLWxpc3Qvc2ltcGxlJyk7XG5cbmNvbnN0IExPRyA9IGxvZzRqcy5nZXRMb2dnZXIoJ2pzaWkvcGFja2FnZS1pbmZvJyk7XG5cbmV4cG9ydCBpbnRlcmZhY2UgVFNDb21waWxlck9wdGlvbnMge1xuICByZWFkb25seSBvdXREaXI/OiBzdHJpbmc7XG4gIHJlYWRvbmx5IHJvb3REaXI/OiBzdHJpbmc7XG4gIHJlYWRvbmx5IGZvcmNlQ29uc2lzdGVudENhc2luZ0luRmlsZU5hbWVzPzogYm9vbGVhbjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBQcm9qZWN0SW5mbyB7XG4gIHJlYWRvbmx5IHByb2plY3RSb290OiBzdHJpbmc7XG4gIHJlYWRvbmx5IHBhY2thZ2VKc29uOiBhbnk7XG5cbiAgcmVhZG9ubHkgbmFtZTogc3RyaW5nO1xuICByZWFkb25seSB2ZXJzaW9uOiBzdHJpbmc7XG4gIHJlYWRvbmx5IGF1dGhvcjogc3BlYy5QZXJzb247XG4gIHJlYWRvbmx5IGRlcHJlY2F0ZWQ/OiBzdHJpbmc7XG4gIHJlYWRvbmx5IHN0YWJpbGl0eT86IHNwZWMuU3RhYmlsaXR5O1xuICByZWFkb25seSBsaWNlbnNlOiBzdHJpbmc7XG4gIHJlYWRvbmx5IHJlcG9zaXRvcnk6IHtcbiAgICByZWFkb25seSB0eXBlOiBzdHJpbmc7XG4gICAgcmVhZG9ubHkgdXJsOiBzdHJpbmc7XG4gICAgcmVhZG9ubHkgZGlyZWN0b3J5Pzogc3RyaW5nO1xuICB9O1xuICByZWFkb25seSBrZXl3b3Jkcz86IHN0cmluZ1tdO1xuXG4gIHJlYWRvbmx5IG1haW46IHN0cmluZztcbiAgcmVhZG9ubHkgdHlwZXM6IHN0cmluZztcblxuICByZWFkb25seSBkZXBlbmRlbmNpZXM6IHsgcmVhZG9ubHkgW25hbWU6IHN0cmluZ106IHN0cmluZyB9O1xuICByZWFkb25seSBwZWVyRGVwZW5kZW5jaWVzOiB7IHJlYWRvbmx5IFtuYW1lOiBzdHJpbmddOiBzdHJpbmcgfTtcbiAgcmVhZG9ubHkgZGVwZW5kZW5jeUNsb3N1cmU6IHJlYWRvbmx5IHNwZWMuQXNzZW1ibHlbXTtcbiAgcmVhZG9ubHkgYnVuZGxlRGVwZW5kZW5jaWVzPzogeyByZWFkb25seSBbbmFtZTogc3RyaW5nXTogc3RyaW5nIH07XG4gIHJlYWRvbmx5IHRhcmdldHM6IHNwZWMuQXNzZW1ibHlUYXJnZXRzO1xuICByZWFkb25seSBtZXRhZGF0YT86IHsgW2tleTogc3RyaW5nXTogYW55IH07XG4gIHJlYWRvbmx5IGpzaWlWZXJzaW9uRm9ybWF0OiAnc2hvcnQnIHwgJ2Z1bGwnO1xuICByZWFkb25seSBkaWFnbm9zdGljcz86IHsgcmVhZG9ubHkgW2NvZGU6IHN0cmluZ106IHRzLkRpYWdub3N0aWNDYXRlZ29yeSB9O1xuICByZWFkb25seSBkZXNjcmlwdGlvbj86IHN0cmluZztcbiAgcmVhZG9ubHkgaG9tZXBhZ2U/OiBzdHJpbmc7XG4gIHJlYWRvbmx5IGNvbnRyaWJ1dG9ycz86IHJlYWRvbmx5IHNwZWMuUGVyc29uW107XG4gIHJlYWRvbmx5IGV4Y2x1ZGVUeXBlc2NyaXB0OiBzdHJpbmdbXTtcbiAgcmVhZG9ubHkgcHJvamVjdFJlZmVyZW5jZXM/OiBib29sZWFuO1xuICByZWFkb25seSB0c2M/OiBUU0NvbXBpbGVyT3B0aW9ucztcbiAgcmVhZG9ubHkgYmluPzogeyByZWFkb25seSBbbmFtZTogc3RyaW5nXTogc3RyaW5nIH07XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgUHJvamVjdEluZm9SZXN1bHQge1xuICByZWFkb25seSBwcm9qZWN0SW5mbzogUHJvamVjdEluZm87XG4gIHJlYWRvbmx5IGRpYWdub3N0aWNzOiByZWFkb25seSB0cy5EaWFnbm9zdGljW107XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBsb2FkUHJvamVjdEluZm8oXG4gIHByb2plY3RSb290OiBzdHJpbmcsXG4pOiBQcm9taXNlPFByb2plY3RJbmZvUmVzdWx0PiB7XG4gIGNvbnN0IHBhY2thZ2VKc29uUGF0aCA9IHBhdGguam9pbihwcm9qZWN0Um9vdCwgJ3BhY2thZ2UuanNvbicpO1xuICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLXZhci1yZXF1aXJlcyxAdHlwZXNjcmlwdC1lc2xpbnQvbm8tcmVxdWlyZS1pbXBvcnRzXG4gIGNvbnN0IHBrZyA9IHJlcXVpcmUocGFja2FnZUpzb25QYXRoKTtcblxuICBjb25zdCBkaWFnbm9zdGljczogdHMuRGlhZ25vc3RpY1tdID0gW107XG5cbiAgbGV0IGJ1bmRsZURlcGVuZGVuY2llczogeyBbbmFtZTogc3RyaW5nXTogc3RyaW5nIH0gfCB1bmRlZmluZWQ7XG4gIGZvciAoY29uc3QgbmFtZSBvZiBwa2cuYnVuZGxlRGVwZW5kZW5jaWVzID8/IHBrZy5idW5kbGVkRGVwZW5kZW5jaWVzID8/IFtdKSB7XG4gICAgY29uc3QgdmVyc2lvbiA9IHBrZy5kZXBlbmRlbmNpZXM/LltuYW1lXTtcbiAgICBpZiAoIXZlcnNpb24pIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYFRoZSBcInBhY2thZ2UuanNvblwiIGZpbGUgaGFzIFwiJHtuYW1lfVwiIGluIFwiYnVuZGxlRGVwZW5kZW5jaWVzXCIsIGJ1dCBpdCBpcyBub3QgZGVjbGFyZWQgaW4gXCJkZXBlbmRlbmNpZXNcImAsXG4gICAgICApO1xuICAgIH1cblxuICAgIGlmIChwa2cucGVlckRlcGVuZGVuY2llcyAmJiBuYW1lIGluIHBrZy5wZWVyRGVwZW5kZW5jaWVzKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBUaGUgXCJwYWNrYWdlLmpzb25cIiBmaWxlIGhhcyBcIiR7bmFtZX1cIiBpbiBcImJ1bmRsZURlcGVuZGVuY2llc1wiLCBhbmQgYWxzbyBpbiBcInBlZXJEZXBlbmRlbmNpZXNcImAsXG4gICAgICApO1xuICAgIH1cblxuICAgIGJ1bmRsZURlcGVuZGVuY2llcyA9IGJ1bmRsZURlcGVuZGVuY2llcyA/PyB7fTtcbiAgICBidW5kbGVEZXBlbmRlbmNpZXNbbmFtZV0gPSBfcmVzb2x2ZVZlcnNpb24odmVyc2lvbiwgcHJvamVjdFJvb3QpLnZlcnNpb247XG4gIH1cblxuICAvLyBDaGVjayBwZWVyRGVwZW5kZW5jaWVzIGFyZSBhbHNvIGluIGRldkRlcGVuZGVuY2llc1xuICAvLyBZb3UgbmVlZCB0aGlzIHRvIHdyaXRlIHRlc3RzIHByb3Blcmx5LiBUaGVyZSBhcmUgcHJvYmFibHkgY2FzZXMgd2hlcmVcbiAgLy8gaXQgbWFrZXMgc2Vuc2UgdG8gaGF2ZSB0aGlzIGRpZmZlcmVudCwgc28gbW9zdCBvZiB3aGF0IHRoaXMgY2hlY2tpbmdcbiAgLy8gcHJvZHVjZXMgaXMgd2FybmluZ3MsIG5vdCBlcnJvcnMuXG4gIGNvbnN0IGRldkRlcGVuZGVuY2llcyA9IHBrZy5kZXZEZXBlbmRlbmNpZXMgPz8ge307XG4gIGZvciAoY29uc3QgW25hbWUsIHJuZ10gb2YgT2JqZWN0LmVudHJpZXMocGtnLnBlZXJEZXBlbmRlbmNpZXMgPz8ge30pKSB7XG4gICAgY29uc3QgcmFuZ2UgPSBuZXcgc2VtdmVyLlJhbmdlKFxuICAgICAgX3Jlc29sdmVWZXJzaW9uKHJuZyBhcyBzdHJpbmcsIHByb2plY3RSb290KS52ZXJzaW9uLFxuICAgICk7XG4gICAgY29uc3QgbWluVmVyc2lvbiA9IHNlbXZlci5taW5WZXJzaW9uKHJhbmdlKT8ucmF3O1xuXG4gICAgaWYgKFxuICAgICAgIShuYW1lIGluIGRldkRlcGVuZGVuY2llcykgfHxcbiAgICAgIGRldkRlcGVuZGVuY2llc1tuYW1lXSAhPT0gYCR7bWluVmVyc2lvbn1gXG4gICAgKSB7XG4gICAgICBkaWFnbm9zdGljcy5wdXNoKFxuICAgICAgICBKc2lpRGlhZ25vc3RpYy5KU0lJXzAwMDZfTUlTU0lOR19ERVZfREVQRU5ERU5DWS5jcmVhdGVEZXRhY2hlZChcbiAgICAgICAgICBuYW1lLFxuICAgICAgICAgIGAke3JuZyBhcyBhbnl9YCxcbiAgICAgICAgICBgJHttaW5WZXJzaW9ufWAsXG4gICAgICAgICAgYCR7ZGV2RGVwZW5kZW5jaWVzW25hbWVdfWAsXG4gICAgICAgICksXG4gICAgICApO1xuICAgICAgY29udGludWU7XG4gICAgfVxuICB9XG5cbiAgY29uc3QgdHJhbnNpdGl2ZUFzc2VtYmxpZXM6IHsgW25hbWU6IHN0cmluZ106IHNwZWMuQXNzZW1ibHkgfSA9IHt9O1xuICBjb25zdCBhc3NlbWJseUNhY2hlID0gbmV3IE1hcDxzdHJpbmcsIHNwZWMuQXNzZW1ibHk+KCk7XG4gIGNvbnN0IGRlcGVuZGVuY2llcyA9IGF3YWl0IF9sb2FkRGVwZW5kZW5jaWVzKFxuICAgIHBrZy5kZXBlbmRlbmNpZXMsXG4gICAgcHJvamVjdFJvb3QsXG4gICAgdHJhbnNpdGl2ZUFzc2VtYmxpZXMsXG4gICAgYXNzZW1ibHlDYWNoZSxcbiAgICBuZXcgU2V0PHN0cmluZz4oT2JqZWN0LmtleXMoYnVuZGxlRGVwZW5kZW5jaWVzID8/IHt9KSksXG4gICk7XG4gIGNvbnN0IHBlZXJEZXBlbmRlbmNpZXMgPSBhd2FpdCBfbG9hZERlcGVuZGVuY2llcyhcbiAgICBwa2cucGVlckRlcGVuZGVuY2llcyxcbiAgICBwcm9qZWN0Um9vdCxcbiAgICB0cmFuc2l0aXZlQXNzZW1ibGllcyxcbiAgICBhc3NlbWJseUNhY2hlLFxuICApO1xuXG4gIGNvbnN0IHRyYW5zaXRpdmVEZXBlbmRlbmNpZXMgPSBPYmplY3QudmFsdWVzKHRyYW5zaXRpdmVBc3NlbWJsaWVzKTtcblxuICBjb25zdCBtZXRhZGF0YSA9IG1lcmdlTWV0YWRhdGEoXG4gICAge1xuICAgICAganNpaToge1xuICAgICAgICBwYWNtYWs6IHtcbiAgICAgICAgICAvLyBXaGVuIGB0cnVlYCwgYGpzaWktcGFjbWFrYCB3aWxsIHVzZSB0aGUgYEpzaWkkRGVmYXVsdGAgaW1wbGVtZW50YXRpb24gaW4gY29kZSBnZW5lcmF0aW9uIGV2ZW4gZm9yIGRlcGVuZGVuY2llcy5cbiAgICAgICAgICBoYXNEZWZhdWx0SW50ZXJmYWNlczogdHJ1ZSxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgfSxcbiAgICBwa2cuanNpaT8ubWV0YWRhdGEsXG4gICk7XG5cbiAgY29uc3QgcHJvamVjdEluZm8gPSB7XG4gICAgcHJvamVjdFJvb3QsXG4gICAgcGFja2FnZUpzb246IHBrZyxcblxuICAgIG5hbWU6IF9yZXF1aXJlZChcbiAgICAgIHBrZy5uYW1lLFxuICAgICAgJ1RoZSBcInBhY2thZ2UuanNvblwiIGZpbGUgbXVzdCBzcGVjaWZ5IHRoZSBcIm5hbWVcIiBhdHRyaWJ1dGUnLFxuICAgICksXG4gICAgdmVyc2lvbjogX3JlcXVpcmVkKFxuICAgICAgcGtnLnZlcnNpb24sXG4gICAgICAnVGhlIFwicGFja2FnZS5qc29uXCIgZmlsZSBtdXN0IHNwZWNpZnkgdGhlIFwidmVyc2lvblwiIGF0dHJpYnV0ZScsXG4gICAgKSxcbiAgICBkZXByZWNhdGVkOiBwa2cuZGVwcmVjYXRlZCxcbiAgICBzdGFiaWxpdHk6IF92YWxpZGF0ZVN0YWJpbGl0eShwa2cuc3RhYmlsaXR5LCBwa2cuZGVwcmVjYXRlZCksXG4gICAgYXV0aG9yOiBfdG9QZXJzb24oXG4gICAgICBfcmVxdWlyZWQoXG4gICAgICAgIHBrZy5hdXRob3IsXG4gICAgICAgICdUaGUgXCJwYWNrYWdlLmpzb25cIiBmaWxlIG11c3Qgc3BlY2lmeSB0aGUgXCJhdXRob3JcIiBhdHRyaWJ1dGUnLFxuICAgICAgKSxcbiAgICAgICdhdXRob3InLFxuICAgICksXG4gICAgcmVwb3NpdG9yeTogX3RvUmVwb3NpdG9yeShcbiAgICAgIF9yZXF1aXJlZChcbiAgICAgICAgcGtnLnJlcG9zaXRvcnksXG4gICAgICAgICdUaGUgXCJwYWNrYWdlLmpzb25cIiBmaWxlIG11c3Qgc3BlY2lmeSB0aGUgXCJyZXBvc2l0b3J5XCIgYXR0cmlidXRlJyxcbiAgICAgICksXG4gICAgKSxcbiAgICBsaWNlbnNlOiBfdmFsaWRhdGVMaWNlbnNlKHBrZy5saWNlbnNlKSxcbiAgICBrZXl3b3JkczogcGtnLmtleXdvcmRzLFxuXG4gICAgbWFpbjogX3JlcXVpcmVkKFxuICAgICAgcGtnLm1haW4sXG4gICAgICAnVGhlIFwicGFja2FnZS5qc29uXCIgZmlsZSBtdXN0IHNwZWNpZnkgdGhlIFwibWFpblwiIGF0dHJpYnV0ZScsXG4gICAgKSxcbiAgICB0eXBlczogX3JlcXVpcmVkKFxuICAgICAgcGtnLnR5cGVzLFxuICAgICAgJ1RoZSBcInBhY2thZ2UuanNvblwiIGZpbGUgbXVzdCBzcGVjaWZ5IHRoZSBcInR5cGVzXCIgYXR0cmlidXRlJyxcbiAgICApLFxuXG4gICAgZGVwZW5kZW5jaWVzLFxuICAgIHBlZXJEZXBlbmRlbmNpZXMsXG4gICAgZGVwZW5kZW5jeUNsb3N1cmU6IHRyYW5zaXRpdmVEZXBlbmRlbmNpZXMsXG4gICAgYnVuZGxlRGVwZW5kZW5jaWVzLFxuICAgIHRhcmdldHM6IHtcbiAgICAgIC4uLl9yZXF1aXJlZChcbiAgICAgICAgcGtnLmpzaWksXG4gICAgICAgICdUaGUgXCJwYWNrYWdlLmpzb25cIiBmaWxlIG11c3Qgc3BlY2lmeSB0aGUgXCJqc2lpXCIgYXR0cmlidXRlJyxcbiAgICAgICkudGFyZ2V0cyxcbiAgICAgIGpzOiB7IG5wbTogcGtnLm5hbWUgfSxcbiAgICB9LFxuICAgIG1ldGFkYXRhLFxuICAgIGpzaWlWZXJzaW9uRm9ybWF0OiBfdmFsaWRhdGVWZXJzaW9uRm9ybWF0KHBrZy5qc2lpLnZlcnNpb25Gb3JtYXQgPz8gJ2Z1bGwnKSxcblxuICAgIGRlc2NyaXB0aW9uOiBwa2cuZGVzY3JpcHRpb24sXG4gICAgaG9tZXBhZ2U6IHBrZy5ob21lcGFnZSxcbiAgICBjb250cmlidXRvcnM6IChwa2cuY29udHJpYnV0b3JzIGFzIGFueVtdKT8ubWFwKChjb250cmliLCBpbmRleCkgPT5cbiAgICAgIF90b1BlcnNvbihjb250cmliLCBgY29udHJpYnV0b3JzWyR7aW5kZXh9XWAsICdjb250cmlidXRvcicpLFxuICAgICksXG5cbiAgICBleGNsdWRlVHlwZXNjcmlwdDogcGtnLmpzaWk/LmV4Y2x1ZGVUeXBlc2NyaXB0ID8/IFtdLFxuICAgIHByb2plY3RSZWZlcmVuY2VzOiBwa2cuanNpaT8ucHJvamVjdFJlZmVyZW5jZXMsXG4gICAgdHNjOiB7XG4gICAgICBvdXREaXI6IHBrZy5qc2lpPy50c2M/Lm91dERpcixcbiAgICAgIHJvb3REaXI6IHBrZy5qc2lpPy50c2M/LnJvb3REaXIsXG4gICAgfSxcbiAgICBiaW46IHBrZy5iaW4sXG4gICAgZGlhZ25vc3RpY3M6IF9sb2FkRGlhZ25vc3RpY3MocGtnLmpzaWk/LmRpYWdub3N0aWNzKSxcbiAgfTtcbiAgcmV0dXJuIHsgcHJvamVjdEluZm8sIGRpYWdub3N0aWNzIH07XG59XG5cbmZ1bmN0aW9uIF9ndWVzc1JlcG9zaXRvcnlUeXBlKHVybDogc3RyaW5nKTogc3RyaW5nIHtcbiAgaWYgKHVybC5lbmRzV2l0aCgnLmdpdCcpKSB7XG4gICAgcmV0dXJuICdnaXQnO1xuICB9XG4gIGNvbnN0IHBhcnRzID0gL14oW146XSspOlxcL1xcLy8uZXhlYyh1cmwpO1xuICBpZiAocGFydHM/LlsxXSAhPT0gJ2h0dHAnICYmIHBhcnRzPy5bMV0gIT09ICdodHRwcycpIHtcbiAgICByZXR1cm4gcGFydHMhWzFdO1xuICB9XG4gIHRocm93IG5ldyBFcnJvcihcbiAgICBgVGhlIFwicGFja2FnZS5qc29uXCIgZmlsZSBtdXN0IHNwZWNpZnkgdGhlIFwicmVwb3NpdG9yeS50eXBlXCIgYXR0cmlidXRlIChjb3VsZCBub3QgZ3Vlc3MgZnJvbSAke3VybH0pYCxcbiAgKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gX2xvYWREZXBlbmRlbmNpZXMoXG4gIGRlcGVuZGVuY2llczogeyBbbmFtZTogc3RyaW5nXTogc3RyaW5nIH0gfCB1bmRlZmluZWQsXG4gIHNlYXJjaFBhdGg6IHN0cmluZyxcbiAgdHJhbnNpdGl2ZUFzc2VtYmxpZXM6IHsgW25hbWU6IHN0cmluZ106IHNwZWMuQXNzZW1ibHkgfSxcbiAgYXNzZW1ibHlDYWNoZTogTWFwPHN0cmluZywgc3BlYy5Bc3NlbWJseT4sXG4gIGJ1bmRsZWQgPSBuZXcgU2V0PHN0cmluZz4oKSxcbik6IFByb21pc2U8eyBbbmFtZTogc3RyaW5nXTogc3RyaW5nIH0+IHtcbiAgaWYgKCFkZXBlbmRlbmNpZXMpIHtcbiAgICByZXR1cm4ge307XG4gIH1cbiAgY29uc3QgcGFja2FnZVZlcnNpb25zOiB7IFtuYW1lOiBzdHJpbmddOiBzdHJpbmcgfSA9IHt9O1xuICBmb3IgKGNvbnN0IG5hbWUgb2YgT2JqZWN0LmtleXMoZGVwZW5kZW5jaWVzKSkge1xuICAgIGlmIChidW5kbGVkLmhhcyhuYW1lKSkge1xuICAgICAgY29udGludWU7XG4gICAgfVxuICAgIGNvbnN0IHsgdmVyc2lvbjogdmVyc2lvblN0cmluZywgbG9jYWxQYWNrYWdlIH0gPSBfcmVzb2x2ZVZlcnNpb24oXG4gICAgICBkZXBlbmRlbmNpZXNbbmFtZV0sXG4gICAgICBzZWFyY2hQYXRoLFxuICAgICk7XG4gICAgY29uc3QgdmVyc2lvbiA9IG5ldyBzZW12ZXIuUmFuZ2UodmVyc2lvblN0cmluZyk7XG4gICAgaWYgKCF2ZXJzaW9uKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBJbnZhbGlkIHNlbXZlciBleHByZXNzaW9uIGZvciAke25hbWV9OiAke3ZlcnNpb25TdHJpbmd9YCxcbiAgICAgICk7XG4gICAgfVxuICAgIGNvbnN0IHBrZyA9IF90cnlSZXNvbHZlQXNzZW1ibHkobmFtZSwgbG9jYWxQYWNrYWdlLCBzZWFyY2hQYXRoKTtcbiAgICBMT0cuZGVidWcoYFJlc29sdmVkIGRlcGVuZGVuY3kgJHtuYW1lfSB0byAke3BrZ31gKTtcbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tYXdhaXQtaW4tbG9vcFxuICAgIGNvbnN0IGFzc20gPSBhd2FpdCBsb2FkQW5kVmFsaWRhdGVBc3NlbWJseShwa2csIGFzc2VtYmx5Q2FjaGUpO1xuICAgIGlmICghc2VtdmVyLnNhdGlzZmllcyhhc3NtLnZlcnNpb24sIHZlcnNpb24pKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBEZWNsYXJlZCBkZXBlbmRlbmN5IG9uIHZlcnNpb24gJHt2ZXJzaW9uU3RyaW5nfSBvZiAke25hbWV9LCBidXQgdmVyc2lvbiAke2Fzc20udmVyc2lvbn0gd2FzIGZvdW5kYCxcbiAgICAgICk7XG4gICAgfVxuICAgIHBhY2thZ2VWZXJzaW9uc1thc3NtLm5hbWVdID1cbiAgICAgIHBhY2thZ2VWZXJzaW9uc1thc3NtLm5hbWVdICE9IG51bGxcbiAgICAgICAgPyBpbnRlcnNlY3QodmVyc2lvblN0cmluZywgcGFja2FnZVZlcnNpb25zW2Fzc20ubmFtZV0pXG4gICAgICAgIDogdmVyc2lvblN0cmluZztcbiAgICB0cmFuc2l0aXZlQXNzZW1ibGllc1thc3NtLm5hbWVdID0gYXNzbTtcbiAgICBjb25zdCBwa2dEaXIgPSBwYXRoLmRpcm5hbWUocGtnKTtcbiAgICBpZiAoYXNzbS5kZXBlbmRlbmNpZXMpIHtcbiAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1hd2FpdC1pbi1sb29wXG4gICAgICBhd2FpdCBfbG9hZERlcGVuZGVuY2llcyhcbiAgICAgICAgYXNzbS5kZXBlbmRlbmNpZXMsXG4gICAgICAgIHBrZ0RpcixcbiAgICAgICAgdHJhbnNpdGl2ZUFzc2VtYmxpZXMsXG4gICAgICAgIGFzc2VtYmx5Q2FjaGUsXG4gICAgICApO1xuICAgIH1cbiAgfVxuICByZXR1cm4gcGFja2FnZVZlcnNpb25zO1xufVxuXG4vKipcbiAqIExvYWQgYSBKU0lJIGZpbGVuYW1lIGFuZCB2YWxpZGF0ZSBpdDsgY2FjaGVkIHRvIGF2b2lkIHJlZHVuZGFudCBsb2FkcyBvZiB0aGUgc2FtZSBKU0lJIGFzc2VtYmx5XG4gKi9cbmFzeW5jIGZ1bmN0aW9uIGxvYWRBbmRWYWxpZGF0ZUFzc2VtYmx5KFxuICBqc2lpRmlsZU5hbWU6IHN0cmluZyxcbiAgY2FjaGU6IE1hcDxzdHJpbmcsIHNwZWMuQXNzZW1ibHk+LFxuKTogUHJvbWlzZTxzcGVjLkFzc2VtYmx5PiB7XG4gIGlmICghY2FjaGUuaGFzKGpzaWlGaWxlTmFtZSkpIHtcbiAgICB0cnkge1xuICAgICAgY2FjaGUuc2V0KGpzaWlGaWxlTmFtZSwgYXdhaXQgZnMucmVhZEpzb24oanNpaUZpbGVOYW1lKSk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBFcnJvciBsb2FkaW5nICR7anNpaUZpbGVOYW1lfTogJHtlfWApO1xuICAgIH1cbiAgfVxuICByZXR1cm4gY2FjaGUuZ2V0KGpzaWlGaWxlTmFtZSkhO1xufVxuXG5mdW5jdGlvbiBfcmVxdWlyZWQ8VD4odmFsdWU6IFQsIG1lc3NhZ2U6IHN0cmluZyk6IFQge1xuICBpZiAodmFsdWUgPT0gbnVsbCkge1xuICAgIHRocm93IG5ldyBFcnJvcihtZXNzYWdlKTtcbiAgfVxuICByZXR1cm4gdmFsdWU7XG59XG5cbmZ1bmN0aW9uIF90b1BlcnNvbihcbiAgdmFsdWU6IGFueSxcbiAgZmllbGQ6IHN0cmluZyxcbiAgZGVmYXVsdFJvbGU6IHN0cmluZyA9IGZpZWxkLFxuKTogc3BlYy5QZXJzb24ge1xuICBpZiAodHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJykge1xuICAgIHZhbHVlID0gcGFyc2VQZXJzb24odmFsdWUpO1xuICB9XG4gIHJldHVybiB7XG4gICAgbmFtZTogX3JlcXVpcmVkKFxuICAgICAgdmFsdWUubmFtZSxcbiAgICAgIGBUaGUgXCJwYWNrYWdlLmpzb25cIiBmaWxlIG11c3Qgc3BlY2lmeSB0aGUgXCIke2ZpZWxkfS5uYW1lXCIgYXR0cmlidXRlYCxcbiAgICApLFxuICAgIHJvbGVzOiB2YWx1ZS5yb2xlcyA/IFsuLi5uZXcgU2V0KHZhbHVlLnJvbGVzIGFzIHN0cmluZ1tdKV0gOiBbZGVmYXVsdFJvbGVdLFxuICAgIGVtYWlsOiB2YWx1ZS5lbWFpbCxcbiAgICB1cmw6IHZhbHVlLnVybCxcbiAgICBvcmdhbml6YXRpb246IHZhbHVlLm9yZ2FuaXphdGlvbiA/IHZhbHVlLm9yZ2FuaXphdGlvbiA6IHVuZGVmaW5lZCxcbiAgfTtcbn1cblxuZnVuY3Rpb24gX3RvUmVwb3NpdG9yeSh2YWx1ZTogYW55KToge1xuICB0eXBlOiBzdHJpbmc7XG4gIHVybDogc3RyaW5nO1xuICBkaXJlY3Rvcnk/OiBzdHJpbmc7XG59IHtcbiAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycpIHtcbiAgICB2YWx1ZSA9IHBhcnNlUmVwb3NpdG9yeSh2YWx1ZSk7XG4gIH1cbiAgcmV0dXJuIHtcbiAgICB1cmw6IF9yZXF1aXJlZChcbiAgICAgIHZhbHVlLnVybCxcbiAgICAgICdUaGUgXCJwYWNrYWdlLmpzb25cIiBmaWxlIG11c3Qgc3BlY2lmeSB0aGUgXCJyZXBvc2l0b3J5LnVybFwiIGF0dHJpYnV0ZScsXG4gICAgKSxcbiAgICB0eXBlOiB2YWx1ZS50eXBlIHx8IF9ndWVzc1JlcG9zaXRvcnlUeXBlKHZhbHVlLnVybCksXG4gICAgZGlyZWN0b3J5OiB2YWx1ZS5kaXJlY3RvcnksXG4gIH07XG59XG5cbmZ1bmN0aW9uIF90cnlSZXNvbHZlQXNzZW1ibHkoXG4gIG1vZDogc3RyaW5nLFxuICBsb2NhbFBhY2thZ2U6IHN0cmluZyB8IHVuZGVmaW5lZCxcbiAgc2VhcmNoUGF0aDogc3RyaW5nLFxuKTogc3RyaW5nIHtcbiAgaWYgKGxvY2FsUGFja2FnZSkge1xuICAgIGNvbnN0IHJlc3VsdCA9IHBhdGguam9pbihsb2NhbFBhY2thZ2UsICcuanNpaScpO1xuICAgIGlmICghZnMuZXhpc3RzU3luYyhyZXN1bHQpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYEFzc2VtYmx5IGRvZXMgbm90IGV4aXN0OiAke3Jlc3VsdH1gKTtcbiAgICB9XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxuICB0cnkge1xuICAgIGNvbnN0IHBhdGhzID0gW3NlYXJjaFBhdGgsIHBhdGguam9pbihzZWFyY2hQYXRoLCAnbm9kZV9tb2R1bGVzJyldO1xuICAgIHJldHVybiByZXF1aXJlLnJlc29sdmUocGF0aC5qb2luKG1vZCwgJy5qc2lpJyksIHsgcGF0aHMgfSk7XG4gIH0gY2F0Y2gge1xuICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgIGBVbmFibGUgdG8gbG9jYXRlIGpzaWkgYXNzZW1ibHkgZm9yIFwiJHttb2R9XCIuIElmIHRoaXMgbW9kdWxlIGlzIG5vdCBqc2lpLWVuYWJsZWQsIGl0IG11c3QgYWxzbyBiZSBkZWNsYXJlZCB1bmRlciBidW5kbGVkRGVwZW5kZW5jaWVzLmAsXG4gICAgKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBfdmFsaWRhdGVMaWNlbnNlKGlkOiBzdHJpbmcpOiBzdHJpbmcge1xuICBpZiAoaWQgPT09ICdVTkxJQ0VOU0VEJykge1xuICAgIHJldHVybiBpZDtcbiAgfVxuICBpZiAoIXNwZHguaGFzKGlkKSkge1xuICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgIGBJbnZhbGlkIGxpY2Vuc2UgaWRlbnRpZmllciBcIiR7aWR9XCIsIHNlZSB2YWxpZCBsaWNlbnNlIGlkZW50aWZpZXJzIGF0IGh0dHBzOi8vc3BkeC5vcmcvbGljZW5zZXMvYCxcbiAgICApO1xuICB9XG4gIHJldHVybiBpZDtcbn1cblxuZnVuY3Rpb24gX3ZhbGlkYXRlVmVyc2lvbkZvcm1hdChmb3JtYXQ6IHN0cmluZyk6ICdzaG9ydCcgfCAnZnVsbCcge1xuICBpZiAoZm9ybWF0ICE9PSAnc2hvcnQnICYmIGZvcm1hdCAhPT0gJ2Z1bGwnKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgYEludmFsaWQganNpaS52ZXJzaW9uRm9ybWF0IFwiJHtmb3JtYXR9XCIsIGl0IG11c3QgYmUgZWl0aGVyIFwic2hvcnRcIiBvciBcImZ1bGxcIiAodGhlIGRlZmF1bHQpYCxcbiAgICApO1xuICB9XG4gIHJldHVybiBmb3JtYXQ7XG59XG5cbmZ1bmN0aW9uIF92YWxpZGF0ZVN0YWJpbGl0eShcbiAgc3RhYmlsaXR5OiBzdHJpbmcgfCB1bmRlZmluZWQsXG4gIGRlcHJlY2F0ZWQ6IHN0cmluZyB8IHVuZGVmaW5lZCxcbik6IHNwZWMuU3RhYmlsaXR5IHwgdW5kZWZpbmVkIHtcbiAgaWYgKCFzdGFiaWxpdHkgJiYgZGVwcmVjYXRlZCkge1xuICAgIHN0YWJpbGl0eSA9IHNwZWMuU3RhYmlsaXR5LkRlcHJlY2F0ZWQ7XG4gIH0gZWxzZSBpZiAoZGVwcmVjYXRlZCAmJiBzdGFiaWxpdHkgIT09IHNwZWMuU3RhYmlsaXR5LkRlcHJlY2F0ZWQpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICBgUGFja2FnZSBpcyBkZXByZWNhdGVkICgke2RlcHJlY2F0ZWR9KSwgYnV0IGl0J3Mgc3RhYmlsaXR5IGlzICR7c3RhYmlsaXR5fSBhbmQgbm90ICR7c3BlYy5TdGFiaWxpdHkuRGVwcmVjYXRlZH1gLFxuICAgICk7XG4gIH1cbiAgaWYgKCFzdGFiaWxpdHkpIHtcbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9XG4gIGlmICghT2JqZWN0LnZhbHVlcyhzcGVjLlN0YWJpbGl0eSkuaW5jbHVkZXMoc3RhYmlsaXR5IGFzIGFueSkpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICBgSW52YWxpZCBzdGFiaWxpdHkgXCIke3N0YWJpbGl0eX1cIiwgaXQgbXVzdCBiZSBvbmUgb2YgJHtPYmplY3QudmFsdWVzKFxuICAgICAgICBzcGVjLlN0YWJpbGl0eSxcbiAgICAgICkuam9pbignLCAnKX1gLFxuICAgICk7XG4gIH1cbiAgcmV0dXJuIHN0YWJpbGl0eSBhcyBzcGVjLlN0YWJpbGl0eTtcbn1cblxuLyoqXG4gKiBSZXNvbHZlcyBhbiBOUE0gcGFja2FnZSBzcGVjaWZpZXIgdG8gYSB2ZXJzaW9uIHJhbmdlXG4gKlxuICogSWYgaXQgd2FzIGFscmVhZHkgYSB2ZXJzaW9uIHJhbmdlLCByZXR1cm4gaXQuIElmIGl0IHRoZVxuICogcGFja2FnZSByZWZlcmVuY2VzIGEgbG9jYWwgZmlsZSwgcmV0dXJuIHRoZSB2ZXJzaW9uIHRoYXRcbiAqIHBhY2thZ2UgaXMgYXQuXG4gKi9cbmZ1bmN0aW9uIF9yZXNvbHZlVmVyc2lvbihcbiAgZGVwOiBzdHJpbmcsXG4gIHNlYXJjaFBhdGg6IHN0cmluZyxcbik6IHsgdmVyc2lvbjogc3RyaW5nOyBsb2NhbFBhY2thZ2U/OiBzdHJpbmcgfSB7XG4gIGNvbnN0IG1hdGNoZXMgPSAvXmZpbGU6KC4rKSQvLmV4ZWMoZGVwKTtcbiAgaWYgKCFtYXRjaGVzKSB7XG4gICAgcmV0dXJuIHsgdmVyc2lvbjogZGVwIH07XG4gIH1cbiAgY29uc3QgbG9jYWxQYWNrYWdlID0gcGF0aC5yZXNvbHZlKHNlYXJjaFBhdGgsIG1hdGNoZXNbMV0pO1xuICByZXR1cm4ge1xuICAgIC8vIFJlbmRlcmluZyBhcyBhIGNhcmV0IHZlcnNpb24gdG8gbWFpbnRhaW4gdW5pZm9ybWl0eSBhZ2FpbnN0IHRoZSBcInN0YW5kYXJkXCIuXG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1yZXF1aXJlLWltcG9ydHMsQHR5cGVzY3JpcHQtZXNsaW50L25vLXZhci1yZXF1aXJlc1xuICAgIHZlcnNpb246IGBeJHtyZXF1aXJlKHBhdGguam9pbihsb2NhbFBhY2thZ2UsICdwYWNrYWdlLmpzb24nKSkudmVyc2lvbn1gLFxuICAgIGxvY2FsUGFja2FnZSxcbiAgfTtcbn1cblxuLyoqXG4gKiBNZXJnZXMgdHdvIG1ldGFkYXRhIGJsb2NrcyB0b2dldGhlci5cbiAqXG4gKiBAcGFyYW0gYmFzZSB0aGUgYmFzZSB2YWx1ZXNcbiAqIEBwYXJhbSB1c2VyIHRoZSB1c2VyLXN1cHBsaWVkIHZhbHVlcywgd2hpY2ggY2FuIG92ZXJyaWRlIHRoZSBgYmFzZWAgdmFsdWVzXG4gKlxuICogQHJldHVybnMgdGhlIG1lcmdlZCBtZXRhZGF0YSBibG9ja1xuICovXG5mdW5jdGlvbiBtZXJnZU1ldGFkYXRhKFxuICBiYXNlOiBOb25OdWxsYWJsZTxQcm9qZWN0SW5mb1snbWV0YWRhdGEnXT4sXG4gIHVzZXI6IFByb2plY3RJbmZvWydtZXRhZGF0YSddLFxuKTogUHJvamVjdEluZm9bJ21ldGFkYXRhJ10ge1xuICBpZiAodXNlciA9PSBudWxsKSB7XG4gICAgcmV0dXJuIGJhc2U7XG4gIH1cbiAgcmV0dXJuIG1lcmdlT2JqZWN0cyhiYXNlLCB1c2VyKTtcblxuICBmdW5jdGlvbiBtZXJnZU9iamVjdHMoXG4gICAgYmFzZTogUmVjb3JkPHN0cmluZywgYW55PixcbiAgICBvdmVycmlkZTogUmVjb3JkPHN0cmluZywgYW55PixcbiAgKTogUmVjb3JkPHN0cmluZywgYW55PiB7XG4gICAgY29uc3QgcmVzdWx0OiBSZWNvcmQ8c3RyaW5nLCBhbnk+ID0ge307XG4gICAgY29uc3QgYWxsS2V5cyA9IEFycmF5LmZyb20oXG4gICAgICBuZXcgU2V0KFsuLi5PYmplY3Qua2V5cyhiYXNlKSwgLi4uT2JqZWN0LmtleXMob3ZlcnJpZGUpXSksXG4gICAgKS5zb3J0KCk7XG4gICAgZm9yIChjb25zdCBrZXkgb2YgYWxsS2V5cykge1xuICAgICAgY29uc3QgYmFzZVZhbHVlID0gYmFzZVtrZXldO1xuICAgICAgY29uc3Qgb3ZlcnJpZGVWYWx1ZSA9IG92ZXJyaWRlW2tleV07XG5cbiAgICAgIGlmICh0eXBlb2YgYmFzZVZhbHVlID09PSAnb2JqZWN0JyAmJiB0eXBlb2Ygb3ZlcnJpZGVWYWx1ZSA9PT0gJ29iamVjdCcpIHtcbiAgICAgICAgaWYgKG92ZXJyaWRlVmFsdWUgIT0gbnVsbCkge1xuICAgICAgICAgIHJlc3VsdFtrZXldID0gbWVyZ2VPYmplY3RzKGJhc2VWYWx1ZSwgb3ZlcnJpZGVWYWx1ZSk7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJlc3VsdFtrZXldID0gb3ZlcnJpZGVWYWx1ZSA/PyBiYXNlVmFsdWU7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cbn1cblxuZnVuY3Rpb24gX2xvYWREaWFnbm9zdGljcyhlbnRyaWVzPzogeyBba2V5OiBzdHJpbmddOiBzdHJpbmcgfSk6XG4gIHwge1xuICAgICAgW2tleTogc3RyaW5nXTogdHMuRGlhZ25vc3RpY0NhdGVnb3J5O1xuICAgIH1cbiAgfCB1bmRlZmluZWQge1xuICBpZiAoZW50cmllcyA9PT0gdW5kZWZpbmVkIHx8IE9iamVjdC5rZXlzKGVudHJpZXMpLmxlbmd0aCA9PT0gMCkge1xuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH1cbiAgY29uc3QgcmVzdWx0OiB7IFtrZXk6IHN0cmluZ106IHRzLkRpYWdub3N0aWNDYXRlZ29yeSB9ID0ge307XG4gIGZvciAoY29uc3QgY29kZSBvZiBPYmplY3Qua2V5cyhlbnRyaWVzKSkge1xuICAgIGxldCBjYXRlZ29yeTogdHMuRGlhZ25vc3RpY0NhdGVnb3J5O1xuICAgIHN3aXRjaCAoZW50cmllc1tjb2RlXS50cmltKCkudG9Mb3dlckNhc2UoKSkge1xuICAgICAgY2FzZSAnZXJyb3InOlxuICAgICAgICBjYXRlZ29yeSA9IHRzLkRpYWdub3N0aWNDYXRlZ29yeS5FcnJvcjtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICd3YXJuaW5nJzpcbiAgICAgICAgY2F0ZWdvcnkgPSB0cy5EaWFnbm9zdGljQ2F0ZWdvcnkuV2FybmluZztcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdzdWdnZXN0aW9uJzpcbiAgICAgICAgY2F0ZWdvcnkgPSB0cy5EaWFnbm9zdGljQ2F0ZWdvcnkuU3VnZ2VzdGlvbjtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdtZXNzYWdlJzpcbiAgICAgICAgY2F0ZWdvcnkgPSB0cy5EaWFnbm9zdGljQ2F0ZWdvcnkuTWVzc2FnZTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBkZWZhdWx0OlxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgYEludmFsaWQgY2F0ZWdvcnkgJyR7ZW50cmllc1tjb2RlXX0nIGZvciBjb2RlICcke2NvZGV9J2AsXG4gICAgICAgICk7XG4gICAgfVxuICAgIHJlc3VsdFtjb2RlXSA9IGNhdGVnb3J5O1xuICB9XG4gIHJldHVybiByZXN1bHQ7XG59XG4iXX0=