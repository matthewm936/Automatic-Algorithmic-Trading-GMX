"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.fileSystemLoader = exports.contentToLines = exports.loadFromFile = exports.includeAndRenderExamples = exports.typescriptSourceToMarkdown = void 0;
/**
 * A tiny module to include annotated (working!) code snippets into the documentation
 *
 * Not using 'literate-programming' or 'erasumus' projects because they work
 * the other way around: take code from MarkDown, save it as a file, then
 * execute that.
 *
 * We do the opposite: start from source code annotated with MarkDown and
 * extract it into (larger) MarkDown files.
 *
 * Including into README
 * ---------------------
 *
 * To include the examples directly into the README, make a link to the
 * annotated TypeScript file on a line by itself, and make sure the
 * extension of the file ends in `.lit.ts`.
 *
 * For example:
 *
 *    [example](test/integ.bucket.lit.ts)
 *
 * Annotating source
 * -----------------
 *
 * We use the triple-slash comment for our directives, since it's valid TypeScript
 * and are treated as regular comments if not the very first thing in the file.
 *
 * By default, the whole file is included, unless the source contains the statement
 * "/// !show". For example:
 *
 *     a
 *     /// !show
 *     b
 *     /// !hide
 *     c
 *
 * In this example, only 'b' would be included in the output. A single file may
 * switching including and excluding on and off multiple times in the same file.
 *
 * Other lines starting with triple slashes will be rendered as Markdown in between
 * the source lines. For example:
 *
 *     const x = 1;
 *     /// Now we're going to print x:
 *     console.log(x);
 *
 * Will be rendered as:
 *
 *     ```ts
 *     const x = 1;
 *     ```
 *
 *     Now we're going to print x:
 *
 *     ```ts
 *     console.log(x);
 *     ```
 */
const fs = require("fs-extra");
const path = require("path");
/**
 * Convert an annotated TypeScript source file to MarkDown
 */
function typescriptSourceToMarkdown(lines, codeBlockAnnotations) {
    const relevantLines = findRelevantLines(lines);
    const markdownLines = markdownify(relevantLines, codeBlockAnnotations);
    return markdownLines;
}
exports.typescriptSourceToMarkdown = typescriptSourceToMarkdown;
/**
 * Given MarkDown source, find source files to include and render
 *
 * We recognize links on a line by themselves if the link text starts
 * with the string "example" (case insensitive). For example:
 *
 *     [example](test/integ.bucket.ts)
 */
async function includeAndRenderExamples(lines, loader) {
    const ret = [];
    const regex = /^\[([^\]]*)\]\(([^)]+\.lit\.ts)\)/i;
    for (const line of lines) {
        const m = regex.exec(line);
        if (m) {
            // Found an include
            const filename = m[2];
            // eslint-disable-next-line no-await-in-loop
            const source = await loader(filename);
            // 'lit' source attribute will make snippet compiler know to extract the same source
            const imported = typescriptSourceToMarkdown(source, [`lit=${filename}`]);
            ret.push(...imported);
        }
        else {
            ret.push(line);
        }
    }
    return ret;
}
exports.includeAndRenderExamples = includeAndRenderExamples;
/**
 * Load a file into a string array
 */
async function loadFromFile(fileName) {
    const content = await fs.readFile(fileName, { encoding: 'utf-8' });
    return contentToLines(content);
}
exports.loadFromFile = loadFromFile;
/**
 * Turn file content string into an array of lines ready for processing using the other functions
 */
function contentToLines(content) {
    return content.split('\n').map((x) => x.trimRight());
}
exports.contentToLines = contentToLines;
/**
 * Return a file system loader given a base directory
 */
function fileSystemLoader(directory) {
    return (fileName) => loadFromFile(path.resolve(directory, fileName));
}
exports.fileSystemLoader = fileSystemLoader;
const RELEVANT_TAG = '/// !show';
const DETAIL_TAG = '/// !hide';
const INLINE_MD_REGEX = /^\s*\/\/\/ (.*)$/;
/**
 * Find the relevant lines of the input source
 *
 * Respects switching tags, returns everything if no switching found.
 *
 * Strips common indentation from the blocks it finds.
 */
function findRelevantLines(lines) {
    let inRelevant = false;
    let didFindRelevant = false;
    const ret = [];
    for (const line of lines) {
        if (line.trim() === RELEVANT_TAG) {
            inRelevant = true;
            didFindRelevant = true;
        }
        else if (line.trim() === DETAIL_TAG) {
            inRelevant = false;
        }
        else {
            if (inRelevant) {
                ret.push(line);
            }
        }
    }
    // Return full lines list if no switching found
    return stripCommonIndent(didFindRelevant ? ret : lines);
}
/**
 * Remove common leading whitespace from the given lines
 */
function stripCommonIndent(lines) {
    const leadingWhitespace = /^(\s*)/;
    const indents = lines.map((l) => leadingWhitespace.exec(l)[1].length);
    const commonIndent = Math.min(...indents);
    return lines.map((l) => l.substr(commonIndent));
}
/**
 * Turn source lines into Markdown, starting in TypeScript mode
 */
function markdownify(lines, codeBlockAnnotations) {
    const typescriptLines = [];
    const ret = [];
    for (const line of lines) {
        const m = INLINE_MD_REGEX.exec(line);
        if (m) {
            // Literal MarkDown line
            flushTS();
            ret.push(m[1]);
        }
        else {
            typescriptLines.push(line);
        }
    }
    flushTS();
    return ret;
    /**
     * Flush typescript lines with a triple-backtick-ts block around it.
     */
    function flushTS() {
        if (typescriptLines.length !== 0) {
            // eslint-disable-next-line prefer-template
            ret.push(`\`\`\`ts${codeBlockAnnotations.length > 0
                ? ` ${codeBlockAnnotations.join(' ')}`
                : ''}`, ...typescriptLines, '```');
            typescriptLines.splice(0); // Clear
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGl0ZXJhdGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJsaXRlcmF0ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQTs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0dBeURHO0FBQ0gsK0JBQStCO0FBQy9CLDZCQUE2QjtBQUU3Qjs7R0FFRztBQUNILFNBQWdCLDBCQUEwQixDQUN4QyxLQUFlLEVBQ2Ysb0JBQThCO0lBRTlCLE1BQU0sYUFBYSxHQUFHLGlCQUFpQixDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQy9DLE1BQU0sYUFBYSxHQUFHLFdBQVcsQ0FBQyxhQUFhLEVBQUUsb0JBQW9CLENBQUMsQ0FBQztJQUN2RSxPQUFPLGFBQWEsQ0FBQztBQUN2QixDQUFDO0FBUEQsZ0VBT0M7QUFJRDs7Ozs7OztHQU9HO0FBQ0ksS0FBSyxVQUFVLHdCQUF3QixDQUM1QyxLQUFlLEVBQ2YsTUFBa0I7SUFFbEIsTUFBTSxHQUFHLEdBQWEsRUFBRSxDQUFDO0lBRXpCLE1BQU0sS0FBSyxHQUFHLG9DQUFvQyxDQUFDO0lBQ25ELEtBQUssTUFBTSxJQUFJLElBQUksS0FBSyxFQUFFO1FBQ3hCLE1BQU0sQ0FBQyxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDM0IsSUFBSSxDQUFDLEVBQUU7WUFDTCxtQkFBbUI7WUFDbkIsTUFBTSxRQUFRLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3RCLDRDQUE0QztZQUM1QyxNQUFNLE1BQU0sR0FBRyxNQUFNLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUN0QyxvRkFBb0Y7WUFDcEYsTUFBTSxRQUFRLEdBQUcsMEJBQTBCLENBQUMsTUFBTSxFQUFFLENBQUMsT0FBTyxRQUFRLEVBQUUsQ0FBQyxDQUFDLENBQUM7WUFDekUsR0FBRyxDQUFDLElBQUksQ0FBQyxHQUFHLFFBQVEsQ0FBQyxDQUFDO1NBQ3ZCO2FB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LENBQUMsSUFBSSxDQUFDLENBQUM7UUFDckMsSUFBSSxDQUFDLEVBQUU7WUFDTCx3QkFBd0I7WUFDeEIsT0FBTyxFQUFFLENBQUM7WUFDVixHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1NBQ2hCO2FBQU07WUFDTCxlQUFlLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1NBQzVCO0tBQ0Y7SUFFRCxPQUFPLEVBQUUsQ0FBQztJQUVWLE9BQU8sR0FBRyxDQUFDO0lBRVg7O09BRUc7SUFDSCxTQUFTLE9BQU87UUFDZCxJQUFJLGVBQWUsQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO1lBQ2hDLDJDQUEyQztZQUMzQyxHQUFHLENBQUMsSUFBSSxDQUNOLFdBQ0Usb0JBQW9CLENBQUMsTUFBTSxHQUFHLENBQUM7Z0JBQzdCLENBQUMsQ0FBQyxJQUFJLG9CQUFvQixDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRTtnQkFDdEMsQ0FBQyxDQUFDLEVBQ04sRUFBRSxFQUNGLEdBQUcsZUFBZSxFQUNsQixLQUFLLENBQ04sQ0FBQztZQUNGLGVBQWUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxRQUFRO1NBQ3BDO0lBQ0gsQ0FBQztBQUNILENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEEgdGlueSBtb2R1bGUgdG8gaW5jbHVkZSBhbm5vdGF0ZWQgKHdvcmtpbmchKSBjb2RlIHNuaXBwZXRzIGludG8gdGhlIGRvY3VtZW50YXRpb25cbiAqXG4gKiBOb3QgdXNpbmcgJ2xpdGVyYXRlLXByb2dyYW1taW5nJyBvciAnZXJhc3VtdXMnIHByb2plY3RzIGJlY2F1c2UgdGhleSB3b3JrXG4gKiB0aGUgb3RoZXIgd2F5IGFyb3VuZDogdGFrZSBjb2RlIGZyb20gTWFya0Rvd24sIHNhdmUgaXQgYXMgYSBmaWxlLCB0aGVuXG4gKiBleGVjdXRlIHRoYXQuXG4gKlxuICogV2UgZG8gdGhlIG9wcG9zaXRlOiBzdGFydCBmcm9tIHNvdXJjZSBjb2RlIGFubm90YXRlZCB3aXRoIE1hcmtEb3duIGFuZFxuICogZXh0cmFjdCBpdCBpbnRvIChsYXJnZXIpIE1hcmtEb3duIGZpbGVzLlxuICpcbiAqIEluY2x1ZGluZyBpbnRvIFJFQURNRVxuICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gKlxuICogVG8gaW5jbHVkZSB0aGUgZXhhbXBsZXMgZGlyZWN0bHkgaW50byB0aGUgUkVBRE1FLCBtYWtlIGEgbGluayB0byB0aGVcbiAqIGFubm90YXRlZCBUeXBlU2NyaXB0IGZpbGUgb24gYSBsaW5lIGJ5IGl0c2VsZiwgYW5kIG1ha2Ugc3VyZSB0aGVcbiAqIGV4dGVuc2lvbiBvZiB0aGUgZmlsZSBlbmRzIGluIGAubGl0LnRzYC5cbiAqXG4gKiBGb3IgZXhhbXBsZTpcbiAqXG4gKiAgICBbZXhhbXBsZV0odGVzdC9pbnRlZy5idWNrZXQubGl0LnRzKVxuICpcbiAqIEFubm90YXRpbmcgc291cmNlXG4gKiAtLS0tLS0tLS0tLS0tLS0tLVxuICpcbiAqIFdlIHVzZSB0aGUgdHJpcGxlLXNsYXNoIGNvbW1lbnQgZm9yIG91ciBkaXJlY3RpdmVzLCBzaW5jZSBpdCdzIHZhbGlkIFR5cGVTY3JpcHRcbiAqIGFuZCBhcmUgdHJlYXRlZCBhcyByZWd1bGFyIGNvbW1lbnRzIGlmIG5vdCB0aGUgdmVyeSBmaXJzdCB0aGluZyBpbiB0aGUgZmlsZS5cbiAqXG4gKiBCeSBkZWZhdWx0LCB0aGUgd2hvbGUgZmlsZSBpcyBpbmNsdWRlZCwgdW5sZXNzIHRoZSBzb3VyY2UgY29udGFpbnMgdGhlIHN0YXRlbWVudFxuICogXCIvLy8gIXNob3dcIi4gRm9yIGV4YW1wbGU6XG4gKlxuICogICAgIGFcbiAqICAgICAvLy8gIXNob3dcbiAqICAgICBiXG4gKiAgICAgLy8vICFoaWRlXG4gKiAgICAgY1xuICpcbiAqIEluIHRoaXMgZXhhbXBsZSwgb25seSAnYicgd291bGQgYmUgaW5jbHVkZWQgaW4gdGhlIG91dHB1dC4gQSBzaW5nbGUgZmlsZSBtYXlcbiAqIHN3aXRjaGluZyBpbmNsdWRpbmcgYW5kIGV4Y2x1ZGluZyBvbiBhbmQgb2ZmIG11bHRpcGxlIHRpbWVzIGluIHRoZSBzYW1lIGZpbGUuXG4gKlxuICogT3RoZXIgbGluZXMgc3RhcnRpbmcgd2l0aCB0cmlwbGUgc2xhc2hlcyB3aWxsIGJlIHJlbmRlcmVkIGFzIE1hcmtkb3duIGluIGJldHdlZW5cbiAqIHRoZSBzb3VyY2UgbGluZXMuIEZvciBleGFtcGxlOlxuICpcbiAqICAgICBjb25zdCB4ID0gMTtcbiAqICAgICAvLy8gTm93IHdlJ3JlIGdvaW5nIHRvIHByaW50IHg6XG4gKiAgICAgY29uc29sZS5sb2coeCk7XG4gKlxuICogV2lsbCBiZSByZW5kZXJlZCBhczpcbiAqXG4gKiAgICAgYGBgdHNcbiAqICAgICBjb25zdCB4ID0gMTtcbiAqICAgICBgYGBcbiAqXG4gKiAgICAgTm93IHdlJ3JlIGdvaW5nIHRvIHByaW50IHg6XG4gKlxuICogICAgIGBgYHRzXG4gKiAgICAgY29uc29sZS5sb2coeCk7XG4gKiAgICAgYGBgXG4gKi9cbmltcG9ydCAqIGFzIGZzIGZyb20gJ2ZzLWV4dHJhJztcbmltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCc7XG5cbi8qKlxuICogQ29udmVydCBhbiBhbm5vdGF0ZWQgVHlwZVNjcmlwdCBzb3VyY2UgZmlsZSB0byBNYXJrRG93blxuICovXG5leHBvcnQgZnVuY3Rpb24gdHlwZXNjcmlwdFNvdXJjZVRvTWFya2Rvd24oXG4gIGxpbmVzOiBzdHJpbmdbXSxcbiAgY29kZUJsb2NrQW5ub3RhdGlvbnM6IHN0cmluZ1tdLFxuKTogc3RyaW5nW10ge1xuICBjb25zdCByZWxldmFudExpbmVzID0gZmluZFJlbGV2YW50TGluZXMobGluZXMpO1xuICBjb25zdCBtYXJrZG93bkxpbmVzID0gbWFya2Rvd25pZnkocmVsZXZhbnRMaW5lcywgY29kZUJsb2NrQW5ub3RhdGlvbnMpO1xuICByZXR1cm4gbWFya2Rvd25MaW5lcztcbn1cblxuZXhwb3J0IHR5cGUgRmlsZUxvYWRlciA9IChyZWxhdGl2ZVBhdGg6IHN0cmluZykgPT4gc3RyaW5nW10gfCBQcm9taXNlPHN0cmluZ1tdPjtcblxuLyoqXG4gKiBHaXZlbiBNYXJrRG93biBzb3VyY2UsIGZpbmQgc291cmNlIGZpbGVzIHRvIGluY2x1ZGUgYW5kIHJlbmRlclxuICpcbiAqIFdlIHJlY29nbml6ZSBsaW5rcyBvbiBhIGxpbmUgYnkgdGhlbXNlbHZlcyBpZiB0aGUgbGluayB0ZXh0IHN0YXJ0c1xuICogd2l0aCB0aGUgc3RyaW5nIFwiZXhhbXBsZVwiIChjYXNlIGluc2Vuc2l0aXZlKS4gRm9yIGV4YW1wbGU6XG4gKlxuICogICAgIFtleGFtcGxlXSh0ZXN0L2ludGVnLmJ1Y2tldC50cylcbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGluY2x1ZGVBbmRSZW5kZXJFeGFtcGxlcyhcbiAgbGluZXM6IHN0cmluZ1tdLFxuICBsb2FkZXI6IEZpbGVMb2FkZXIsXG4pOiBQcm9taXNlPHN0cmluZ1tdPiB7XG4gIGNvbnN0IHJldDogc3RyaW5nW10gPSBbXTtcblxuICBjb25zdCByZWdleCA9IC9eXFxbKFteXFxdXSopXFxdXFwoKFteKV0rXFwubGl0XFwudHMpXFwpL2k7XG4gIGZvciAoY29uc3QgbGluZSBvZiBsaW5lcykge1xuICAgIGNvbnN0IG0gPSByZWdleC5leGVjKGxpbmUpO1xuICAgIGlmIChtKSB7XG4gICAgICAvLyBGb3VuZCBhbiBpbmNsdWRlXG4gICAgICBjb25zdCBmaWxlbmFtZSA9IG1bMl07XG4gICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tYXdhaXQtaW4tbG9vcFxuICAgICAgY29uc3Qgc291cmNlID0gYXdhaXQgbG9hZGVyKGZpbGVuYW1lKTtcbiAgICAgIC8vICdsaXQnIHNvdXJjZSBhdHRyaWJ1dGUgd2lsbCBtYWtlIHNuaXBwZXQgY29tcGlsZXIga25vdyB0byBleHRyYWN0IHRoZSBzYW1lIHNvdXJjZVxuICAgICAgY29uc3QgaW1wb3J0ZWQgPSB0eXBlc2NyaXB0U291cmNlVG9NYXJrZG93bihzb3VyY2UsIFtgbGl0PSR7ZmlsZW5hbWV9YF0pO1xuICAgICAgcmV0LnB1c2goLi4uaW1wb3J0ZWQpO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXQucHVzaChsaW5lKTtcbiAgICB9XG4gIH1cblxuICByZXR1cm4gcmV0O1xufVxuXG4vKipcbiAqIExvYWQgYSBmaWxlIGludG8gYSBzdHJpbmcgYXJyYXlcbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGxvYWRGcm9tRmlsZShmaWxlTmFtZTogc3RyaW5nKTogUHJvbWlzZTxzdHJpbmdbXT4ge1xuICBjb25zdCBjb250ZW50ID0gYXdhaXQgZnMucmVhZEZpbGUoZmlsZU5hbWUsIHsgZW5jb2Rpbmc6ICd1dGYtOCcgfSk7XG4gIHJldHVybiBjb250ZW50VG9MaW5lcyhjb250ZW50KTtcbn1cblxuLyoqXG4gKiBUdXJuIGZpbGUgY29udGVudCBzdHJpbmcgaW50byBhbiBhcnJheSBvZiBsaW5lcyByZWFkeSBmb3IgcHJvY2Vzc2luZyB1c2luZyB0aGUgb3RoZXIgZnVuY3Rpb25zXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBjb250ZW50VG9MaW5lcyhjb250ZW50OiBzdHJpbmcpOiBzdHJpbmdbXSB7XG4gIHJldHVybiBjb250ZW50LnNwbGl0KCdcXG4nKS5tYXAoKHgpID0+IHgudHJpbVJpZ2h0KCkpO1xufVxuXG4vKipcbiAqIFJldHVybiBhIGZpbGUgc3lzdGVtIGxvYWRlciBnaXZlbiBhIGJhc2UgZGlyZWN0b3J5XG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBmaWxlU3lzdGVtTG9hZGVyKGRpcmVjdG9yeTogc3RyaW5nKTogRmlsZUxvYWRlciB7XG4gIHJldHVybiAoZmlsZU5hbWUpID0+IGxvYWRGcm9tRmlsZShwYXRoLnJlc29sdmUoZGlyZWN0b3J5LCBmaWxlTmFtZSkpO1xufVxuXG5jb25zdCBSRUxFVkFOVF9UQUcgPSAnLy8vICFzaG93JztcbmNvbnN0IERFVEFJTF9UQUcgPSAnLy8vICFoaWRlJztcbmNvbnN0IElOTElORV9NRF9SRUdFWCA9IC9eXFxzKlxcL1xcL1xcLyAoLiopJC87XG5cbi8qKlxuICogRmluZCB0aGUgcmVsZXZhbnQgbGluZXMgb2YgdGhlIGlucHV0IHNvdXJjZVxuICpcbiAqIFJlc3BlY3RzIHN3aXRjaGluZyB0YWdzLCByZXR1cm5zIGV2ZXJ5dGhpbmcgaWYgbm8gc3dpdGNoaW5nIGZvdW5kLlxuICpcbiAqIFN0cmlwcyBjb21tb24gaW5kZW50YXRpb24gZnJvbSB0aGUgYmxvY2tzIGl0IGZpbmRzLlxuICovXG5mdW5jdGlvbiBmaW5kUmVsZXZhbnRMaW5lcyhsaW5lczogc3RyaW5nW10pOiBzdHJpbmdbXSB7XG4gIGxldCBpblJlbGV2YW50ID0gZmFsc2U7XG4gIGxldCBkaWRGaW5kUmVsZXZhbnQgPSBmYWxzZTtcbiAgY29uc3QgcmV0OiBzdHJpbmdbXSA9IFtdO1xuXG4gIGZvciAoY29uc3QgbGluZSBvZiBsaW5lcykge1xuICAgIGlmIChsaW5lLnRyaW0oKSA9PT0gUkVMRVZBTlRfVEFHKSB7XG4gICAgICBpblJlbGV2YW50ID0gdHJ1ZTtcbiAgICAgIGRpZEZpbmRSZWxldmFudCA9IHRydWU7XG4gICAgfSBlbHNlIGlmIChsaW5lLnRyaW0oKSA9PT0gREVUQUlMX1RBRykge1xuICAgICAgaW5SZWxldmFudCA9IGZhbHNlO1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAoaW5SZWxldmFudCkge1xuICAgICAgICByZXQucHVzaChsaW5lKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICAvLyBSZXR1cm4gZnVsbCBsaW5lcyBsaXN0IGlmIG5vIHN3aXRjaGluZyBmb3VuZFxuICByZXR1cm4gc3RyaXBDb21tb25JbmRlbnQoZGlkRmluZFJlbGV2YW50ID8gcmV0IDogbGluZXMpO1xufVxuXG4vKipcbiAqIFJlbW92ZSBjb21tb24gbGVhZGluZyB3aGl0ZXNwYWNlIGZyb20gdGhlIGdpdmVuIGxpbmVzXG4gKi9cbmZ1bmN0aW9uIHN0cmlwQ29tbW9uSW5kZW50KGxpbmVzOiBzdHJpbmdbXSk6IHN0cmluZ1tdIHtcbiAgY29uc3QgbGVhZGluZ1doaXRlc3BhY2UgPSAvXihcXHMqKS87XG4gIGNvbnN0IGluZGVudHMgPSBsaW5lcy5tYXAoKGwpID0+IGxlYWRpbmdXaGl0ZXNwYWNlLmV4ZWMobCkhWzFdLmxlbmd0aCk7XG4gIGNvbnN0IGNvbW1vbkluZGVudCA9IE1hdGgubWluKC4uLmluZGVudHMpO1xuICByZXR1cm4gbGluZXMubWFwKChsKSA9PiBsLnN1YnN0cihjb21tb25JbmRlbnQpKTtcbn1cblxuLyoqXG4gKiBUdXJuIHNvdXJjZSBsaW5lcyBpbnRvIE1hcmtkb3duLCBzdGFydGluZyBpbiBUeXBlU2NyaXB0IG1vZGVcbiAqL1xuZnVuY3Rpb24gbWFya2Rvd25pZnkoXG4gIGxpbmVzOiBzdHJpbmdbXSxcbiAgY29kZUJsb2NrQW5ub3RhdGlvbnM6IHN0cmluZ1tdLFxuKTogc3RyaW5nW10ge1xuICBjb25zdCB0eXBlc2NyaXB0TGluZXM6IHN0cmluZ1tdID0gW107XG4gIGNvbnN0IHJldDogc3RyaW5nW10gPSBbXTtcblxuICBmb3IgKGNvbnN0IGxpbmUgb2YgbGluZXMpIHtcbiAgICBjb25zdCBtID0gSU5MSU5FX01EX1JFR0VYLmV4ZWMobGluZSk7XG4gICAgaWYgKG0pIHtcbiAgICAgIC8vIExpdGVyYWwgTWFya0Rvd24gbGluZVxuICAgICAgZmx1c2hUUygpO1xuICAgICAgcmV0LnB1c2gobVsxXSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHR5cGVzY3JpcHRMaW5lcy5wdXNoKGxpbmUpO1xuICAgIH1cbiAgfVxuXG4gIGZsdXNoVFMoKTtcblxuICByZXR1cm4gcmV0O1xuXG4gIC8qKlxuICAgKiBGbHVzaCB0eXBlc2NyaXB0IGxpbmVzIHdpdGggYSB0cmlwbGUtYmFja3RpY2stdHMgYmxvY2sgYXJvdW5kIGl0LlxuICAgKi9cbiAgZnVuY3Rpb24gZmx1c2hUUygpIHtcbiAgICBpZiAodHlwZXNjcmlwdExpbmVzLmxlbmd0aCAhPT0gMCkge1xuICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIHByZWZlci10ZW1wbGF0ZVxuICAgICAgcmV0LnB1c2goXG4gICAgICAgIGBcXGBcXGBcXGB0cyR7XG4gICAgICAgICAgY29kZUJsb2NrQW5ub3RhdGlvbnMubGVuZ3RoID4gMFxuICAgICAgICAgICAgPyBgICR7Y29kZUJsb2NrQW5ub3RhdGlvbnMuam9pbignICcpfWBcbiAgICAgICAgICAgIDogJydcbiAgICAgICAgfWAsXG4gICAgICAgIC4uLnR5cGVzY3JpcHRMaW5lcyxcbiAgICAgICAgJ2BgYCcsXG4gICAgICApO1xuICAgICAgdHlwZXNjcmlwdExpbmVzLnNwbGljZSgwKTsgLy8gQ2xlYXJcbiAgICB9XG4gIH1cbn1cbiJdfQ==