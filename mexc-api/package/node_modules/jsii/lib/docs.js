"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.splitSummary = exports.getReferencedDocParams = exports.renderSymbolDocumentation = exports.parseSymbolDocumentation = void 0;
/**
 * Doc Comment parsing
 *
 * I tried using TSDoc here.
 *
 * Pro:
 * - Future standard.
 * - Does validating parsing and complains on failure.
 * - Has a more flexible interpretation of the @example tag (starts in text mode).
 *
 * Con:
 * - Different tags from JSDoc (@defaultValue instead of @default, "@param name
 *   description" instead "@param name description".
 * - @example tag has a different interpretation than VSCode and JSDoc
 *   (VSCode/JSDoc starts in code mode), which is confusing for syntax
 *   highlighting in the editor.
 * - Allows no unknown tags.
 * - Wants to be in charge of parsing TypeScript, integrating into other build is
 *   possible but harder.
 * - Parse to a DOM with no easy way to roundtrip back to equivalent MarkDown.
 *
 * Especially the last point: while parsing to and storing the parsed docs DOM
 * in the jsii assembly is superior in the long term (for example for
 * converting to different output formats, JavaDoc, C# docs, refdocs which all
 * accept slightly different syntaxes), right now we can get 80% of the bang
 * for 10% of the buck by just reading, storing and reproducing MarkDown, which
 * is Readable Enough(tm).
 *
 * If we ever want to attempt TSDoc again, this would be a good place to look at:
 *
 * https://github.com/Microsoft/tsdoc/blob/master/api-demo/src/advancedDemo.ts
 */
const spec = require("@jsii/spec");
const ts = require("typescript");
/**
 * Tags that we recognize
 */
var DocTag;
(function (DocTag) {
    DocTag["PARAM"] = "param";
    DocTag["DEFAULT"] = "default";
    DocTag["DEFAULT_VALUE"] = "defaultValue";
    DocTag["DEPRECATED"] = "deprecated";
    DocTag["RETURNS"] = "returns";
    DocTag["RETURN"] = "return";
    DocTag["STABLE"] = "stable";
    DocTag["EXPERIMENTAL"] = "experimental";
    DocTag["SEE"] = "see";
    DocTag["SUBCLASSABLE"] = "subclassable";
    DocTag["EXAMPLE"] = "example";
    DocTag["STABILITY"] = "stability";
    DocTag["STRUCT"] = "struct";
})(DocTag || (DocTag = {}));
/**
 * Parse all doc comments that apply to a symbol into JSIIDocs format
 */
function parseSymbolDocumentation(sym, typeChecker) {
    const comment = ts
        .displayPartsToString(sym.getDocumentationComment(typeChecker))
        .trim();
    const tags = reabsorbExampleTags(sym.getJsDocTags());
    // Right here we'll just guess that the first declaration site is the most important one.
    return parseDocParts(comment, tags);
}
exports.parseSymbolDocumentation = parseSymbolDocumentation;
/**
 * Render JSIIDocs back to a TSDoc block
 */
function renderSymbolDocumentation(docs, parameters) {
    var _a, _b, _c;
    const lines = [];
    if (docs.summary) {
        lines.push(docs.summary);
        lines.push('');
    }
    if (docs.remarks) {
        lines.push(...docs.remarks.split('\n'));
        lines.push('');
    }
    for (const [name, docs] of Object.entries(parameters !== null && parameters !== void 0 ? parameters : {})) {
        tag('param', `${name} ${(_a = docs.summary) !== null && _a !== void 0 ? _a : ''}`);
    }
    tag(DocTag.RETURNS, docs.returns);
    tag(DocTag.DEFAULT, docs.default);
    tag(DocTag.SEE, docs.see);
    if (docs.subclassable) {
        tag(DocTag.SUBCLASSABLE, '');
    }
    switch (docs.stability) {
        case spec.Stability.Deprecated:
            tag('deprecated', (_b = docs.deprecated) !== null && _b !== void 0 ? _b : '');
            break;
        case spec.Stability.Experimental:
            tag('experimental', '');
            break;
        case spec.Stability.External:
            tag('external', '');
            break;
        default:
            tag('stability', docs.stability);
    }
    for (const [k, v] of Object.entries((_c = docs.custom) !== null && _c !== void 0 ? _c : {})) {
        tag(k, v);
    }
    if (docs.example) {
        lines.push('@example');
        lines.push('');
        lines.push(...docs.example.split('\n'));
    }
    while (lines.length > 0 && lines[lines.length - 1] === '') {
        lines.pop();
    }
    return lines.join('\n');
    function tag(tagName, value) {
        if (value !== undefined) {
            lines.push(`@${tagName} ${value}`.trim());
        }
    }
}
exports.renderSymbolDocumentation = renderSymbolDocumentation;
/**
 * Return the list of parameter names that are referenced in the docstring for this symbol
 */
function getReferencedDocParams(sym) {
    var _a;
    const ret = new Array();
    for (const tag of sym.getJsDocTags()) {
        if (tag.name === DocTag.PARAM) {
            const parts = ((_a = tag.text) !== null && _a !== void 0 ? _a : '').split(' ');
            ret.push(parts[0]);
        }
    }
    return ret;
}
exports.getReferencedDocParams = getReferencedDocParams;
function parseDocParts(comments, tags) {
    var _a, _b;
    const diagnostics = new Array();
    const docs = {};
    const hints = {};
    [docs.summary, docs.remarks] = splitSummary(comments);
    const tagNames = new Map();
    for (const tag of tags) {
        // 'param' gets parsed as a tag and as a comment for a method
        if (tag.name !== DocTag.PARAM) {
            tagNames.set(tag.name, tag.text);
        }
    }
    function eatTag(...names) {
        for (const name of names) {
            if (tagNames.has(name)) {
                const ret = tagNames.get(name);
                tagNames.delete(name);
                return ret !== null && ret !== void 0 ? ret : '';
            }
        }
        return undefined;
    }
    if (eatTag(DocTag.STRUCT) != null) {
        hints.struct = true;
    }
    docs.default = eatTag(DocTag.DEFAULT, DocTag.DEFAULT_VALUE);
    docs.deprecated = eatTag(DocTag.DEPRECATED);
    docs.example = eatTag(DocTag.EXAMPLE);
    docs.returns = eatTag(DocTag.RETURNS, DocTag.RETURN);
    docs.see = eatTag(DocTag.SEE);
    docs.subclassable =
        eatTag(DocTag.SUBCLASSABLE) !== undefined ? true : undefined;
    docs.stability = parseStability(eatTag(DocTag.STABILITY), diagnostics);
    //  @experimental is a shorthand for '@stability experimental', same for '@stable'
    const experimental = eatTag(DocTag.EXPERIMENTAL) !== undefined;
    const stable = eatTag(DocTag.STABLE) !== undefined;
    // Can't combine them
    if (countBools(docs.stability !== undefined, experimental, stable) > 1) {
        diagnostics.push('Use only one of @stability, @experimental or @stable');
    }
    if (experimental) {
        docs.stability = spec.Stability.Experimental;
    }
    if (stable) {
        docs.stability = spec.Stability.Stable;
    }
    // Can combine '@stability deprecated' with '@deprecated <reason>'
    if (docs.deprecated !== undefined) {
        if (docs.stability !== undefined &&
            docs.stability !== spec.Stability.Deprecated) {
            diagnostics.push("@deprecated tag requires '@stability deprecated' or no @stability at all.");
        }
        docs.stability = spec.Stability.Deprecated;
    }
    if ((_a = docs.example) === null || _a === void 0 ? void 0 : _a.includes('```')) {
        // This is currently what the JSDoc standard expects, and VSCode highlights it in
        // this way as well. TSDoc disagrees and says that examples start in text mode
        // which I tend to agree with, but that hasn't become a widely used standard yet.
        //
        // So we conform to existing reality.
        diagnostics.push('@example must be code only, no code block fences allowed.');
    }
    if (((_b = docs.deprecated) === null || _b === void 0 ? void 0 : _b.trim()) === '') {
        diagnostics.push('@deprecated tag needs a reason and/or suggested alternatives.');
    }
    if (tagNames.size > 0) {
        docs.custom = {};
        for (const [key, value] of tagNames.entries()) {
            docs.custom[key] = value !== null && value !== void 0 ? value : 'true'; // Key must have a value or it will be stripped from the assembly
        }
    }
    return { docs, diagnostics, hints };
}
/**
 * Split the doc comment into summary and remarks
 *
 * Normally, we'd expect people to split into a summary line and detail lines using paragraph
 * markers. However, a LOT of people do not do this, and just paste a giant comment block into
 * the docstring. If we detect that situation, we will try and extract the first sentence (using
 * a period) as the summary.
 */
function splitSummary(docBlock) {
    if (!docBlock) {
        return [undefined, undefined];
    }
    const summary = summaryLine(docBlock);
    const remarks = uberTrim(docBlock.substr(summary.length));
    return [endWithPeriod(noNewlines(summary.trim())), remarks];
}
exports.splitSummary = splitSummary;
/**
 * Replace newlines with spaces for use in tables
 */
function noNewlines(s) {
    return s.replace(/\n/g, ' ');
}
function endWithPeriod(s) {
    return ENDS_WITH_PUNCTUATION_REGEX.test(s) ? s : `${s}.`;
}
/**
 * Trims a string and turns it into `undefined` if the result would have been an
 * empty string.
 */
function uberTrim(str) {
    str = str.trim();
    return str === '' ? undefined : str;
}
const SUMMARY_MAX_WORDS = 20;
/**
 * Find the summary line for a doc comment
 *
 * In principle we'll take the first paragraph, but if there are no paragraphs
 * (because people don't put in paragraph breaks) or the first paragraph is too
 * long, we'll take the first sentence (terminated by a punctuation).
 */
function summaryLine(str) {
    const paras = str.split('\n\n');
    if (paras.length > 1 && paras[0].split(' ').length < SUMMARY_MAX_WORDS) {
        return paras[0];
    }
    const m = FIRST_SENTENCE_REGEX.exec(str);
    if (m) {
        return m[1];
    }
    return paras[0];
}
const PUNCTUATION = ['!', '?', '.', ';'].map((s) => `\\${s}`).join('');
const ENDS_WITH_PUNCTUATION_REGEX = new RegExp(`[${PUNCTUATION}]$`);
const FIRST_SENTENCE_REGEX = new RegExp(`^([^${PUNCTUATION}]+[${PUNCTUATION}][ \n\r])`); // Needs a whitespace after the punctuation.
function intBool(x) {
    return x ? 1 : 0;
}
function countBools(...x) {
    return x.map(intBool).reduce((a, b) => a + b, 0);
}
function parseStability(s, diagnostics) {
    if (s === undefined) {
        return undefined;
    }
    switch (s) {
        case 'stable':
            return spec.Stability.Stable;
        case 'experimental':
            return spec.Stability.Experimental;
        case 'external':
            return spec.Stability.External;
        case 'deprecated':
            return spec.Stability.Deprecated;
    }
    diagnostics.push(`Unrecognized @stability: '${s}'`);
    return undefined;
}
/**
 * Unrecognized tags that follow an '@ example' tag will be absorbed back into the example value
 *
 * The TypeScript parser by itself is naive and will start parsing a new tag there.
 *
 * We do this until we encounter a supported @ keyword.
 */
function reabsorbExampleTags(tags) {
    const recognizedTags = Object.values(DocTag);
    const ret = [...tags];
    let i = 0;
    while (i < ret.length) {
        if (ret[i].name === 'example') {
            while (i + 1 < ret.length && !recognizedTags.includes(ret[i + 1].name)) {
                // Incorrectly classified as @tag, absorb back into example
                ret[i].text += `@${ret[i + 1].name}${ret[i + 1].text}`;
                ret.splice(i + 1, 1);
            }
        }
        i++;
    }
    return ret;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZG9jcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImRvY3MudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUE7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7R0ErQkc7QUFDSCxtQ0FBbUM7QUFDbkMsaUNBQWlDO0FBRWpDOztHQUVHO0FBQ0gsSUFBSyxNQWNKO0FBZEQsV0FBSyxNQUFNO0lBQ1QseUJBQWUsQ0FBQTtJQUNmLDZCQUFtQixDQUFBO0lBQ25CLHdDQUE4QixDQUFBO0lBQzlCLG1DQUF5QixDQUFBO0lBQ3pCLDZCQUFtQixDQUFBO0lBQ25CLDJCQUFpQixDQUFBO0lBQ2pCLDJCQUFpQixDQUFBO0lBQ2pCLHVDQUE2QixDQUFBO0lBQzdCLHFCQUFXLENBQUE7SUFDWCx1Q0FBNkIsQ0FBQTtJQUM3Qiw2QkFBbUIsQ0FBQTtJQUNuQixpQ0FBdUIsQ0FBQTtJQUN2QiwyQkFBaUIsQ0FBQTtBQUNuQixDQUFDLEVBZEksTUFBTSxLQUFOLE1BQU0sUUFjVjtBQUVEOztHQUVHO0FBQ0gsU0FBZ0Isd0JBQXdCLENBQ3RDLEdBQWMsRUFDZCxXQUEyQjtJQUUzQixNQUFNLE9BQU8sR0FBRyxFQUFFO1NBQ2Ysb0JBQW9CLENBQUMsR0FBRyxDQUFDLHVCQUF1QixDQUFDLFdBQVcsQ0FBQyxDQUFDO1NBQzlELElBQUksRUFBRSxDQUFDO0lBQ1YsTUFBTSxJQUFJLEdBQUcsbUJBQW1CLENBQUMsR0FBRyxDQUFDLFlBQVksRUFBRSxDQUFDLENBQUM7SUFFckQseUZBQXlGO0lBQ3pGLE9BQU8sYUFBYSxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsQ0FBQztBQUN0QyxDQUFDO0FBWEQsNERBV0M7QUFFRDs7R0FFRztBQUNILFNBQWdCLHlCQUF5QixDQUN2QyxJQUFlLEVBQ2YsVUFBc0M7O0lBRXRDLE1BQU0sS0FBSyxHQUFhLEVBQUUsQ0FBQztJQUMzQixJQUFJLElBQUksQ0FBQyxPQUFPLEVBQUU7UUFDaEIsS0FBSyxDQUFDLElBQUksQ0FB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LEdBQUcsQ0FBQyxDQUFDO0lBQ1YsT0FBTyxDQUFDLEdBQUcsR0FBRyxDQUFDLE1BQU0sRUFBRTtRQUNyQixJQUFJLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLEtBQUssU0FBUyxFQUFFO1lBQzdCLE9BQU8sQ0FBQyxHQUFHLENBQUMsR0FBRyxHQUFHLENBQUMsTUFBTSxJQUFJLENBQUMsY0FBYyxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFO2dCQUN0RSwyREFBMkQ7Z0JBQzNELEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLElBQUksSUFBSSxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLElBQUksR0FBRyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDO2dCQUN2RCxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7YUFDdEI7U0FDRjtRQUNELENBQUMsRUFBRSxDQUFDO0tBQ0w7SUFFRCxPQUFPLEdBQUcsQ0FBQztBQUNiLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIERvYyBDb21tZW50IHBhcnNpbmdcbiAqXG4gKiBJIHRyaWVkIHVzaW5nIFRTRG9jIGhlcmUuXG4gKlxuICogUHJvOlxuICogLSBGdXR1cmUgc3RhbmRhcmQuXG4gKiAtIERvZXMgdmFsaWRhdGluZyBwYXJzaW5nIGFuZCBjb21wbGFpbnMgb24gZmFpbHVyZS5cbiAqIC0gSGFzIGEgbW9yZSBmbGV4aWJsZSBpbnRlcnByZXRhdGlvbiBvZiB0aGUgQGV4YW1wbGUgdGFnIChzdGFydHMgaW4gdGV4dCBtb2RlKS5cbiAqXG4gKiBDb246XG4gKiAtIERpZmZlcmVudCB0YWdzIGZyb20gSlNEb2MgKEBkZWZhdWx0VmFsdWUgaW5zdGVhZCBvZiBAZGVmYXVsdCwgXCJAcGFyYW0gbmFtZVxuICogICBkZXNjcmlwdGlvblwiIGluc3RlYWQgXCJAcGFyYW0gbmFtZSBkZXNjcmlwdGlvblwiLlxuICogLSBAZXhhbXBsZSB0YWcgaGFzIGEgZGlmZmVyZW50IGludGVycHJldGF0aW9uIHRoYW4gVlNDb2RlIGFuZCBKU0RvY1xuICogICAoVlNDb2RlL0pTRG9jIHN0YXJ0cyBpbiBjb2RlIG1vZGUpLCB3aGljaCBpcyBjb25mdXNpbmcgZm9yIHN5bnRheFxuICogICBoaWdobGlnaHRpbmcgaW4gdGhlIGVkaXRvci5cbiAqIC0gQWxsb3dzIG5vIHVua25vd24gdGFncy5cbiAqIC0gV2FudHMgdG8gYmUgaW4gY2hhcmdlIG9mIHBhcnNpbmcgVHlwZVNjcmlwdCwgaW50ZWdyYXRpbmcgaW50byBvdGhlciBidWlsZCBpc1xuICogICBwb3NzaWJsZSBidXQgaGFyZGVyLlxuICogLSBQYXJzZSB0byBhIERPTSB3aXRoIG5vIGVhc3kgd2F5IHRvIHJvdW5kdHJpcCBiYWNrIHRvIGVxdWl2YWxlbnQgTWFya0Rvd24uXG4gKlxuICogRXNwZWNpYWxseSB0aGUgbGFzdCBwb2ludDogd2hpbGUgcGFyc2luZyB0byBhbmQgc3RvcmluZyB0aGUgcGFyc2VkIGRvY3MgRE9NXG4gKiBpbiB0aGUganNpaSBhc3NlbWJseSBpcyBzdXBlcmlvciBpbiB0aGUgbG9uZyB0ZXJtIChmb3IgZXhhbXBsZSBmb3JcbiAqIGNvbnZlcnRpbmcgdG8gZGlmZmVyZW50IG91dHB1dCBmb3JtYXRzLCBKYXZhRG9jLCBDIyBkb2NzLCByZWZkb2NzIHdoaWNoIGFsbFxuICogYWNjZXB0IHNsaWdodGx5IGRpZmZlcmVudCBzeW50YXhlcyksIHJpZ2h0IG5vdyB3ZSBjYW4gZ2V0IDgwJSBvZiB0aGUgYmFuZ1xuICogZm9yIDEwJSBvZiB0aGUgYnVjayBieSBqdXN0IHJlYWRpbmcsIHN0b3JpbmcgYW5kIHJlcHJvZHVjaW5nIE1hcmtEb3duLCB3aGljaFxuICogaXMgUmVhZGFibGUgRW5vdWdoKHRtKS5cbiAqXG4gKiBJZiB3ZSBldmVyIHdhbnQgdG8gYXR0ZW1wdCBUU0RvYyBhZ2FpbiwgdGhpcyB3b3VsZCBiZSBhIGdvb2QgcGxhY2UgdG8gbG9vayBhdDpcbiAqXG4gKiBodHRwczovL2dpdGh1Yi5jb20vTWljcm9zb2Z0L3RzZG9jL2Jsb2IvbWFzdGVyL2FwaS1kZW1vL3NyYy9hZHZhbmNlZERlbW8udHNcbiAqL1xuaW1wb3J0ICogYXMgc3BlYyBmcm9tICdAanNpaS9zcGVjJztcbmltcG9ydCAqIGFzIHRzIGZyb20gJ3R5cGVzY3JpcHQnO1xuXG4vKipcbiAqIFRhZ3MgdGhhdCB3ZSByZWNvZ25pemVcbiAqL1xuZW51bSBEb2NUYWcge1xuICBQQVJBTSA9ICdwYXJhbScsXG4gIERFRkFVTFQgPSAnZGVmYXVsdCcsXG4gIERFRkFVTFRfVkFMVUUgPSAnZGVmYXVsdFZhbHVlJyxcbiAgREVQUkVDQVRFRCA9ICdkZXByZWNhdGVkJyxcbiAgUkVUVVJOUyA9ICdyZXR1cm5zJyxcbiAgUkVUVVJOID0gJ3JldHVybicsXG4gIFNUQUJMRSA9ICdzdGFibGUnLFxuICBFWFBFUklNRU5UQUwgPSAnZXhwZXJpbWVudGFsJyxcbiAgU0VFID0gJ3NlZScsXG4gIFNVQkNMQVNTQUJMRSA9ICdzdWJjbGFzc2FibGUnLFxuICBFWEFNUExFID0gJ2V4YW1wbGUnLFxuICBTVEFCSUxJVFkgPSAnc3RhYmlsaXR5JyxcbiAgU1RSVUNUID0gJ3N0cnVjdCcsXG59XG5cbi8qKlxuICogUGFyc2UgYWxsIGRvYyBjb21tZW50cyB0aGF0IGFwcGx5IHRvIGEgc3ltYm9sIGludG8gSlNJSURvY3MgZm9ybWF0XG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBwYXJzZVN5bWJvbERvY3VtZW50YXRpb24oXG4gIHN5bTogdHMuU3ltYm9sLFxuICB0eXBlQ2hlY2tlcjogdHMuVHlwZUNoZWNrZXIsXG4pOiBEb2NzUGFyc2luZ1Jlc3VsdCB7XG4gIGNvbnN0IGNvbW1lbnQgPSB0c1xuICAgIC5kaXNwbGF5UGFydHNUb1N0cmluZyhzeW0uZ2V0RG9jdW1lbnRhdGlvbkNvbW1lbnQodHlwZUNoZWNrZXIpKVxuICAgIC50cmltKCk7XG4gIGNvbnN0IHRhZ3MgPSByZWFic29yYkV4YW1wbGVUYWdzKHN5bS5nZXRKc0RvY1RhZ3MoKSk7XG5cbiAgLy8gUmlnaHQgaGVyZSB3ZSdsbCBqdXN0IGd1ZXNzIHRoYXQgdGhlIGZpcnN0IGRlY2xhcmF0aW9uIHNpdGUgaXMgdGhlIG1vc3QgaW1wb3J0YW50IG9uZS5cbiAgcmV0dXJuIHBhcnNlRG9jUGFydHMoY29tbWVudCwgdGFncyk7XG59XG5cbi8qKlxuICogUmVuZGVyIEpTSUlEb2NzIGJhY2sgdG8gYSBUU0RvYyBibG9ja1xuICovXG5leHBvcnQgZnVuY3Rpb24gcmVuZGVyU3ltYm9sRG9jdW1lbnRhdGlvbihcbiAgZG9jczogc3BlYy5Eb2NzLFxuICBwYXJhbWV0ZXJzPzogUmVjb3JkPHN0cmluZywgc3BlYy5Eb2NzPixcbik6IHN0cmluZyB7XG4gIGNvbnN0IGxpbmVzOiBzdHJpbmdbXSA9IFtdO1xuICBpZiAoZG9jcy5zdW1tYXJ5KSB7XG4gICAgbGluZXMucHVzaChkb2NzLnN1bW1hcnkpO1xuICAgIGxpbmVzLnB1c2goJycpO1xuICB9XG4gIGlmIChkb2NzLnJlbWFya3MpIHtcbiAgICBsaW5lcy5wdXNoKC4uLmRvY3MucmVtYXJrcy5zcGxpdCgnXFxuJykpO1xuICAgIGxpbmVzLnB1c2goJycpO1xuICB9XG5cbiAgZm9yIChjb25zdCBbbmFtZSwgZG9jc10gb2YgT2JqZWN0LmVudHJpZXMocGFyYW1ldGVycyA/PyB7fSkpIHtcbiAgICB0YWcoJ3BhcmFtJywgYCR7bmFtZX0gJHtkb2NzLnN1bW1hcnkgPz8gJyd9YCk7XG4gIH1cbiAgdGFnKERvY1RhZy5SRVRVUk5TLCBkb2NzLnJldHVybnMpO1xuICB0YWcoRG9jVGFnLkRFRkFVTFQsIGRvY3MuZGVmYXVsdCk7XG4gIHRhZyhEb2NUYWcuU0VFLCBkb2NzLnNlZSk7XG4gIGlmIChkb2NzLnN1YmNsYXNzYWJsZSkge1xuICAgIHRhZyhEb2NUYWcuU1VCQ0xBU1NBQkxFLCAnJyk7XG4gIH1cblxuICBzd2l0Y2ggKGRvY3Muc3RhYmlsaXR5KSB7XG4gICAgY2FzZSBzcGVjLlN0YWJpbGl0eS5EZXByZWNhdGVkOlxuICAgICAgdGFnKCdkZXByZWNhdGVkJywgZG9jcy5kZXByZWNhdGVkID8/ICcnKTtcbiAgICAgIGJyZWFrO1xuICAgIGNhc2Ugc3BlYy5TdGFiaWxpdHkuRXhwZXJpbWVudGFsOlxuICAgICAgdGFnKCdleHBlcmltZW50YWwnLCAnJyk7XG4gICAgICBicmVhaztcbiAgICBjYXNlIHNwZWMuU3RhYmlsaXR5LkV4dGVybmFsOlxuICAgICAgdGFnKCdleHRlcm5hbCcsICcnKTtcbiAgICAgIGJyZWFrO1xuICAgIGRlZmF1bHQ6XG4gICAgICB0YWcoJ3N0YWJpbGl0eScsIGRvY3Muc3RhYmlsaXR5KTtcbiAgfVxuXG4gIGZvciAoY29uc3QgW2ssIHZdIG9mIE9iamVjdC5lbnRyaWVzKGRvY3MuY3VzdG9tID8/IHt9KSkge1xuICAgIHRhZyhrLCB2KTtcbiAgfVxuXG4gIGlmIChkb2NzLmV4YW1wbGUpIHtcbiAgICBsaW5lcy5wdXNoKCdAZXhhbXBsZScpO1xuICAgIGxpbmVzLnB1c2goJycpO1xuICAgIGxpbmVzLnB1c2goLi4uZG9jcy5leGFtcGxlLnNwbGl0KCdcXG4nKSk7XG4gIH1cblxuICB3aGlsZSAobGluZXMubGVuZ3RoID4gMCAmJiBsaW5lc1tsaW5lcy5sZW5ndGggLSAxXSA9PT0gJycpIHtcbiAgICBsaW5lcy5wb3AoKTtcbiAgfVxuXG4gIHJldHVybiBsaW5lcy5qb2luKCdcXG4nKTtcblxuICBmdW5jdGlvbiB0YWcodGFnTmFtZTogc3RyaW5nLCB2YWx1ZTogc3RyaW5nIHwgdW5kZWZpbmVkKSB7XG4gICAgaWYgKHZhbHVlICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIGxpbmVzLnB1c2goYEAke3RhZ05hbWV9ICR7dmFsdWV9YC50cmltKCkpO1xuICAgIH1cbiAgfVxufVxuXG4vKipcbiAqIFJldHVybiB0aGUgbGlzdCBvZiBwYXJhbWV0ZXIgbmFtZXMgdGhhdCBhcmUgcmVmZXJlbmNlZCBpbiB0aGUgZG9jc3RyaW5nIGZvciB0aGlzIHN5bWJvbFxuICovXG5leHBvcnQgZnVuY3Rpb24gZ2V0UmVmZXJlbmNlZERvY1BhcmFtcyhzeW06IHRzLlN5bWJvbCk6IHN0cmluZ1tdIHtcbiAgY29uc3QgcmV0ID0gbmV3IEFycmF5PHN0cmluZz4oKTtcbiAgZm9yIChjb25zdCB0YWcgb2Ygc3ltLmdldEpzRG9jVGFncygpKSB7XG4gICAgaWYgKHRhZy5uYW1lID09PSBEb2NUYWcuUEFSQU0pIHtcbiAgICAgIGNvbnN0IHBhcnRzID0gKHRhZy50ZXh0ID8/ICcnKS5zcGxpdCgnICcpO1xuICAgICAgcmV0LnB1c2gocGFydHNbMF0pO1xuICAgIH1cbiAgfVxuICByZXR1cm4gcmV0O1xufVxuXG5mdW5jdGlvbiBwYXJzZURvY1BhcnRzKFxuICBjb21tZW50czogc3RyaW5nIHwgdW5kZWZpbmVkLFxuICB0YWdzOiB0cy5KU0RvY1RhZ0luZm9bXSxcbik6IERvY3NQYXJzaW5nUmVzdWx0IHtcbiAgY29uc3QgZGlhZ25vc3RpY3MgPSBuZXcgQXJyYXk8c3RyaW5nPigpO1xuICBjb25zdCBkb2NzOiBzcGVjLkRvY3MgPSB7fTtcbiAgY29uc3QgaGludHM6IFR5cGVTeXN0ZW1IaW50cyA9IHt9O1xuXG4gIFtkb2NzLnN1bW1hcnksIGRvY3MucmVtYXJrc10gPSBzcGxpdFN1bW1hcnkoY29tbWVudHMpO1xuXG4gIGNvbnN0IHRhZ05hbWVzID0gbmV3IE1hcDxzdHJpbmcsIHN0cmluZyB8IHVuZGVmaW5lZD4oKTtcbiAgZm9yIChjb25zdCB0YWcgb2YgdGFncykge1xuICAgIC8vICdwYXJhbScgZ2V0cyBwYXJzZWQgYXMgYSB0YWcgYW5kIGFzIGEgY29tbWVudCBmb3IgYSBtZXRob2RcbiAgICBpZiAodGFnLm5hbWUgIT09IERvY1RhZy5QQVJBTSkge1xuICAgICAgdGFnTmFtZXMuc2V0KHRhZy5uYW1lLCB0YWcudGV4dCk7XG4gICAgfVxuICB9XG5cbiAgZnVuY3Rpb24gZWF0VGFnKC4uLm5hbWVzOiBzdHJpbmdbXSk6IHN0cmluZyB8IHVuZGVmaW5lZCB7XG4gICAgZm9yIChjb25zdCBuYW1lIG9mIG5hbWVzKSB7XG4gICAgICBpZiAodGFnTmFtZXMuaGFzKG5hbWUpKSB7XG4gICAgICAgIGNvbnN0IHJldCA9IHRhZ05hbWVzLmdldChuYW1lKTtcbiAgICAgICAgdGFnTmFtZXMuZGVsZXRlKG5hbWUpO1xuICAgICAgICByZXR1cm4gcmV0ID8/ICcnO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9XG5cbiAgaWYgKGVhdFRhZyhEb2NUYWcuU1RSVUNUKSAhPSBudWxsKSB7XG4gICAgaGludHMuc3RydWN0ID0gdHJ1ZTtcbiAgfVxuXG4gIGRvY3MuZGVmYXVsdCA9IGVhdFRhZyhEb2NUYWcuREVGQVVMVCwgRG9jVGFnLkRFRkFVTFRfVkFMVUUpO1xuICBkb2NzLmRlcHJlY2F0ZWQgPSBlYXRUYWcoRG9jVGFnLkRFUFJFQ0FURUQpO1xuICBkb2NzLmV4YW1wbGUgPSBlYXRUYWcoRG9jVGFnLkVYQU1QTEUpO1xuICBkb2NzLnJldHVybnMgPSBlYXRUYWcoRG9jVGFnLlJFVFVSTlMsIERvY1RhZy5SRVRVUk4pO1xuICBkb2NzLnNlZSA9IGVhdFRhZyhEb2NUYWcuU0VFKTtcbiAgZG9jcy5zdWJjbGFzc2FibGUgPVxuICAgIGVhdFRhZyhEb2NUYWcuU1VCQ0xBU1NBQkxFKSAhPT0gdW5kZWZpbmVkID8gdHJ1ZSA6IHVuZGVmaW5lZDtcblxuICBkb2NzLnN0YWJpbGl0eSA9IHBhcnNlU3RhYmlsaXR5KGVhdFRhZyhEb2NUYWcuU1RBQklMSVRZKSwgZGlhZ25vc3RpY3MpO1xuICAvLyAgQGV4cGVyaW1lbnRhbCBpcyBhIHNob3J0aGFuZCBmb3IgJ0BzdGFiaWxpdHkgZXhwZXJpbWVudGFsJywgc2FtZSBmb3IgJ0BzdGFibGUnXG4gIGNvbnN0IGV4cGVyaW1lbnRhbCA9IGVhdFRhZyhEb2NUYWcuRVhQRVJJTUVOVEFMKSAhPT0gdW5kZWZpbmVkO1xuICBjb25zdCBzdGFibGUgPSBlYXRUYWcoRG9jVGFnLlNUQUJMRSkgIT09IHVuZGVmaW5lZDtcbiAgLy8gQ2FuJ3QgY29tYmluZSB0aGVtXG4gIGlmIChjb3VudEJvb2xzKGRvY3Muc3RhYmlsaXR5ICE9PSB1bmRlZmluZWQsIGV4cGVyaW1lbnRhbCwgc3RhYmxlKSA+IDEpIHtcbiAgICBkaWFnbm9zdGljcy5wdXNoKCdVc2Ugb25seSBvbmUgb2YgQHN0YWJpbGl0eSwgQGV4cGVyaW1lbnRhbCBvciBAc3RhYmxlJyk7XG4gIH1cbiAgaWYgKGV4cGVyaW1lbnRhbCkge1xuICAgIGRvY3Muc3RhYmlsaXR5ID0gc3BlYy5TdGFiaWxpdHkuRXhwZXJpbWVudGFsO1xuICB9XG4gIGlmIChzdGFibGUpIHtcbiAgICBkb2NzLnN0YWJpbGl0eSA9IHNwZWMuU3RhYmlsaXR5LlN0YWJsZTtcbiAgfVxuXG4gIC8vIENhbiBjb21iaW5lICdAc3RhYmlsaXR5IGRlcHJlY2F0ZWQnIHdpdGggJ0BkZXByZWNhdGVkIDxyZWFzb24+J1xuICBpZiAoZG9jcy5kZXByZWNhdGVkICE9PSB1bmRlZmluZWQpIHtcbiAgICBpZiAoXG4gICAgICBkb2NzLnN0YWJpbGl0eSAhPT0gdW5kZWZpbmVkICYmXG4gICAgICBkb2NzLnN0YWJpbGl0eSAhPT0gc3BlYy5TdGFiaWxpdHkuRGVwcmVjYXRlZFxuICAgICkge1xuICAgICAgZGlhZ25vc3RpY3MucHVzaChcbiAgICAgICAgXCJAZGVwcmVjYXRlZCB0YWcgcmVxdWlyZXMgJ0BzdGFiaWxpdHkgZGVwcmVjYXRlZCcgb3Igbm8gQHN0YWJpbGl0eSBhdCBhbGwuXCIsXG4gICAgICApO1xuICAgIH1cbiAgICBkb2NzLnN0YWJpbGl0eSA9IHNwZWMuU3RhYmlsaXR5LkRlcHJlY2F0ZWQ7XG4gIH1cblxuICBpZiAoZG9jcy5leGFtcGxlPy5pbmNsdWRlcygnYGBgJykpIHtcbiAgICAvLyBUaGlzIGlzIGN1cnJlbnRseSB3aGF0IHRoZSBKU0RvYyBzdGFuZGFyZCBleHBlY3RzLCBhbmQgVlNDb2RlIGhpZ2hsaWdodHMgaXQgaW5cbiAgICAvLyB0aGlzIHdheSBhcyB3ZWxsLiBUU0RvYyBkaXNhZ3JlZXMgYW5kIHNheXMgdGhhdCBleGFtcGxlcyBzdGFydCBpbiB0ZXh0IG1vZGVcbiAgICAvLyB3aGljaCBJIHRlbmQgdG8gYWdyZWUgd2l0aCwgYnV0IHRoYXQgaGFzbid0IGJlY29tZSBhIHdpZGVseSB1c2VkIHN0YW5kYXJkIHlldC5cbiAgICAvL1xuICAgIC8vIFNvIHdlIGNvbmZvcm0gdG8gZXhpc3RpbmcgcmVhbGl0eS5cbiAgICBkaWFnbm9zdGljcy5wdXNoKFxuICAgICAgJ0BleGFtcGxlIG11c3QgYmUgY29kZSBvbmx5LCBubyBjb2RlIGJsb2NrIGZlbmNlcyBhbGxvd2VkLicsXG4gICAgKTtcbiAgfVxuXG4gIGlmIChkb2NzLmRlcHJlY2F0ZWQ/LnRyaW0oKSA9PT0gJycpIHtcbiAgICBkaWFnbm9zdGljcy5wdXNoKFxuICAgICAgJ0BkZXByZWNhdGVkIHRhZyBuZWVkcyBhIHJlYXNvbiBhbmQvb3Igc3VnZ2VzdGVkIGFsdGVybmF0aXZlcy4nLFxuICAgICk7XG4gIH1cblxuICBpZiAodGFnTmFtZXMuc2l6ZSA+IDApIHtcbiAgICBkb2NzLmN1c3RvbSA9IHt9O1xuICAgIGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIHRhZ05hbWVzLmVudHJpZXMoKSkge1xuICAgICAgZG9jcy5jdXN0b21ba2V5XSA9IHZhbHVlID8/ICd0cnVlJzsgLy8gS2V5IG11c3QgaGF2ZSBhIHZhbHVlIG9yIGl0IHdpbGwgYmUgc3RyaXBwZWQgZnJvbSB0aGUgYXNzZW1ibHlcbiAgICB9XG4gIH1cblxuICByZXR1cm4geyBkb2NzLCBkaWFnbm9zdGljcywgaGludHMgfTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBEb2NzUGFyc2luZ1Jlc3VsdCB7XG4gIGRvY3M6IHNwZWMuRG9jcztcbiAgaGludHM6IFR5cGVTeXN0ZW1IaW50cztcbiAgZGlhZ25vc3RpY3M/OiBzdHJpbmdbXTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBUeXBlU3lzdGVtSGludHMge1xuICAvKipcbiAgICogT25seSBwcmVzZW50IG9uIGludGVyZmFjZXMuIFRoaXMgaW5kaWNhdGVzIHRoYXQgaW50ZXJmYWNlIG11c3QgYmUgaGFuZGxlZCBhcyBhIHN0cnVjdC9kYXRhIHR5cGVcbiAgICogZXZlbiB0aHJvdWdoIGl0J3MgbmFtZSBzdGFydHMgd2l0aCBhIGNhcGl0YWwgbGV0dGVyIGBJYC5cbiAgICovXG4gIHN0cnVjdD86IGJvb2xlYW47XG59XG5cbi8qKlxuICogU3BsaXQgdGhlIGRvYyBjb21tZW50IGludG8gc3VtbWFyeSBhbmQgcmVtYXJrc1xuICpcbiAqIE5vcm1hbGx5LCB3ZSdkIGV4cGVjdCBwZW9wbGUgdG8gc3BsaXQgaW50byBhIHN1bW1hcnkgbGluZSBhbmQgZGV0YWlsIGxpbmVzIHVzaW5nIHBhcmFncmFwaFxuICogbWFya2Vycy4gSG93ZXZlciwgYSBMT1Qgb2YgcGVvcGxlIGRvIG5vdCBkbyB0aGlzLCBhbmQganVzdCBwYXN0ZSBhIGdpYW50IGNvbW1lbnQgYmxvY2sgaW50b1xuICogdGhlIGRvY3N0cmluZy4gSWYgd2UgZGV0ZWN0IHRoYXQgc2l0dWF0aW9uLCB3ZSB3aWxsIHRyeSBhbmQgZXh0cmFjdCB0aGUgZmlyc3Qgc2VudGVuY2UgKHVzaW5nXG4gKiBhIHBlcmlvZCkgYXMgdGhlIHN1bW1hcnkuXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBzcGxpdFN1bW1hcnkoXG4gIGRvY0Jsb2NrOiBzdHJpbmcgfCB1bmRlZmluZWQsXG4pOiBbc3RyaW5nIHwgdW5kZWZpbmVkLCBzdHJpbmcgfCB1bmRlZmluZWRdIHtcbiAgaWYgKCFkb2NCbG9jaykge1xuICAgIHJldHVybiBbdW5kZWZpbmVkLCB1bmRlZmluZWRdO1xuICB9XG4gIGNvbnN0IHN1bW1hcnkgPSBzdW1tYXJ5TGluZShkb2NCbG9jayk7XG4gIGNvbnN0IHJlbWFya3MgPSB1YmVyVHJpbShkb2NCbG9jay5zdWJzdHIoc3VtbWFyeS5sZW5ndGgpKTtcbiAgcmV0dXJuIFtlbmRXaXRoUGVyaW9kKG5vTmV3bGluZXMoc3VtbWFyeS50cmltKCkpKSwgcmVtYXJrc107XG59XG5cbi8qKlxuICogUmVwbGFjZSBuZXdsaW5lcyB3aXRoIHNwYWNlcyBmb3IgdXNlIGluIHRhYmxlc1xuICovXG5mdW5jdGlvbiBub05ld2xpbmVzKHM6IHN0cmluZykge1xuICByZXR1cm4gcy5yZXBsYWNlKC9cXG4vZywgJyAnKTtcbn1cblxuZnVuY3Rpb24gZW5kV2l0aFBlcmlvZChzOiBzdHJpbmcpIHtcbiAgcmV0dXJuIEVORFNfV0lUSF9QVU5DVFVBVElPTl9SRUdFWC50ZXN0KHMpID8gcyA6IGAke3N9LmA7XG59XG5cbi8qKlxuICogVHJpbXMgYSBzdHJpbmcgYW5kIHR1cm5zIGl0IGludG8gYHVuZGVmaW5lZGAgaWYgdGhlIHJlc3VsdCB3b3VsZCBoYXZlIGJlZW4gYW5cbiAqIGVtcHR5IHN0cmluZy5cbiAqL1xuZnVuY3Rpb24gdWJlclRyaW0oc3RyOiBzdHJpbmcpOiBzdHJpbmcgfCB1bmRlZmluZWQge1xuICBzdHIgPSBzdHIudHJpbSgpO1xuICByZXR1cm4gc3RyID09PSAnJyA/IHVuZGVmaW5lZCA6IHN0cjtcbn1cblxuY29uc3QgU1VNTUFSWV9NQVhfV09SRFMgPSAyMDtcblxuLyoqXG4gKiBGaW5kIHRoZSBzdW1tYXJ5IGxpbmUgZm9yIGEgZG9jIGNvbW1lbnRcbiAqXG4gKiBJbiBwcmluY2lwbGUgd2UnbGwgdGFrZSB0aGUgZmlyc3QgcGFyYWdyYXBoLCBidXQgaWYgdGhlcmUgYXJlIG5vIHBhcmFncmFwaHNcbiAqIChiZWNhdXNlIHBlb3BsZSBkb24ndCBwdXQgaW4gcGFyYWdyYXBoIGJyZWFrcykgb3IgdGhlIGZpcnN0IHBhcmFncmFwaCBpcyB0b29cbiAqIGxvbmcsIHdlJ2xsIHRha2UgdGhlIGZpcnN0IHNlbnRlbmNlICh0ZXJtaW5hdGVkIGJ5IGEgcHVuY3R1YXRpb24pLlxuICovXG5mdW5jdGlvbiBzdW1tYXJ5TGluZShzdHI6IHN0cmluZykge1xuICBjb25zdCBwYXJhcyA9IHN0ci5zcGxpdCgnXFxuXFxuJyk7XG4gIGlmIChwYXJhcy5sZW5ndGggPiAxICYmIHBhcmFzWzBdLnNwbGl0KCcgJykubGVuZ3RoIDwgU1VNTUFSWV9NQVhfV09SRFMpIHtcbiAgICByZXR1cm4gcGFyYXNbMF07XG4gIH1cblxuICBjb25zdCBtID0gRklSU1RfU0VOVEVOQ0VfUkVHRVguZXhlYyhzdHIpO1xuICBpZiAobSkge1xuICAgIHJldHVybiBtWzFdO1xuICB9XG5cbiAgcmV0dXJuIHBhcmFzWzBdO1xufVxuXG5jb25zdCBQVU5DVFVBVElPTiA9IFsnIScsICc/JywgJy4nLCAnOyddLm1hcCgocykgPT4gYFxcXFwke3N9YCkuam9pbignJyk7XG5jb25zdCBFTkRTX1dJVEhfUFVOQ1RVQVRJT05fUkVHRVggPSBuZXcgUmVnRXhwKGBbJHtQVU5DVFVBVElPTn1dJGApO1xuY29uc3QgRklSU1RfU0VOVEVOQ0VfUkVHRVggPSBuZXcgUmVnRXhwKFxuICBgXihbXiR7UFVOQ1RVQVRJT059XStbJHtQVU5DVFVBVElPTn1dWyBcXG5cXHJdKWAsXG4pOyAvLyBOZWVkcyBhIHdoaXRlc3BhY2UgYWZ0ZXIgdGhlIHB1bmN0dWF0aW9uLlxuXG5mdW5jdGlvbiBpbnRCb29sKHg6IGJvb2xlYW4pOiBudW1iZXIge1xuICByZXR1cm4geCA/IDEgOiAwO1xufVxuXG5mdW5jdGlvbiBjb3VudEJvb2xzKC4uLng6IGJvb2xlYW5bXSkge1xuICByZXR1cm4geC5tYXAoaW50Qm9vbCkucmVkdWNlKChhLCBiKSA9PiBhICsgYiwgMCk7XG59XG5cbmZ1bmN0aW9uIHBhcnNlU3RhYmlsaXR5KFxuICBzOiBzdHJpbmcgfCB1bmRlZmluZWQsXG4gIGRpYWdub3N0aWNzOiBzdHJpbmdbXSxcbik6IHNwZWMuU3RhYmlsaXR5IHwgdW5kZWZpbmVkIHtcbiAgaWYgKHMgPT09IHVuZGVmaW5lZCkge1xuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH1cblxuICBzd2l0Y2ggKHMpIHtcbiAgICBjYXNlICdzdGFibGUnOlxuICAgICAgcmV0dXJuIHNwZWMuU3RhYmlsaXR5LlN0YWJsZTtcbiAgICBjYXNlICdleHBlcmltZW50YWwnOlxuICAgICAgcmV0dXJuIHNwZWMuU3RhYmlsaXR5LkV4cGVyaW1lbnRhbDtcbiAgICBjYXNlICdleHRlcm5hbCc6XG4gICAgICByZXR1cm4gc3BlYy5TdGFiaWxpdHkuRXh0ZXJuYWw7XG4gICAgY2FzZSAnZGVwcmVjYXRlZCc6XG4gICAgICByZXR1cm4gc3BlYy5TdGFiaWxpdHkuRGVwcmVjYXRlZDtcbiAgfVxuICBkaWFnbm9zdGljcy5wdXNoKGBVbnJlY29nbml6ZWQgQHN0YWJpbGl0eTogJyR7c30nYCk7XG4gIHJldHVybiB1bmRlZmluZWQ7XG59XG5cbi8qKlxuICogVW5yZWNvZ25pemVkIHRhZ3MgdGhhdCBmb2xsb3cgYW4gJ0AgZXhhbXBsZScgdGFnIHdpbGwgYmUgYWJzb3JiZWQgYmFjayBpbnRvIHRoZSBleGFtcGxlIHZhbHVlXG4gKlxuICogVGhlIFR5cGVTY3JpcHQgcGFyc2VyIGJ5IGl0c2VsZiBpcyBuYWl2ZSBhbmQgd2lsbCBzdGFydCBwYXJzaW5nIGEgbmV3IHRhZyB0aGVyZS5cbiAqXG4gKiBXZSBkbyB0aGlzIHVudGlsIHdlIGVuY291bnRlciBhIHN1cHBvcnRlZCBAIGtleXdvcmQuXG4gKi9cbmZ1bmN0aW9uIHJlYWJzb3JiRXhhbXBsZVRhZ3ModGFnczogdHMuSlNEb2NUYWdJbmZvW10pOiB0cy5KU0RvY1RhZ0luZm9bXSB7XG4gIGNvbnN0IHJlY29nbml6ZWRUYWdzOiBzdHJpbmdbXSA9IE9iamVjdC52YWx1ZXMoRG9jVGFnKTtcbiAgY29uc3QgcmV0ID0gWy4uLnRhZ3NdO1xuXG4gIGxldCBpID0gMDtcbiAgd2hpbGUgKGkgPCByZXQubGVuZ3RoKSB7XG4gICAgaWYgKHJldFtpXS5uYW1lID09PSAnZXhhbXBsZScpIHtcbiAgICAgIHdoaWxlIChpICsgMSA8IHJldC5sZW5ndGggJiYgIXJlY29nbml6ZWRUYWdzLmluY2x1ZGVzKHJldFtpICsgMV0ubmFtZSkpIHtcbiAgICAgICAgLy8gSW5jb3JyZWN0bHkgY2xhc3NpZmllZCBhcyBAdGFnLCBhYnNvcmIgYmFjayBpbnRvIGV4YW1wbGVcbiAgICAgICAgcmV0W2ldLnRleHQgKz0gYEAke3JldFtpICsgMV0ubmFtZX0ke3JldFtpICsgMV0udGV4dH1gO1xuICAgICAgICByZXQuc3BsaWNlKGkgKyAxLCAxKTtcbiAgICAgIH1cbiAgICB9XG4gICAgaSsrO1xuICB9XG5cbiAgcmV0dXJuIHJldDtcbn1cbiJdfQ==