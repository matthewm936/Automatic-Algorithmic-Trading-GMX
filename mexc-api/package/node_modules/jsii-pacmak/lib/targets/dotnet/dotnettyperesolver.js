"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.DotNetTypeResolver = void 0;
const spec = require("@jsii/spec");
const codemaker_1 = require("codemaker");
const filegenerator_1 = require("./filegenerator");
const nameutils_1 = require("./nameutils");
class DotNetTypeResolver {
    constructor(assembly, findModule, findType, assembliesCurrentlyBeingCompiled) {
        this.assembliesCurrentlyBeingCompiled = assembliesCurrentlyBeingCompiled;
        // The dependency tree for the current jsii input model.
        // This is later used to output the csproj
        this.namespaceDependencies = new Map();
        this.nameutils = new nameutils_1.DotNetNameUtils();
        this.assembly = assembly;
        this.findModule = findModule;
        this.findType = findType;
    }
    /**
     * Translates a type fqn to a native .NET full type
     */
    toNativeFqn(fqn) {
        var _a, _b, _c;
        const type = this.findType(fqn);
        let typeName = '';
        switch (type.kind) {
            case spec.TypeKind.Interface:
                typeName = this.nameutils.convertInterfaceName(type);
                break;
            case spec.TypeKind.Class:
                typeName = this.nameutils.convertClassName(type);
                break;
            case spec.TypeKind.Enum:
                typeName = this.nameutils.convertTypeName(type.name);
                break;
            default:
                throw new Error(`Unknown type: ${type}`);
        }
        const [mod] = fqn.split('.');
        const depMod = this.findModule(mod);
        const dotnetNamespace = (_b = (_a = depMod.targets) === null || _a === void 0 ? void 0 : _a.dotnet) === null || _b === void 0 ? void 0 : _b.namespace;
        if (!dotnetNamespace) {
            throw new Error(`The assembly ${mod} does not have a dotnet.namespace setting`);
        }
        if (type.namespace) {
            // If the type is declared in an additional namespace.
            const namespaceFqn = `${this.assembly.name}.${type.namespace}`;
            const associatedNamespace = (_c = this.assembly.types) === null || _c === void 0 ? void 0 : _c[namespaceFqn];
            if (associatedNamespace) {
                // Checking if there is a C# type associated with this namespace, in case we need to slugify it
                const actualNamespace = this.toDotNetType(this.findType(namespaceFqn));
                return `${actualNamespace}.${typeName}`;
            }
            const ns = this.resolveNamespace(depMod, mod, type.namespace);
            return `${ns}.${typeName}`;
        }
        // When undefined, the type is located at the root of the assembly
        return `${dotnetNamespace}.${typeName}`;
    }
    /**
     * Resolves the namespaces dependencies by looking at the .jsii model
     */
    resolveNamespacesDependencies() {
        var _a, _b;
        const assmDependencies = (_a = this.assembly.dependencies) !== null && _a !== void 0 ? _a : {};
        const assmConfigurations = (_b = this.assembly.dependencyClosure) !== null && _b !== void 0 ? _b : {};
        for (const [depName, version] of Object.entries(assmDependencies)) {
            const depInfo = assmConfigurations[depName];
            if (!this.namespaceDependencies.has(depName)) {
                const dotnetInfo = depInfo.targets.dotnet;
                const namespace = dotnetInfo.namespace;
                const packageId = dotnetInfo.packageId;
                const suffix = depInfo.targets.dotnet.versionSuffix;
                this.namespaceDependencies.set(depName, new filegenerator_1.DotNetDependency(namespace, packageId, depName, 
                // suffix, when present, is guaranteed to start with a leading `-`
                suffix ? `${version}${suffix}` : version, this.assembliesCurrentlyBeingCompiled.includes(depName)));
            }
        }
    }
    /**
     * Loops through the implemented interfaces and returns the fully qualified .NET types of the interfaces
     *
     */
    resolveImplementedInterfaces(ifc) {
        var _a;
        const interfaces = (_a = ifc.interfaces) !== null && _a !== void 0 ? _a : [];
        const baseTypeNames = [];
        // For all base members
        for (const base of interfaces) {
            const interfaceFullType = this.toNativeFqn(base);
            baseTypeNames.push(interfaceFullType);
        }
        return baseTypeNames;
    }
    /**
     * Translates any jsii type to its corresponding .NET type
     */
    toDotNetType(typeref) {
        if (spec.isPrimitiveTypeReference(typeref)) {
            return this.toDotNetPrimitive(typeref.primitive);
        }
        else if (spec.isCollectionTypeReference(typeref)) {
            return this.toDotNetCollection(typeref);
        }
        else if (spec.isNamedTypeReference(typeref)) {
            return this.toNativeFqn(typeref.fqn);
        }
        else if (typeref.union) {
            return 'object';
        }
        throw new Error(`Invalid type reference: ${JSON.stringify(typeref)}`);
    }
    resolveNamespace(assm, assmName, ns) {
        var _a, _b, _c, _d, _e;
        let resolved = (_b = (_a = assm.targets) === null || _a === void 0 ? void 0 : _a.dotnet) === null || _b === void 0 ? void 0 : _b.namespace;
        if (!resolved) {
            throw new Error(`Assembly ${assmName} does not have targets.dotnet.namespace configured!`);
        }
        const segments = ns.split('.');
        for (let i = 0; i < segments.length; i++) {
            const submoduleName = `${assmName}.${segments.slice(0, i + 1).join('.')}`;
            const submodule = (_c = assm.submodules) === null || _c === void 0 ? void 0 : _c[submoduleName];
            if (submodule && ((_e = (_d = submodule.targets) === null || _d === void 0 ? void 0 : _d.dotnet) === null || _e === void 0 ? void 0 : _e.namespace)) {
                resolved = submodule.targets.dotnet.namespace;
            }
            else {
                resolved = `${resolved}.${codemaker_1.toPascalCase(segments[i])}`;
            }
        }
        return resolved;
    }
    /**
     * Translates a primitive in jsii to a native .NET primitive
     */
    toDotNetPrimitive(primitive) {
        switch (primitive) {
            case spec.PrimitiveType.Boolean:
                return 'bool';
            case spec.PrimitiveType.Date:
                return 'System.DateTime';
            case spec.PrimitiveType.Json:
                return 'Newtonsoft.Json.Linq.JObject';
            case spec.PrimitiveType.Number:
                return 'double';
            case spec.PrimitiveType.String:
                return 'string';
            case spec.PrimitiveType.Any:
                return 'object';
            default:
                throw new Error(`Unknown primitive type: ${primitive}`);
        }
    }
    /**
     * Translates a collection in jsii to a native .NET collection
     */
    toDotNetCollection(ref) {
        const elementDotNetType = this.toDotNetType(ref.collection.elementtype);
        switch (ref.collection.kind) {
            case spec.CollectionKind.Array:
                return `${elementDotNetType}[]`;
            case spec.CollectionKind.Map:
                return `System.Collections.Generic.IDictionary<string, ${elementDotNetType}>`;
            default:
                throw new Error(`Unsupported collection kind: ${ref.collection.kind}`);
        }
    }
}
exports.DotNetTypeResolver = DotNetTypeResolver;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZG90bmV0dHlwZXJlc29sdmVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiZG90bmV0dHlwZXJlc29sdmVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLG1DQUFtQztBQUNuQyx5Q0FBeUM7QUFFekMsbURBQW1EO0FBQ25ELDJDQUE4QztBQUs5QyxNQUFhLGtCQUFrQjtJQWE3QixZQUNFLFFBQXVCLEVBQ3ZCLFVBQThCLEVBQzlCLFFBQTBCLEVBQ1QsZ0NBQTBDO1FBQTFDLHFDQUFnQyxHQUFoQyxnQ0FBZ0MsQ0FBVTtRQWhCN0Qsd0RBQXdEO1FBQ3hELDBDQUEwQztRQUNuQywwQkFBcUIsR0FBa0MsSUFBSSxHQUFHLEVBR2xFLENBQUM7UUFLYSxjQUFTLEdBQW9CLElBQUksMkJBQWUsRUFBRSxDQUFDO1FBUWxFLElBQUksQ0FBQyxRQUFRLEdBQUcsUUFBUSxDQUFDO1FBQ3pCLElBQUksQ0FBQyxVQUFVLEdBQUcsVUFBVSxDQUFDO1FBQzdCLElBQUksQ0FBQyxRQUFRLEdBQUcsUUFBUSxDQUFDO0lBQzNCLENBQUM7SUFFRDs7T0FFRztJQUNJLFdBQVcsQ0FBQyxHQUFXOztRQUM1QixNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ2hDLElBQUksUUFBUSxHQUFHLEVBQUUsQ0FBQztRQUNsQixRQUFRLElBQUksQ0FBQyxJQUFJLEVBQUU7WUFDakIsS0FBSyxJQUFJLENBQUMsUUFBUSxDQUFDLFNBQVM7Z0JBQzFCLFFBQVEsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLG9CQUFvQixDQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNyRCxNQUFNO1lBQ1IsS0FBSyxJQUFJLENBQUMsUUFBUSxDQUFDLEtBQUs7Z0JBQ3RCLFFBQVEsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLGdCQUFnQixDQUFDLElBQXNCLENBQUMsQ0FBQztnQkFDbkUsTUFBTTtZQUNSLEtBQUssSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJO2dCQUNyQixRQUFRLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNyRCxNQUFNO1lBQ1I7Z0JBQ0UsTUFBTSxJQUFJLEtBQUssQ0FBQyxpQkFBaUIsSUFBVyxFQUFFLENBQUMsQ0FBQztTQUNuRDtRQUNELE1BQU0sQ0FBQyxHQUFHLENBQUMsR0FBRyxHQUFHLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQzdCLE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLENBQUM7UUFFcEMsTUFBTSxlQUFlLGVBQUcsTUFBTSxDQUFDLE9BQU8sMENBQUUsTUFBTSwwQ0FBRSxTQUFTLENBQUM7UUFDMUQsSUFBSSxDQUFDLGVBQWUsRUFBRTtZQUNwQixNQUFNLElBQUksS0FBSyxDQUNiLGdCQUFnQixHQUFHLDJDQUEyQyxDQUMvRCxDQUFDO1NBQ0g7UUFDRCxJQUFJLElBQUksQ0FBQyxTQUFTLEVBQUU7WUFDbEIsc0RBQXNEO1lBQ3RELE1BQU0sWUFBWSxHQUFHLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLElBQUksSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFDO1lBQy9ELE1BQU0sbUJBQW1CLFNBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLDBDQUFHLFlBQVksQ0FBQyxDQUFDO1lBQ2hFLElBQUksbUJBQW1CLEVBQUU7Z0JBQ3ZCLCtGQUErRjtnQkFDL0YsTUFBTSxlQUFlLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUM7Z0JBQ3ZFLE9BQU8sR0FBRyxlQUFlLElBQUksUUFBUSxFQUFFLENBQUM7YUFDekM7WUFDRCxNQUFNLEVBQUUsR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxFQUFFLEdBQUcsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7WUFDOUQsT0FBTyxHQUFHLEVBQUUsSUFBSSxRQUFRLEVBQUUsQ0FBQztTQUM1QjtRQUNELGtFQUFrRTtRQUNsRSxPQUFPLEdBQUcsZUFBZSxJQUFJLFFBQVEsRUFBRSxDQUFDO0lBQzFDLENBQUM7SUFFRDs7T0FFRztJQUNJLDZCQUE2Qjs7UUFDbEMsTUFBTSxnQkFBZ0IsU0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLFlBQVksbUNBQUksRUFBRSxDQUFDO1FBQzFELE1BQU0sa0JBQWtCLFNBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxpQkFBaUIsbUNBQUksRUFBRSxDQUFDO1FBQ2pFLEtBQUssTUFBTSxDQUFDLE9BQU8sRUFBRSxPQUFPLENBQUMsSUFBSSxNQUFNLENBQUMsT0FBTyxDQUFDLGdCQUFnQixDQUFDLEVBQUU7WUFDakUsTUFBTSxPQUFPLEdBQUcsa0JBQWtCLENBQUMsT0FBTyxDQUFDLENBQUM7WUFDNUMsSUFBSSxDQUFDLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLEVBQUU7Z0JBQzVDLE1BQU0sVUFBVSxHQUFHLE9BQU8sQ0FBQyxPQUFRLENBQUMsTUFBTyxDQUFDO2dCQUM1QyxNQUFNLFNBQVMsR0FBRyxVQUFVLENBQUMsU0FBUyxDQUFDO2dCQUN2QyxNQUFNLFNBQVMsR0FBRyxVQUFVLENBQUMsU0FBUyxDQUFDO2dCQUN2QyxNQUFNLE1BQU0sR0FBRyxPQUFPLENBQUMsT0FBUSxDQUFDLE1BQU8sQ0FBQyxhQUFhLENBQUM7Z0JBRXRELElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxHQUFHLENBQzVCLE9BQU8sRUFDUCxJQUFJLGdDQUFnQixDQUNsQixTQUFTLEVBQ1QsU0FBUyxFQUNULE9BQU87Z0JBQ1Asa0VBQWtFO2dCQUNsRSxNQUFNLENBQUMsQ0FBQyxDQUFDLEdBQUcsT0FBTyxHQUFHLE1BQU0sRUFBRSxDQUFDLENBQUMsQ0FBQyxPQUFPLEVBQ3hDLElBQUksQ0FBQyxnQ0FBZ0MsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLENBQ3hELENBQ0YsQ0FBQzthQUNIO1NBQ0Y7SUFDSCxDQUFDO0lBRUQ7OztPQUdHO0lBQ0ksNEJBQTRCLENBQ2pDLEdBQXdDOztRQUV4QyxNQUFNLFVBQVUsU0FBRyxHQUFHLENBQUMsVUFBVSxtQ0FBSSxFQUFFLENBQUM7UUFDeEMsTUFBTSxhQUFhLEdBQWEsRUFBRSxDQUFDO1FBRW5DLHVCQUF1QjtRQUN2QixLQUFLLE1BQU0sSUFBSSxJQUFJLFVBQVUsRUFBRTtZQUM3QixNQUFNLGlCQUFpQixHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDakQsYUFBYSxDQUFDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO1NBQ3ZDO1FBQ0QsT0FBTyxhQUFhLENBQUM7SUFDdkIsQ0FBQztJQUVEOztPQUVHO0lBQ0ksWUFBWSxDQUFDLE9BQTJCO1FBQzdDLElBQUksSUFBSSxDQUFDLHdCQUF3QixDQUFDLE9BQU8sQ0FBQyxFQUFFO1lBQzFDLE9BQU8sSUFBSSxDQUFDLGlCQUFpQixDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQztTQUNsRDthQUFNLElBQUksSUFBSSxDQUFDLHlCQUF5QixDQUFDLE9BQU8sQ0FBQyxFQUFFO1lBQ2xELE9BQU8sSUFBSSxDQUFDLGtCQUFrQixDQUFDLE9BQU8sQ0FBQyxDQUFDO1NBQ3pDO2FBQU0sSUFBSSxJQUFJLENBQUMsb0JBQW9CLENBQUMsT0FBTyxDQUFDLEVBQUU7WUFDN0MsT0FBTyxJQUFJLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQztTQUN0QzthQUFNLElBQUksT0FBTyxDQUFDLEtBQUssRUFBRTtZQUN4QixPQUFPLFFBQVEsQ0FBQztTQUNqQjtRQUNELE1BQU0sSUFBSSxLQUFLLENBQUMsMkJBQTJCLElBQUksQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxDQUFDO0lBQ3hFLENBQUM7SUFFTSxnQkFBZ0IsQ0FDckIsSUFBZ0MsRUFDaEMsUUFBZ0IsRUFDaEIsRUFBVTs7UUFFVixJQUFJLFFBQVEsZUFBRyxJQUFJLENBQUMsT0FBTywwQ0FBRSxNQUFNLDBDQUFFLFNBQVMsQ0FBQztRQUMvQyxJQUFJLENBQUMsUUFBUSxFQUFFO1lBQ2IsTUFBTSxJQUFJLEtBQUssQ0FDYixZQUFZLFFBQVEscURBQXFELENBQzFFLENBQUM7U0FDSDtRQUNELE1BQU0sUUFBUSxHQUFHLEVBQUUsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDL0IsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLFFBQVEsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUU7WUFDeEMsTUFBTSxhQUFhLEdBQUcsR0FBRyxRQUFRLElBQUksUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDO1lBQzFFLE1BQU0sU0FBUyxTQUFHLElBQUksQ0FBQyxVQUFVLDBDQUFHLGFBQWEsQ0FBQyxDQUFDO1lBQ25ELElBQUksU0FBUyxpQkFBSSxTQUFTLENBQUMsT0FBTywwQ0FBRSxNQUFNLDBDQUFFLFNBQVMsQ0FBQSxFQUFFO2dCQUNyRCxRQUFRLEdBQUcsU0FBUyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDO2FBQy9DO2lCQUFNO2dCQUNMLFFBQVEsR0FBRyxHQUFHLFFBQVEsSUFBSSx3QkFBWSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7YUFDdkQ7U0FDRjtRQUNELE9BQU8sUUFBUSxDQUFDO0lBQ2xCLENBQUM7SUFFRDs7T0FFRztJQUNLLGlCQUFpQixDQUFDLFNBQTZCO1FBQ3JELFFBQVEsU0FBUyxFQUFFO1lBQ2pCLEtBQUssSUFBSSxDQUFDLGFBQWEsQ0FBQyxPQUFPO2dCQUM3QixPQUFPLE1BQU0sQ0FBQztZQUNoQixLQUFLLElBQUksQ0FBQyxhQUFhLENBQUMsSUFBSTtnQkFDMUIsT0FBTyxpQkFBaUIsQ0FBQztZQUMzQixLQUFLLElBQUksQ0FBQyxhQUFhLENBQUMsSUFBSTtnQkFDMUIsT0FBTyw4QkFBOEIsQ0FBQztZQUN4QyxLQUFLLElBQUksQ0FBQyxhQUFhLENBQUMsTUFBTTtnQkFDNUIsT0FBTyxRQUFRLENBQUM7WUFDbEIsS0FBSyxJQUFJLENBQUMsYUFBYSxDQUFDLE1BQU07Z0JBQzVCLE9BQU8sUUFBUSxDQUFDO1lBQ2xCLEtBQUssSUFBSSxDQUFDLGFBQWEsQ0FBQyxHQUFHO2dCQUN6QixPQUFPLFFBQVEsQ0FBQztZQUNsQjtnQkFDRSxNQUFNLElBQUksS0FBSyxDQUFDLDJCQUEyQixTQUFnQixFQUFFLENBQUMsQ0FBQztTQUNsRTtJQUNILENBQUM7SUFFRDs7T0FFRztJQUNLLGtCQUFrQixDQUFDLEdBQWlDO1FBQzFELE1BQU0saUJBQWlCLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQ3hFLFFBQVEsR0FBRyxDQUFDLFVBQVUsQ0FBQyxJQUFJLEVBQUU7WUFDM0IsS0FBSyxJQUFJLENBQUMsY0FBYyxDQUFDLEtBQUs7Z0JBQzVCLE9BQU8sR0FBRyxpQkFBaUIsSUFBSSxDQUFDO1lBQ2xDLEtBQUssSUFBSSxDQUFDLGNBQWMsQ0FBQyxHQUFHO2dCQUMxQixPQUFPLGtEQUFrRCxpQkFBaUIsR0FBRyxDQUFDO1lBQ2hGO2dCQUNFLE1BQU0sSUFBSSxLQUFLLENBQ2IsZ0NBQWdDLEdBQUcsQ0FBQyxVQUFVLENBQUMsSUFBVyxFQUFFLENBQzdELENBQUM7U0FDTDtJQUNILENBQUM7Q0FDRjtBQWpNRCxnREFpTUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBzcGVjIGZyb20gJ0Bqc2lpL3NwZWMnO1xuaW1wb3J0IHsgdG9QYXNjYWxDYXNlIH0gZnJvbSAnY29kZW1ha2VyJztcblxuaW1wb3J0IHsgRG90TmV0RGVwZW5kZW5jeSB9IGZyb20gJy4vZmlsZWdlbmVyYXRvcic7XG5pbXBvcnQgeyBEb3ROZXROYW1lVXRpbHMgfSBmcm9tICcuL25hbWV1dGlscyc7XG5cbnR5cGUgRmluZE1vZHVsZUNhbGxiYWNrID0gKGZxbjogc3RyaW5nKSA9PiBzcGVjLkFzc2VtYmx5Q29uZmlndXJhdGlvbjtcbnR5cGUgRmluZFR5cGVDYWxsYmFjayA9IChmcW46IHN0cmluZykgPT4gc3BlYy5UeXBlO1xuXG5leHBvcnQgY2xhc3MgRG90TmV0VHlwZVJlc29sdmVyIHtcbiAgLy8gVGhlIGRlcGVuZGVuY3kgdHJlZSBmb3IgdGhlIGN1cnJlbnQganNpaSBpbnB1dCBtb2RlbC5cbiAgLy8gVGhpcyBpcyBsYXRlciB1c2VkIHRvIG91dHB1dCB0aGUgY3Nwcm9qXG4gIHB1YmxpYyBuYW1lc3BhY2VEZXBlbmRlbmNpZXM6IE1hcDxzdHJpbmcsIERvdE5ldERlcGVuZGVuY3k+ID0gbmV3IE1hcDxcbiAgICBzdHJpbmcsXG4gICAgRG90TmV0RGVwZW5kZW5jeVxuICA+KCk7XG5cbiAgcHJpdmF0ZSByZWFkb25seSBmaW5kTW9kdWxlOiBGaW5kTW9kdWxlQ2FsbGJhY2s7XG4gIHByaXZhdGUgcmVhZG9ubHkgZmluZFR5cGU6IEZpbmRUeXBlQ2FsbGJhY2s7XG4gIHByaXZhdGUgcmVhZG9ubHkgYXNzZW1ibHk6IHNwZWMuQXNzZW1ibHk7XG4gIHByaXZhdGUgcmVhZG9ubHkgbmFtZXV0aWxzOiBEb3ROZXROYW1lVXRpbHMgPSBuZXcgRG90TmV0TmFtZVV0aWxzKCk7XG5cbiAgcHVibGljIGNvbnN0cnVjdG9yKFxuICAgIGFzc2VtYmx5OiBzcGVjLkFzc2VtYmx5LFxuICAgIGZpbmRNb2R1bGU6IEZpbmRNb2R1bGVDYWxsYmFjayxcbiAgICBmaW5kVHlwZTogRmluZFR5cGVDYWxsYmFjayxcbiAgICBwcml2YXRlIHJlYWRvbmx5IGFzc2VtYmxpZXNDdXJyZW50bHlCZWluZ0NvbXBpbGVkOiBzdHJpbmdbXSxcbiAgKSB7XG4gICAgdGhpcy5hc3NlbWJseSA9IGFzc2VtYmx5O1xuICAgIHRoaXMuZmluZE1vZHVsZSA9IGZpbmRNb2R1bGU7XG4gICAgdGhpcy5maW5kVHlwZSA9IGZpbmRUeXBlO1xuICB9XG5cbiAgLyoqXG4gICAqIFRyYW5zbGF0ZXMgYSB0eXBlIGZxbiB0byBhIG5hdGl2ZSAuTkVUIGZ1bGwgdHlwZVxuICAgKi9cbiAgcHVibGljIHRvTmF0aXZlRnFuKGZxbjogc3RyaW5nKTogc3RyaW5nIHtcbiAgICBjb25zdCB0eXBlID0gdGhpcy5maW5kVHlwZShmcW4pO1xuICAgIGxldCB0eXBlTmFtZSA9ICcnO1xuICAgIHN3aXRjaCAodHlwZS5raW5kKSB7XG4gICAgICBjYXNlIHNwZWMuVHlwZUtpbmQuSW50ZXJmYWNlOlxuICAgICAgICB0eXBlTmFtZSA9IHRoaXMubmFtZXV0aWxzLmNvbnZlcnRJbnRlcmZhY2VOYW1lKHR5cGUpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2Ugc3BlYy5UeXBlS2luZC5DbGFzczpcbiAgICAgICAgdHlwZU5hbWUgPSB0aGlzLm5hbWV1dGlscy5jb252ZXJ0Q2xhc3NOYW1lKHR5cGUgYXMgc3BlYy5DbGFzc1R5cGUpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2Ugc3BlYy5UeXBlS2luZC5FbnVtOlxuICAgICAgICB0eXBlTmFtZSA9IHRoaXMubmFtZXV0aWxzLmNvbnZlcnRUeXBlTmFtZSh0eXBlLm5hbWUpO1xuICAgICAgICBicmVhaztcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgVW5rbm93biB0eXBlOiAke3R5cGUgYXMgYW55fWApO1xuICAgIH1cbiAgICBjb25zdCBbbW9kXSA9IGZxbi5zcGxpdCgnLicpO1xuICAgIGNvbnN0IGRlcE1vZCA9IHRoaXMuZmluZE1vZHVsZShtb2QpO1xuXG4gICAgY29uc3QgZG90bmV0TmFtZXNwYWNlID0gZGVwTW9kLnRhcmdldHM/LmRvdG5ldD8ubmFtZXNwYWNlO1xuICAgIGlmICghZG90bmV0TmFtZXNwYWNlKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBUaGUgYXNzZW1ibHkgJHttb2R9IGRvZXMgbm90IGhhdmUgYSBkb3RuZXQubmFtZXNwYWNlIHNldHRpbmdgLFxuICAgICAgKTtcbiAgICB9XG4gICAgaWYgKHR5cGUubmFtZXNwYWNlKSB7XG4gICAgICAvLyBJZiB0aGUgdHlwZSBpcyBkZWNsYXJlZCBpbiBhbiBhZGRpdGlvbmFsIG5hbWVzcGFjZS5cbiAgICAgIGNvbnN0IG5hbWVzcGFjZUZxbiA9IGAke3RoaXMuYXNzZW1ibHkubmFtZX0uJHt0eXBlLm5hbWVzcGFjZX1gO1xuICAgICAgY29uc3QgYXNzb2NpYXRlZE5hbWVzcGFjZSA9IHRoaXMuYXNzZW1ibHkudHlwZXM/LltuYW1lc3BhY2VGcW5dO1xuICAgICAgaWYgKGFzc29jaWF0ZWROYW1lc3BhY2UpIHtcbiAgICAgICAgLy8gQ2hlY2tpbmcgaWYgdGhlcmUgaXMgYSBDIyB0eXBlIGFzc29jaWF0ZWQgd2l0aCB0aGlzIG5hbWVzcGFjZSwgaW4gY2FzZSB3ZSBuZWVkIHRvIHNsdWdpZnkgaXRcbiAgICAgICAgY29uc3QgYWN0dWFsTmFtZXNwYWNlID0gdGhpcy50b0RvdE5ldFR5cGUodGhpcy5maW5kVHlwZShuYW1lc3BhY2VGcW4pKTtcbiAgICAgICAgcmV0dXJuIGAke2FjdHVhbE5hbWVzcGFjZX0uJHt0eXBlTmFtZX1gO1xuICAgICAgfVxuICAgICAgY29uc3QgbnMgPSB0aGlzLnJlc29sdmVOYW1lc3BhY2UoZGVwTW9kLCBtb2QsIHR5cGUubmFtZXNwYWNlKTtcbiAgICAgIHJldHVybiBgJHtuc30uJHt0eXBlTmFtZX1gO1xuICAgIH1cbiAgICAvLyBXaGVuIHVuZGVmaW5lZCwgdGhlIHR5cGUgaXMgbG9jYXRlZCBhdCB0aGUgcm9vdCBvZiB0aGUgYXNzZW1ibHlcbiAgICByZXR1cm4gYCR7ZG90bmV0TmFtZXNwYWNlfS4ke3R5cGVOYW1lfWA7XG4gIH1cblxuICAvKipcbiAgICogUmVzb2x2ZXMgdGhlIG5hbWVzcGFjZXMgZGVwZW5kZW5jaWVzIGJ5IGxvb2tpbmcgYXQgdGhlIC5qc2lpIG1vZGVsXG4gICAqL1xuICBwdWJsaWMgcmVzb2x2ZU5hbWVzcGFjZXNEZXBlbmRlbmNpZXMoKTogdm9pZCB7XG4gICAgY29uc3QgYXNzbURlcGVuZGVuY2llcyA9IHRoaXMuYXNzZW1ibHkuZGVwZW5kZW5jaWVzID8/IHt9O1xuICAgIGNvbnN0IGFzc21Db25maWd1cmF0aW9ucyA9IHRoaXMuYXNzZW1ibHkuZGVwZW5kZW5jeUNsb3N1cmUgPz8ge307XG4gICAgZm9yIChjb25zdCBbZGVwTmFtZSwgdmVyc2lvbl0gb2YgT2JqZWN0LmVudHJpZXMoYXNzbURlcGVuZGVuY2llcykpIHtcbiAgICAgIGNvbnN0IGRlcEluZm8gPSBhc3NtQ29uZmlndXJhdGlvbnNbZGVwTmFtZV07XG4gICAgICBpZiAoIXRoaXMubmFtZXNwYWNlRGVwZW5kZW5jaWVzLmhhcyhkZXBOYW1lKSkge1xuICAgICAgICBjb25zdCBkb3RuZXRJbmZvID0gZGVwSW5mby50YXJnZXRzIS5kb3RuZXQhO1xuICAgICAgICBjb25zdCBuYW1lc3BhY2UgPSBkb3RuZXRJbmZvLm5hbWVzcGFjZTtcbiAgICAgICAgY29uc3QgcGFja2FnZUlkID0gZG90bmV0SW5mby5wYWNrYWdlSWQ7XG4gICAgICAgIGNvbnN0IHN1ZmZpeCA9IGRlcEluZm8udGFyZ2V0cyEuZG90bmV0IS52ZXJzaW9uU3VmZml4O1xuXG4gICAgICAgIHRoaXMubmFtZXNwYWNlRGVwZW5kZW5jaWVzLnNldChcbiAgICAgICAgICBkZXBOYW1lLFxuICAgICAgICAgIG5ldyBEb3ROZXREZXBlbmRlbmN5KFxuICAgICAgICAgICAgbmFtZXNwYWNlLFxuICAgICAgICAgICAgcGFja2FnZUlkLFxuICAgICAgICAgICAgZGVwTmFtZSxcbiAgICAgICAgICAgIC8vIHN1ZmZpeCwgd2hlbiBwcmVzZW50LCBpcyBndWFyYW50ZWVkIHRvIHN0YXJ0IHdpdGggYSBsZWFkaW5nIGAtYFxuICAgICAgICAgICAgc3VmZml4ID8gYCR7dmVyc2lvbn0ke3N1ZmZpeH1gIDogdmVyc2lvbixcbiAgICAgICAgICAgIHRoaXMuYXNzZW1ibGllc0N1cnJlbnRseUJlaW5nQ29tcGlsZWQuaW5jbHVkZXMoZGVwTmFtZSksXG4gICAgICAgICAgKSxcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogTG9vcHMgdGhyb3VnaCB0aGUgaW1wbGVtZW50ZWQgaW50ZXJmYWNlcyBhbmQgcmV0dXJucyB0aGUgZnVsbHkgcXVhbGlmaWVkIC5ORVQgdHlwZXMgb2YgdGhlIGludGVyZmFjZXNcbiAgICpcbiAgICovXG4gIHB1YmxpYyByZXNvbHZlSW1wbGVtZW50ZWRJbnRlcmZhY2VzKFxuICAgIGlmYzogc3BlYy5JbnRlcmZhY2VUeXBlIHwgc3BlYy5DbGFzc1R5cGUsXG4gICk6IHN0cmluZ1tdIHtcbiAgICBjb25zdCBpbnRlcmZhY2VzID0gaWZjLmludGVyZmFjZXMgPz8gW107XG4gICAgY29uc3QgYmFzZVR5cGVOYW1lczogc3RyaW5nW10gPSBbXTtcblxuICAgIC8vIEZvciBhbGwgYmFzZSBtZW1iZXJzXG4gICAgZm9yIChjb25zdCBiYXNlIG9mIGludGVyZmFjZXMpIHtcbiAgICAgIGNvbnN0IGludGVyZmFjZUZ1bGxUeXBlID0gdGhpcy50b05hdGl2ZUZxbihiYXNlKTtcbiAgICAgIGJhc2VUeXBlTmFtZXMucHVzaChpbnRlcmZhY2VGdWxsVHlwZSk7XG4gICAgfVxuICAgIHJldHVybiBiYXNlVHlwZU5hbWVzO1xuICB9XG5cbiAgLyoqXG4gICAqIFRyYW5zbGF0ZXMgYW55IGpzaWkgdHlwZSB0byBpdHMgY29ycmVzcG9uZGluZyAuTkVUIHR5cGVcbiAgICovXG4gIHB1YmxpYyB0b0RvdE5ldFR5cGUodHlwZXJlZjogc3BlYy5UeXBlUmVmZXJlbmNlKTogc3RyaW5nIHtcbiAgICBpZiAoc3BlYy5pc1ByaW1pdGl2ZVR5cGVSZWZlcmVuY2UodHlwZXJlZikpIHtcbiAgICAgIHJldHVybiB0aGlzLnRvRG90TmV0UHJpbWl0aXZlKHR5cGVyZWYucHJpbWl0aXZlKTtcbiAgICB9IGVsc2UgaWYgKHNwZWMuaXNDb2xsZWN0aW9uVHlwZVJlZmVyZW5jZSh0eXBlcmVmKSkge1xuICAgICAgcmV0dXJuIHRoaXMudG9Eb3ROZXRDb2xsZWN0aW9uKHR5cGVyZWYpO1xuICAgIH0gZWxzZSBpZiAoc3BlYy5pc05hbWVkVHlwZVJlZmVyZW5jZSh0eXBlcmVmKSkge1xuICAgICAgcmV0dXJuIHRoaXMudG9OYXRpdmVGcW4odHlwZXJlZi5mcW4pO1xuICAgIH0gZWxzZSBpZiAodHlwZXJlZi51bmlvbikge1xuICAgICAgcmV0dXJuICdvYmplY3QnO1xuICAgIH1cbiAgICB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgdHlwZSByZWZlcmVuY2U6ICR7SlNPTi5zdHJpbmdpZnkodHlwZXJlZil9YCk7XG4gIH1cblxuICBwdWJsaWMgcmVzb2x2ZU5hbWVzcGFjZShcbiAgICBhc3NtOiBzcGVjLkFzc2VtYmx5Q29uZmlndXJhdGlvbixcbiAgICBhc3NtTmFtZTogc3RyaW5nLFxuICAgIG5zOiBzdHJpbmcsXG4gICk6IHN0cmluZyB7XG4gICAgbGV0IHJlc29sdmVkID0gYXNzbS50YXJnZXRzPy5kb3RuZXQ/Lm5hbWVzcGFjZTtcbiAgICBpZiAoIXJlc29sdmVkKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBBc3NlbWJseSAke2Fzc21OYW1lfSBkb2VzIG5vdCBoYXZlIHRhcmdldHMuZG90bmV0Lm5hbWVzcGFjZSBjb25maWd1cmVkIWAsXG4gICAgICApO1xuICAgIH1cbiAgICBjb25zdCBzZWdtZW50cyA9IG5zLnNwbGl0KCcuJyk7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzZWdtZW50cy5sZW5ndGg7IGkrKykge1xuICAgICAgY29uc3Qgc3VibW9kdWxlTmFtZSA9IGAke2Fzc21OYW1lfS4ke3NlZ21lbnRzLnNsaWNlKDAsIGkgKyAxKS5qb2luKCcuJyl9YDtcbiAgICAgIGNvbnN0IHN1Ym1vZHVsZSA9IGFzc20uc3VibW9kdWxlcz8uW3N1Ym1vZHVsZU5hbWVdO1xuICAgICAgaWYgKHN1Ym1vZHVsZSAmJiBzdWJtb2R1bGUudGFyZ2V0cz8uZG90bmV0Py5uYW1lc3BhY2UpIHtcbiAgICAgICAgcmVzb2x2ZWQgPSBzdWJtb2R1bGUudGFyZ2V0cy5kb3RuZXQubmFtZXNwYWNlO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmVzb2x2ZWQgPSBgJHtyZXNvbHZlZH0uJHt0b1Bhc2NhbENhc2Uoc2VnbWVudHNbaV0pfWA7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiByZXNvbHZlZDtcbiAgfVxuXG4gIC8qKlxuICAgKiBUcmFuc2xhdGVzIGEgcHJpbWl0aXZlIGluIGpzaWkgdG8gYSBuYXRpdmUgLk5FVCBwcmltaXRpdmVcbiAgICovXG4gIHByaXZhdGUgdG9Eb3ROZXRQcmltaXRpdmUocHJpbWl0aXZlOiBzcGVjLlByaW1pdGl2ZVR5cGUpOiBzdHJpbmcge1xuICAgIHN3aXRjaCAocHJpbWl0aXZlKSB7XG4gICAgICBjYXNlIHNwZWMuUHJpbWl0aXZlVHlwZS5Cb29sZWFuOlxuICAgICAgICByZXR1cm4gJ2Jvb2wnO1xuICAgICAgY2FzZSBzcGVjLlByaW1pdGl2ZVR5cGUuRGF0ZTpcbiAgICAgICAgcmV0dXJuICdTeXN0ZW0uRGF0ZVRpbWUnO1xuICAgICAgY2FzZSBzcGVjLlByaW1pdGl2ZVR5cGUuSnNvbjpcbiAgICAgICAgcmV0dXJuICdOZXd0b25zb2Z0Lkpzb24uTGlucS5KT2JqZWN0JztcbiAgICAgIGNhc2Ugc3BlYy5QcmltaXRpdmVUeXBlLk51bWJlcjpcbiAgICAgICAgcmV0dXJuICdkb3VibGUnO1xuICAgICAgY2FzZSBzcGVjLlByaW1pdGl2ZVR5cGUuU3RyaW5nOlxuICAgICAgICByZXR1cm4gJ3N0cmluZyc7XG4gICAgICBjYXNlIHNwZWMuUHJpbWl0aXZlVHlwZS5Bbnk6XG4gICAgICAgIHJldHVybiAnb2JqZWN0JztcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgVW5rbm93biBwcmltaXRpdmUgdHlwZTogJHtwcmltaXRpdmUgYXMgYW55fWApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBUcmFuc2xhdGVzIGEgY29sbGVjdGlvbiBpbiBqc2lpIHRvIGEgbmF0aXZlIC5ORVQgY29sbGVjdGlvblxuICAgKi9cbiAgcHJpdmF0ZSB0b0RvdE5ldENvbGxlY3Rpb24ocmVmOiBzcGVjLkNvbGxlY3Rpb25UeXBlUmVmZXJlbmNlKTogc3RyaW5nIHtcbiAgICBjb25zdCBlbGVtZW50RG90TmV0VHlwZSA9IHRoaXMudG9Eb3ROZXRUeXBlKHJlZi5jb2xsZWN0aW9uLmVsZW1lbnR0eXBlKTtcbiAgICBzd2l0Y2ggKHJlZi5jb2xsZWN0aW9uLmtpbmQpIHtcbiAgICAgIGNhc2Ugc3BlYy5Db2xsZWN0aW9uS2luZC5BcnJheTpcbiAgICAgICAgcmV0dXJuIGAke2VsZW1lbnREb3ROZXRUeXBlfVtdYDtcbiAgICAgIGNhc2Ugc3BlYy5Db2xsZWN0aW9uS2luZC5NYXA6XG4gICAgICAgIHJldHVybiBgU3lzdGVtLkNvbGxlY3Rpb25zLkdlbmVyaWMuSURpY3Rpb25hcnk8c3RyaW5nLCAke2VsZW1lbnREb3ROZXRUeXBlfT5gO1xuICAgICAgZGVmYXVsdDpcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgIGBVbnN1cHBvcnRlZCBjb2xsZWN0aW9uIGtpbmQ6ICR7cmVmLmNvbGxlY3Rpb24ua2luZCBhcyBhbnl9YCxcbiAgICAgICAgKTtcbiAgICB9XG4gIH1cbn1cbiJdfQ==