"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.FileGenerator = exports.DotNetDependency = void 0;
const path = require("path");
const xmlbuilder = require("xmlbuilder");
const __1 = require("..");
const logging = require("../../logging");
const dotnet_1 = require("../dotnet");
const version_utils_1 = require("../version-utils");
const nameutils_1 = require("./nameutils");
// Represents a dependency in the dependency tree.
class DotNetDependency {
    constructor(namespace, packageId, fqn, version, partOfCompilation) {
        this.namespace = namespace;
        this.packageId = packageId;
        this.fqn = fqn;
        this.partOfCompilation = partOfCompilation;
        this.version = version_utils_1.toNuGetVersionRange(version);
    }
}
exports.DotNetDependency = DotNetDependency;
// Generates misc files such as the .csproj and the AssemblyInfo.cs file
// Uses the same instance of CodeMaker as the rest of the code so that the files get created when calling the save() method
class FileGenerator {
    // We pass in an instance of CodeMaker so that the files get later saved
    // when calling the save() method on the .NET Generator.
    constructor(assm, tarballFileName, code) {
        this.assemblyInfoNamespaces = [
            'Amazon.JSII.Runtime.Deputy',
        ];
        this.nameutils = new nameutils_1.DotNetNameUtils();
        this.assm = assm;
        this.tarballFileName = tarballFileName;
        this.code = code;
    }
    // Generates the .csproj file
    generateProjectFile(dependencies) {
        const assembly = this.assm;
        const packageId = assembly.targets.dotnet.packageId;
        const projectFilePath = path.join(packageId, `${packageId}.csproj`);
        // Construct XML csproj content.
        // headless removes the <xml?> head node so that the first node is the <Project> node
        const rootNode = xmlbuilder.create('Project', {
            encoding: 'UTF-8',
            headless: true,
        });
        rootNode.att('Sdk', 'Microsoft.NET.Sdk');
        const propertyGroup = rootNode.ele('PropertyGroup');
        const dotnetInfo = assembly.targets.dotnet;
        propertyGroup.comment('Package Identification');
        propertyGroup.ele('Description', this.getDescription());
        if (dotnetInfo.iconUrl != null) {
            propertyGroup.ele('PackageIconUrl', dotnetInfo.iconUrl);
        }
        propertyGroup.ele('PackageId', packageId);
        propertyGroup.ele('PackageLicenseExpression', assembly.license);
        propertyGroup.ele('PackageVersion', this.getDecoratedVersion(assembly));
        if (dotnetInfo.title != null) {
            propertyGroup.ele('Title', dotnetInfo.title);
        }
        propertyGroup.comment('Additional Metadata');
        propertyGroup.ele('Authors', assembly.author.name);
        if (assembly.author.organization) {
            propertyGroup.ele('Company', assembly.author.name);
        }
        if (assembly.keywords) {
            propertyGroup.ele('PackageTags', assembly.keywords.join(';'));
        }
        propertyGroup.ele('Language', 'en-US');
        propertyGroup.ele('ProjectUrl', assembly.homepage);
        propertyGroup.ele('RepositoryUrl', assembly.repository.url);
        propertyGroup.ele('RepositoryType', assembly.repository.type);
        propertyGroup.comment('Build Configuration');
        propertyGroup.ele('GenerateDocumentationFile', 'true');
        propertyGroup.ele('GeneratePackageOnBuild', 'true');
        propertyGroup.ele('IncludeSymbols', 'true');
        propertyGroup.ele('IncludeSource', 'true');
        propertyGroup.ele('Nullable', 'enable');
        propertyGroup.ele('SymbolPackageFormat', 'snupkg');
        propertyGroup.ele('TargetFramework', dotnet_1.TARGET_FRAMEWORK);
        const itemGroup1 = rootNode.ele('ItemGroup');
        const embeddedResource = itemGroup1.ele('EmbeddedResource');
        embeddedResource.att('Include', this.tarballFileName);
        // Strip " (build abcdef)" from the jsii version
        const jsiiVersion = assembly.jsiiVersion.replace(/ .*$/, '');
        const itemGroup2 = rootNode.ele('ItemGroup');
        const packageReference = itemGroup2.ele('PackageReference');
        packageReference.att('Include', 'Amazon.JSII.Runtime');
        packageReference.att('Version', version_utils_1.toNuGetVersionRange(`^${jsiiVersion}`));
        dependencies.forEach((value) => {
            if (value.partOfCompilation) {
                const dependencyReference = itemGroup2.ele('ProjectReference');
                dependencyReference.att('Include', `../${value.packageId}/${value.packageId}.csproj`);
            }
            else {
                const dependencyReference = itemGroup2.ele('PackageReference');
                dependencyReference.att('Include', value.packageId);
                dependencyReference.att('Version', value.version);
            }
        });
        const warnings = rootNode.ele('PropertyGroup');
        // Suppress warnings about [Obsolete] members, this is the author's choice!
        warnings.comment('Silence [Obsolete] warnings');
        warnings.ele('NoWarn').text('0612,0618');
        // Treat select warnings as errors, as these are likely codegen bugs:
        warnings.comment('Treat warnings symptomatic of code generation bugs as errors');
        warnings.ele('WarningsAsErrors', [
            '0108',
            '0109',
        ].join(','));
        const xml = rootNode.end({ pretty: true, spaceBeforeSlash: true });
        // Sending the xml content to the codemaker to ensure the file is written
        // and added to the file list for tracking
        this.code.openFile(projectFilePath);
        this.code.open(xml);
        // Unindent for the next file
        this.code.close();
        this.code.closeFile(projectFilePath);
        logging.debug(`Written to ${projectFilePath}`);
    }
    // Generates the AssemblyInfo.cs file
    generateAssemblyInfoFile() {
        const packageId = this.assm.targets.dotnet.packageId;
        const filePath = path.join(packageId, 'AssemblyInfo.cs');
        this.code.openFile(filePath);
        this.assemblyInfoNamespaces.map((n) => this.code.line(`using ${n};`));
        this.code.line();
        const assembly = `[assembly: JsiiAssembly("${this.assm.name}", "${this.assm.version}", "${this.tarballFileName}")]`;
        this.code.line(assembly);
        this.code.closeFile(filePath);
    }
    // Generates the description
    getDescription() {
        const docs = this.assm.docs;
        if (docs) {
            const stability = docs.stability;
            if (stability) {
                return `${this.assm.description} (Stability: ${this.nameutils.capitalizeWord(stability)})`;
            }
        }
        return this.assm.description;
    }
    // Generates the decorated version
    getDecoratedVersion(assembly) {
        const suffix = assembly.targets.dotnet.versionSuffix;
        if (suffix) {
            // suffix is guaranteed to start with a leading `-`
            return `${assembly.version}${suffix}`;
        }
        return version_utils_1.toReleaseVersion(assembly.version, __1.TargetName.DOTNET);
    }
}
exports.FileGenerator = FileGenerator;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmlsZWdlbmVyYXRvci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImZpbGVnZW5lcmF0b3IudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBRUEsNkJBQTZCO0FBQzdCLHlDQUF5QztBQUV6QywwQkFBZ0M7QUFDaEMseUNBQXlDO0FBQ3pDLHNDQUE2QztBQUM3QyxvREFBeUU7QUFDekUsMkNBQThDO0FBRTlDLGtEQUFrRDtBQUNsRCxNQUFhLGdCQUFnQjtJQUczQixZQUNrQixTQUFpQixFQUNqQixTQUFpQixFQUNqQixHQUFXLEVBQzNCLE9BQWUsRUFDQyxpQkFBMEI7UUFKMUIsY0FBUyxHQUFULFNBQVMsQ0FBUTtRQUNqQixjQUFTLEdBQVQsU0FBUyxDQUFRO1FBQ2pCLFFBQUcsR0FBSCxHQUFHLENBQVE7UUFFWCxzQkFBaUIsR0FBakIsaUJBQWlCLENBQVM7UUFFMUMsSUFBSSxDQUFDLE9BQU8sR0FBRyxtQ0FBbUIsQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUM5QyxDQUFDO0NBQ0Y7QUFaRCw0Q0FZQztBQUVELHdFQUF3RTtBQUN4RSwySEFBMkg7QUFDM0gsTUFBYSxhQUFhO0lBU3hCLHdFQUF3RTtJQUN4RSx3REFBd0Q7SUFDeEQsWUFBbUIsSUFBYyxFQUFFLGVBQXVCLEVBQUUsSUFBZTtRQVAxRCwyQkFBc0IsR0FBYTtZQUNsRCw0QkFBNEI7U0FDN0IsQ0FBQztRQUNlLGNBQVMsR0FBb0IsSUFBSSwyQkFBZSxFQUFFLENBQUM7UUFLbEUsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7UUFDakIsSUFBSSxDQUFDLGVBQWUsR0FBRyxlQUFlLENBQUM7UUFDdkMsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7SUFDbkIsQ0FBQztJQUVELDZCQUE2QjtJQUN0QixtQkFBbUIsQ0FBQyxZQUEyQztRQUNwRSxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDO1FBQzNCLE1BQU0sU0FBUyxHQUFXLFFBQVEsQ0FBQyxPQUFR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QUM3RDtTQUNGO1FBQ0QsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQztJQUMvQixDQUFDO0lBRUQsa0NBQWtDO0lBQzFCLG1CQUFtQixDQUFDLFFBQWtCO1FBQzVDLE1BQU0sTUFBTSxHQUFHLFFBQVEsQ0FBQyxPQUFRLENBQUMsTUFBTyxDQUFDLGFBQWEsQ0FBQztRQUN2RCxJQUFJLE1BQU0sRUFBRTtZQUNWLG1EQUFtRDtZQUNuRCxPQUFPLEdBQUcsUUFBUSxDQUFDLE9BQU8sR0FBRyxNQUFNLEVBQUUsQ0FBQztTQUN2QztRQUNELE9BQU8sZ0NBQWdCLENBQUMsUUFBUSxDQUFDLE9BQU8sRUFBRSxjQUFVLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDL0QsQ0FBQztDQUNGO0FBN0pELHNDQTZKQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFzc2VtYmx5IH0gZnJvbSAnQGpzaWkvc3BlYyc7XG5pbXBvcnQgeyBDb2RlTWFrZXIgfSBmcm9tICdjb2RlbWFrZXInO1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCAqIGFzIHhtbGJ1aWxkZXIgZnJvbSAneG1sYnVpbGRlcic7XG5cbmltcG9ydCB7IFRhcmdldE5hbWUgfSBmcm9tICcuLic7XG5pbXBvcnQgKiBhcyBsb2dnaW5nIGZyb20gJy4uLy4uL2xvZ2dpbmcnO1xuaW1wb3J0IHsgVEFSR0VUX0ZSQU1FV09SSyB9IGZyb20gJy4uL2RvdG5ldCc7XG5pbXBvcnQgeyB0b051R2V0VmVyc2lvblJhbmdlLCB0b1JlbGVhc2VWZXJzaW9uIH0gZnJvbSAnLi4vdmVyc2lvbi11dGlscyc7XG5pbXBvcnQgeyBEb3ROZXROYW1lVXRpbHMgfSBmcm9tICcuL25hbWV1dGlscyc7XG5cbi8vIFJlcHJlc2VudHMgYSBkZXBlbmRlbmN5IGluIHRoZSBkZXBlbmRlbmN5IHRyZWUuXG5leHBvcnQgY2xhc3MgRG90TmV0RGVwZW5kZW5jeSB7XG4gIHB1YmxpYyByZWFkb25seSB2ZXJzaW9uOiBzdHJpbmc7XG5cbiAgcHVibGljIGNvbnN0cnVjdG9yKFxuICAgIHB1YmxpYyByZWFkb25seSBuYW1lc3BhY2U6IHN0cmluZyxcbiAgICBwdWJsaWMgcmVhZG9ubHkgcGFja2FnZUlkOiBzdHJpbmcsXG4gICAgcHVibGljIHJlYWRvbmx5IGZxbjogc3RyaW5nLFxuICAgIHZlcnNpb246IHN0cmluZyxcbiAgICBwdWJsaWMgcmVhZG9ubHkgcGFydE9mQ29tcGlsYXRpb246IGJvb2xlYW4sXG4gICkge1xuICAgIHRoaXMudmVyc2lvbiA9IHRvTnVHZXRWZXJzaW9uUmFuZ2UodmVyc2lvbik7XG4gIH1cbn1cblxuLy8gR2VuZXJhdGVzIG1pc2MgZmlsZXMgc3VjaCBhcyB0aGUgLmNzcHJvaiBhbmQgdGhlIEFzc2VtYmx5SW5mby5jcyBmaWxlXG4vLyBVc2VzIHRoZSBzYW1lIGluc3RhbmNlIG9mIENvZGVNYWtlciBhcyB0aGUgcmVzdCBvZiB0aGUgY29kZSBzbyB0aGF0IHRoZSBmaWxlcyBnZXQgY3JlYXRlZCB3aGVuIGNhbGxpbmcgdGhlIHNhdmUoKSBtZXRob2RcbmV4cG9ydCBjbGFzcyBGaWxlR2VuZXJhdG9yIHtcbiAgcHJpdmF0ZSByZWFkb25seSBhc3NtOiBBc3NlbWJseTtcbiAgcHJpdmF0ZSByZWFkb25seSB0YXJiYWxsRmlsZU5hbWU6IHN0cmluZztcbiAgcHJpdmF0ZSByZWFkb25seSBjb2RlOiBDb2RlTWFrZXI7XG4gIHByaXZhdGUgcmVhZG9ubHkgYXNzZW1ibHlJbmZvTmFtZXNwYWNlczogc3RyaW5nW10gPSBbXG4gICAgJ0FtYXpvbi5KU0lJLlJ1bnRpbWUuRGVwdXR5JyxcbiAgXTtcbiAgcHJpdmF0ZSByZWFkb25seSBuYW1ldXRpbHM6IERvdE5ldE5hbWVVdGlscyA9IG5ldyBEb3ROZXROYW1lVXRpbHMoKTtcblxuICAvLyBXZSBwYXNzIGluIGFuIGluc3RhbmNlIG9mIENvZGVNYWtlciBzbyB0aGF0IHRoZSBmaWxlcyBnZXQgbGF0ZXIgc2F2ZWRcbiAgLy8gd2hlbiBjYWxsaW5nIHRoZSBzYXZlKCkgbWV0aG9kIG9uIHRoZSAuTkVUIEdlbmVyYXRvci5cbiAgcHVibGljIGNvbnN0cnVjdG9yKGFzc206IEFzc2VtYmx5LCB0YXJiYWxsRmlsZU5hbWU6IHN0cmluZywgY29kZTogQ29kZU1ha2VyKSB7XG4gICAgdGhpcy5hc3NtID0gYXNzbTtcbiAgICB0aGlzLnRhcmJhbGxGaWxlTmFtZSA9IHRhcmJhbGxGaWxlTmFtZTtcbiAgICB0aGlzLmNvZGUgPSBjb2RlO1xuICB9XG5cbiAgLy8gR2VuZXJhdGVzIHRoZSAuY3Nwcm9qIGZpbGVcbiAgcHVibGljIGdlbmVyYXRlUHJvamVjdEZpbGUoZGVwZW5kZW5jaWVzOiBNYXA8c3RyaW5nLCBEb3ROZXREZXBlbmRlbmN5Pikge1xuICAgIGNvbnN0IGFzc2VtYmx5ID0gdGhpcy5hc3NtO1xuICAgIGNvbnN0IHBhY2thZ2VJZDogc3RyaW5nID0gYXNzZW1ibHkudGFyZ2V0cyEuZG90bmV0IS5wYWNrYWdlSWQ7XG5cbiAgICBjb25zdCBwcm9qZWN0RmlsZVBhdGg6IHN0cmluZyA9IHBhdGguam9pbihwYWNrYWdlSWQsIGAke3BhY2thZ2VJZH0uY3Nwcm9qYCk7XG5cbiAgICAvLyBDb25zdHJ1Y3QgWE1MIGNzcHJvaiBjb250ZW50LlxuICAgIC8vIGhlYWRsZXNzIHJlbW92ZXMgdGhlIDx4bWw/PiBoZWFkIG5vZGUgc28gdGhhdCB0aGUgZmlyc3Qgbm9kZSBpcyB0aGUgPFByb2plY3Q+IG5vZGVcbiAgICBjb25zdCByb290Tm9kZSA9IHhtbGJ1aWxkZXIuY3JlYXRlKCdQcm9qZWN0Jywge1xuICAgICAgZW5jb2Rpbmc6ICdVVEYtOCcsXG4gICAgICBoZWFkbGVzczogdHJ1ZSxcbiAgICB9KTtcbiAgICByb290Tm9kZS5hdHQoJ1NkaycsICdNaWNyb3NvZnQuTkVULlNkaycpO1xuICAgIGNvbnN0IHByb3BlcnR5R3JvdXAgPSByb290Tm9kZS5lbGUoJ1Byb3BlcnR5R3JvdXAnKTtcbiAgICBjb25zdCBkb3RuZXRJbmZvID0gYXNzZW1ibHkudGFyZ2V0cyEuZG90bmV0O1xuXG4gICAgcHJvcGVydHlHcm91cC5jb21tZW50KCdQYWNrYWdlIElkZW50aWZpY2F0aW9uJyk7XG4gICAgcHJvcGVydHlHcm91cC5lbGUoJ0Rlc2NyaXB0aW9uJywgdGhpcy5nZXREZXNjcmlwdGlvbigpKTtcbiAgICBpZiAoZG90bmV0SW5mbyEuaWNvblVybCAhPSBudWxsKSB7XG4gICAgICBwcm9wZXJ0eUdyb3VwLmVsZSgnUGFja2FnZUljb25VcmwnLCBkb3RuZXRJbmZvIS5pY29uVXJsKTtcbiAgICB9XG4gICAgcHJvcGVydHlHcm91cC5lbGUoJ1BhY2thZ2VJZCcsIHBhY2thZ2VJZCk7XG4gICAgcHJvcGVydHlHcm91cC5lbGUoJ1BhY2thZ2VMaWNlbnNlRXhwcmVzc2lvbicsIGFzc2VtYmx5LmxpY2Vuc2UpO1xuICAgIHByb3BlcnR5R3JvdXAuZWxlKCdQYWNrYWdlVmVyc2lvbicsIHRoaXMuZ2V0RGVjb3JhdGVkVmVyc2lvbihhc3NlbWJseSkpO1xuICAgIGlmIChkb3RuZXRJbmZvIS50aXRsZSAhPSBudWxsKSB7XG4gICAgICBwcm9wZXJ0eUdyb3VwLmVsZSgnVGl0bGUnLCBkb3RuZXRJbmZvIS50aXRsZSk7XG4gICAgfVxuXG4gICAgcHJvcGVydHlHcm91cC5jb21tZW50KCdBZGRpdGlvbmFsIE1ldGFkYXRhJyk7XG4gICAgcHJvcGVydHlHcm91cC5lbGUoJ0F1dGhvcnMnLCBhc3NlbWJseS5hdXRob3IubmFtZSk7XG4gICAgaWYgKGFzc2VtYmx5LmF1dGhvci5vcmdhbml6YXRpb24pIHtcbiAgICAgIHByb3BlcnR5R3JvdXAuZWxlKCdDb21wYW55JywgYXNzZW1ibHkuYXV0aG9yLm5hbWUpO1xuICAgIH1cbiAgICBpZiAoYXNzZW1ibHkua2V5d29yZHMpIHtcbiAgICAgIHByb3BlcnR5R3JvdXAuZWxlKCdQYWNrYWdlVGFncycsIGFzc2VtYmx5LmtleXdvcmRzLmpvaW4oJzsnKSk7XG4gICAgfVxuICAgIHByb3BlcnR5R3JvdXAuZWxlKCdMYW5ndWFnZScsICdlbi1VUycpO1xuICAgIHByb3BlcnR5R3JvdXAuZWxlKCdQcm9qZWN0VXJsJywgYXNzZW1ibHkuaG9tZXBhZ2UpO1xuICAgIHByb3BlcnR5R3JvdXAuZWxlKCdSZXBvc2l0b3J5VXJsJywgYXNzZW1ibHkucmVwb3NpdG9yeS51cmwpO1xuICAgIHByb3BlcnR5R3JvdXAuZWxlKCdSZXBvc2l0b3J5VHlwZScsIGFzc2VtYmx5LnJlcG9zaXRvcnkudHlwZSk7XG5cbiAgICBwcm9wZXJ0eUdyb3VwLmNvbW1lbnQoJ0J1aWxkIENvbmZpZ3VyYXRpb24nKTtcbiAgICBwcm9wZXJ0eUdyb3VwLmVsZSgnR2VuZXJhdGVEb2N1bWVudGF0aW9uRmlsZScsICd0cnVlJyk7XG4gICAgcHJvcGVydHlHcm91cC5lbGUoJ0dlbmVyYXRlUGFja2FnZU9uQnVpbGQnLCAndHJ1ZScpO1xuICAgIHByb3BlcnR5R3JvdXAuZWxlKCdJbmNsdWRlU3ltYm9scycsICd0cnVlJyk7XG4gICAgcHJvcGVydHlHcm91cC5lbGUoJ0luY2x1ZGVTb3VyY2UnLCAndHJ1ZScpO1xuICAgIHByb3BlcnR5R3JvdXAuZWxlKCdOdWxsYWJsZScsICdlbmFibGUnKTtcbiAgICBwcm9wZXJ0eUdyb3VwLmVsZSgnU3ltYm9sUGFja2FnZUZvcm1hdCcsICdzbnVwa2cnKTtcbiAgICBwcm9wZXJ0eUdyb3VwLmVsZSgnVGFyZ2V0RnJhbWV3b3JrJywgVEFSR0VUX0ZSQU1FV09SSyk7XG5cbiAgICBjb25zdCBpdGVtR3JvdXAxID0gcm9vdE5vZGUuZWxlKCdJdGVtR3JvdXAnKTtcbiAgICBjb25zdCBlbWJlZGRlZFJlc291cmNlID0gaXRlbUdyb3VwMS5lbGUoJ0VtYmVkZGVkUmVzb3VyY2UnKTtcbiAgICBlbWJlZGRlZFJlc291cmNlLmF0dCgnSW5jbHVkZScsIHRoaXMudGFyYmFsbEZpbGVOYW1lKTtcblxuICAgIC8vIFN0cmlwIFwiIChidWlsZCBhYmNkZWYpXCIgZnJvbSB0aGUganNpaSB2ZXJzaW9uXG4gICAgY29uc3QganNpaVZlcnNpb24gPSBhc3NlbWJseS5qc2lpVmVyc2lvbi5yZXBsYWNlKC8gLiokLywgJycpO1xuXG4gICAgY29uc3QgaXRlbUdyb3VwMiA9IHJvb3ROb2RlLmVsZSgnSXRlbUdyb3VwJyk7XG4gICAgY29uc3QgcGFja2FnZVJlZmVyZW5jZSA9IGl0ZW1Hcm91cDIuZWxlKCdQYWNrYWdlUmVmZXJlbmNlJyk7XG4gICAgcGFja2FnZVJlZmVyZW5jZS5hdHQoJ0luY2x1ZGUnLCAnQW1hem9uLkpTSUkuUnVudGltZScpO1xuICAgIHBhY2thZ2VSZWZlcmVuY2UuYXR0KCdWZXJzaW9uJywgdG9OdUdldFZlcnNpb25SYW5nZShgXiR7anNpaVZlcnNpb259YCkpO1xuXG4gICAgZGVwZW5kZW5jaWVzLmZvckVhY2goKHZhbHVlOiBEb3ROZXREZXBlbmRlbmN5KSA9PiB7XG4gICAgICBpZiAodmFsdWUucGFydE9mQ29tcGlsYXRpb24pIHtcbiAgICAgICAgY29uc3QgZGVwZW5kZW5jeVJlZmVyZW5jZSA9IGl0ZW1Hcm91cDIuZWxlKCdQcm9qZWN0UmVmZXJlbmNlJyk7XG4gICAgICAgIGRlcGVuZGVuY3lSZWZlcmVuY2UuYXR0KFxuICAgICAgICAgICdJbmNsdWRlJyxcbiAgICAgICAgICBgLi4vJHt2YWx1ZS5wYWNrYWdlSWR9LyR7dmFsdWUucGFja2FnZUlkfS5jc3Byb2pgLFxuICAgICAgICApO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc3QgZGVwZW5kZW5jeVJlZmVyZW5jZSA9IGl0ZW1Hcm91cDIuZWxlKCdQYWNrYWdlUmVmZXJlbmNlJyk7XG4gICAgICAgIGRlcGVuZGVuY3lSZWZlcmVuY2UuYXR0KCdJbmNsdWRlJywgdmFsdWUucGFja2FnZUlkKTtcbiAgICAgICAgZGVwZW5kZW5jeVJlZmVyZW5jZS5hdHQoJ1ZlcnNpb24nLCB2YWx1ZS52ZXJzaW9uKTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIGNvbnN0IHdhcm5pbmdzID0gcm9vdE5vZGUuZWxlKCdQcm9wZXJ0eUdyb3VwJyk7XG4gICAgLy8gU3VwcHJlc3Mgd2FybmluZ3MgYWJvdXQgW09ic29sZXRlXSBtZW1iZXJzLCB0aGlzIGlzIHRoZSBhdXRob3IncyBjaG9pY2UhXG4gICAgd2FybmluZ3MuY29tbWVudCgnU2lsZW5jZSBbT2Jzb2xldGVdIHdhcm5pbmdzJyk7XG4gICAgd2FybmluZ3MuZWxlKCdOb1dhcm4nKS50ZXh0KCcwNjEyLDA2MTgnKTtcbiAgICAvLyBUcmVhdCBzZWxlY3Qgd2FybmluZ3MgYXMgZXJyb3JzLCBhcyB0aGVzZSBhcmUgbGlrZWx5IGNvZGVnZW4gYnVnczpcbiAgICB3YXJuaW5ncy5jb21tZW50KFxuICAgICAgJ1RyZWF0IHdhcm5pbmdzIHN5bXB0b21hdGljIG9mIGNvZGUgZ2VuZXJhdGlvbiBidWdzIGFzIGVycm9ycycsXG4gICAgKTtcbiAgICB3YXJuaW5ncy5lbGUoXG4gICAgICAnV2FybmluZ3NBc0Vycm9ycycsXG4gICAgICBbXG4gICAgICAgICcwMTA4JywgLy8gJ21lbWJlcjEnIGhpZGVzIGluaGVyaXRlZCBtZW1iZXIgJ21lbWJlcjInLiBVc2UgdGhlIG5ldyBrZXl3b3JkIGlmIGhpZGluZyB3YXMgaW50ZW5kZWQuXG4gICAgICAgICcwMTA5JywgLy8gVGhlIG1lbWJlciAnbWVtYmVyJyBkb2VzIG5vdCBoaWRlIGFuIGluaGVyaXRlZCBtZW1iZXIuIFRoZSBuZXcga2V5d29yZCBpcyBub3QgcmVxdWlyZWQuXG4gICAgICBdLmpvaW4oJywnKSxcbiAgICApO1xuICAgIGNvbnN0IHhtbCA9IHJvb3ROb2RlLmVuZCh7IHByZXR0eTogdHJ1ZSwgc3BhY2VCZWZvcmVTbGFzaDogdHJ1ZSB9KTtcblxuICAgIC8vIFNlbmRpbmcgdGhlIHhtbCBjb250ZW50IHRvIHRoZSBjb2RlbWFrZXIgdG8gZW5zdXJlIHRoZSBmaWxlIGlzIHdyaXR0ZW5cbiAgICAvLyBhbmQgYWRkZWQgdG8gdGhlIGZpbGUgbGlzdCBmb3IgdHJhY2tpbmdcbiAgICB0aGlzLmNvZGUub3BlbkZpbGUocHJvamVjdEZpbGVQYXRoKTtcbiAgICB0aGlzLmNvZGUub3Blbih4bWwpO1xuICAgIC8vIFVuaW5kZW50IGZvciB0aGUgbmV4dCBmaWxlXG4gICAgdGhpcy5jb2RlLmNsb3NlKCk7XG4gICAgdGhpcy5jb2RlLmNsb3NlRmlsZShwcm9qZWN0RmlsZVBhdGgpO1xuXG4gICAgbG9nZ2luZy5kZWJ1ZyhgV3JpdHRlbiB0byAke3Byb2plY3RGaWxlUGF0aH1gKTtcbiAgfVxuXG4gIC8vIEdlbmVyYXRlcyB0aGUgQXNzZW1ibHlJbmZvLmNzIGZpbGVcbiAgcHVibGljIGdlbmVyYXRlQXNzZW1ibHlJbmZvRmlsZSgpIHtcbiAgICBjb25zdCBwYWNrYWdlSWQ6IHN0cmluZyA9IHRoaXMuYXNzbS50YXJnZXRzIS5kb3RuZXQhLnBhY2thZ2VJZDtcbiAgICBjb25zdCBmaWxlUGF0aDogc3RyaW5nID0gcGF0aC5qb2luKHBhY2thZ2VJZCwgJ0Fzc2VtYmx5SW5mby5jcycpO1xuICAgIHRoaXMuY29kZS5vcGVuRmlsZShmaWxlUGF0aCk7XG4gICAgdGhpcy5hc3NlbWJseUluZm9OYW1lc3BhY2VzLm1hcCgobikgPT4gdGhpcy5jb2RlLmxpbmUoYHVzaW5nICR7bn07YCkpO1xuICAgIHRoaXMuY29kZS5saW5lKCk7XG4gICAgY29uc3QgYXNzZW1ibHkgPSBgW2Fzc2VtYmx5OiBKc2lpQXNzZW1ibHkoXCIke3RoaXMuYXNzbS5uYW1lfVwiLCBcIiR7dGhpcy5hc3NtLnZlcnNpb259XCIsIFwiJHt0aGlzLnRhcmJhbGxGaWxlTmFtZX1cIildYDtcbiAgICB0aGlzLmNvZGUubGluZShhc3NlbWJseSk7XG4gICAgdGhpcy5jb2RlLmNsb3NlRmlsZShmaWxlUGF0aCk7XG4gIH1cblxuICAvLyBHZW5lcmF0ZXMgdGhlIGRlc2NyaXB0aW9uXG4gIHByaXZhdGUgZ2V0RGVzY3JpcHRpb24oKTogc3RyaW5nIHtcbiAgICBjb25zdCBkb2NzID0gdGhpcy5hc3NtLmRvY3M7XG4gICAgaWYgKGRvY3MpIHtcbiAgICAgIGNvbnN0IHN0YWJpbGl0eSA9IGRvY3Muc3RhYmlsaXR5O1xuICAgICAgaWYgKHN0YWJpbGl0eSkge1xuICAgICAgICByZXR1cm4gYCR7XG4gICAgICAgICAgdGhpcy5hc3NtLmRlc2NyaXB0aW9uXG4gICAgICAgIH0gKFN0YWJpbGl0eTogJHt0aGlzLm5hbWV1dGlscy5jYXBpdGFsaXplV29yZChzdGFiaWxpdHkpfSlgO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gdGhpcy5hc3NtLmRlc2NyaXB0aW9uO1xuICB9XG5cbiAgLy8gR2VuZXJhdGVzIHRoZSBkZWNvcmF0ZWQgdmVyc2lvblxuICBwcml2YXRlIGdldERlY29yYXRlZFZlcnNpb24oYXNzZW1ibHk6IEFzc2VtYmx5KTogc3RyaW5nIHtcbiAgICBjb25zdCBzdWZmaXggPSBhc3NlbWJseS50YXJnZXRzIS5kb3RuZXQhLnZlcnNpb25TdWZmaXg7XG4gICAgaWYgKHN1ZmZpeCkge1xuICAgICAgLy8gc3VmZml4IGlzIGd1YXJhbnRlZWQgdG8gc3RhcnQgd2l0aCBhIGxlYWRpbmcgYC1gXG4gICAgICByZXR1cm4gYCR7YXNzZW1ibHkudmVyc2lvbn0ke3N1ZmZpeH1gO1xuICAgIH1cbiAgICByZXR1cm4gdG9SZWxlYXNlVmVyc2lvbihhc3NlbWJseS52ZXJzaW9uLCBUYXJnZXROYW1lLkRPVE5FVCk7XG4gIH1cbn1cbiJdfQ==