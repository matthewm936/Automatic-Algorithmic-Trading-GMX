"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.GoParameter = exports.GoMethod = exports.GoProperty = void 0;
const jsii_reflect_1 = require("jsii-reflect");
const naming_util_1 = require("../../../naming-util");
const runtime_1 = require("../runtime");
const util_1 = require("../util");
const index_1 = require("./index");
/*
 * GoProperty encapsulates logic for public properties on a concrete struct, which could represent
 either a JSII class proxy or datatype interface proxy
*/
class GoProperty {
    constructor(parent, property) {
        this.parent = parent;
        this.property = property;
        this.name = naming_util_1.jsiiToPascalCase(this.property.name);
        this.immutable = property.immutable;
        if (property.type) {
            this.reference = new index_1.GoTypeRef(parent.pkg.root, property.type);
        }
    }
    get specialDependencies() {
        var _a;
        return {
            runtime: true,
            init: this.static,
            internal: false,
            time: !!((_a = this.reference) === null || _a === void 0 ? void 0 : _a.specialDependencies.time),
        };
    }
    get static() {
        return !!this.property.static;
    }
    get returnType() {
        var _a, _b;
        return ((_b = (_a = this.reference) === null || _a === void 0 ? void 0 : _a.scopedReference(this.parent.pkg)) !== null && _b !== void 0 ? _b : this.property.type.toString());
    }
    get instanceArg() {
        return this.parent.proxyName.substring(0, 1).toLowerCase();
    }
    get override() {
        return `${runtime_1.JSII_RT_ALIAS}.MemberProperty{JsiiProperty: "${this.property.name}", GoGetter: "${this.name}"}`;
    }
    emitStructMember({ code, documenter }) {
        var _a, _b;
        documenter.emit(this.property.docs);
        const memberType = ((_b = (_a = this.reference) === null || _a === void 0 ? void 0 : _a.type) === null || _b === void 0 ? void 0 : _b.name) === this.parent.name
            ? `*${this.returnType}`
            : this.returnType;
        // Adds json tags for easy deserialization
        code.line(`${this.name} ${memberType} \`json:"${this.property.name}"\``);
        // TODO add newline if not the last member
    }
    emitGetterDecl(context) {
        const { code } = context;
        code.line(`${this.name}() ${this.returnType}`);
    }
    emitGetter({ code, documenter }) {
        const receiver = this.parent.name;
        const instanceArg = receiver.substring(0, 1).toLowerCase();
        documenter.emit(this.property.docs);
        code.openBlock(`func (${instanceArg} *${receiver}) Get${this.name}() ${this.returnType}`);
        code.line(`return ${instanceArg}.${this.name}`);
        code.closeBlock();
    }
    emitSetterDecl(context) {
        const { code } = context;
        if (!this.immutable) {
            code.line(`Set${this.name}(val ${this.returnType})`);
        }
    }
    // Emits getter methods on the struct for each property
    emitGetterProxy(context) {
        const { code } = context;
        const receiver = this.parent.proxyName;
        const instanceArg = receiver.substring(0, 1).toLowerCase();
        code.openBlock(`func (${instanceArg} *${receiver}) ${this.name}() ${this.returnType}`);
        new runtime_1.GetProperty(this).emit(code);
        code.closeBlock();
        code.line();
    }
    emitSetterProxy(context) {
        if (!this.immutable) {
            const { code } = context;
            const receiver = this.parent.proxyName;
            const instanceArg = receiver.substring(0, 1).toLowerCase();
            code.openBlock(`func (${instanceArg} *${receiver}) Set${this.name}(val ${this.returnType})`);
            new runtime_1.SetProperty(this).emit(code);
            code.closeBlock();
            code.line();
        }
    }
}
exports.GoProperty = GoProperty;
class GoMethod {
    constructor(parent, method) {
        this.parent = parent;
        this.method = method;
        this.name = naming_util_1.jsiiToPascalCase(method.name);
        if (jsii_reflect_1.Method.isMethod(method) && method.returns.type) {
            this.reference = new index_1.GoTypeRef(parent.pkg.root, method.returns.type);
        }
        this.parameters = this.method.parameters.map((param) => new GoParameter(parent, param));
    }
    get returnsRef() {
        var _a, _b, _c, _d;
        if (((_b = (_a = this.reference) === null || _a === void 0 ? void 0 : _a.type) === null || _b === void 0 ? void 0 : _b.type.isClassType()) || ((_d = (_c = this.reference) === null || _c === void 0 ? void 0 : _c.type) === null || _d === void 0 ? void 0 : _d.type.isInterfaceType())) {
            return true;
        }
        return false;
    }
    get returnType() {
        var _a, _b;
        return ((_b = (_a = this.reference) === null || _a === void 0 ? void 0 : _a.scopedReference(this.parent.pkg)) !== null && _b !== void 0 ? _b : this.method.toString());
    }
    get instanceArg() {
        return this.parent.name.substring(0, 1).toLowerCase();
    }
    get override() {
        return `${runtime_1.JSII_RT_ALIAS}.MemberMethod{JsiiMethod: "${this.method.name}", GoMethod: "${this.name}"}`;
    }
    paramString() {
        return this.parameters.length === 0
            ? ''
            : this.parameters.map((p) => p.toString()).join(', ');
    }
}
exports.GoMethod = GoMethod;
class GoParameter {
    constructor(parent, parameter) {
        this.parent = parent;
        this.parameter = parameter;
        this.name = util_1.substituteReservedWords(parameter.name);
        this.reference = new index_1.GoTypeRef(parent.pkg.root, parameter.type);
    }
    toString() {
        const paramType = this.reference.scopedReference(this.parent.pkg);
        return `${this.name} ${this.parameter.variadic ? '...' : ''}${paramType}`;
    }
}
exports.GoParameter = GoParameter;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHlwZS1tZW1iZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJ0eXBlLW1lbWJlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSwrQ0FBcUU7QUFFckUsc0RBQXdEO0FBR3hELHdDQUFxRTtBQUNyRSxrQ0FBa0Q7QUFFbEQsbUNBQWtFO0FBY2xFOzs7RUFHRTtBQUNGLE1BQWEsVUFBVTtJQUtyQixZQUNTLE1BQWMsRUFDTCxRQUFrQjtRQUQzQixXQUFNLEdBQU4sTUFBTSxDQUFRO1FBQ0wsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQUVsQyxJQUFJLENBQUMsSUFBSSxHQUFHLDhCQUFnQixDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDakQsSUFBSSxDQUFDLFNBQVMsR0FBRyxRQUFRLENBQUMsU0FBUyxDQUFDO1FBRXBDLElBQUksUUFBUSxDQUFDLElBQUksRUFBRTtZQUNqQixJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksaUJBQVMsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRSxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUM7U0FDaEU7SUFDSCxDQUFDO0lBRUQsSUFBVyxtQkFBbUI7O1FBQzVCLE9BQU87WUFDTCxPQUFPLEVBQUUsSUFBSTtZQUNiLElBQUksRUFBRSxJQUFJLENBQUMsTUFBTTtZQUNqQixRQUFRLEVBQUUsS0FBSztZQUNmLElBQUksRUFBRSxDQUFDLFFBQUMsSUFBSSxDQUFDLFNBQVMsMENBQUUsbUJBQW1CLENBQUMsSUFBSSxDQUFBO1NBQ2pELENBQUM7SUFDSixDQUFDO0lBRUQsSUFBVyxNQUFNO1FBQ2YsT0FBTyxDQUFDLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUM7SUFDaEMsQ0FBQztJQUVELElBQVcsVUFBVTs7UUFDbkIsT0FBTyxhQUNMLElBQUksQ0FBQyxTQUFTLDBDQUFFLGVBQWUsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsb0NBQy9D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QUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQzFELENBQUM7Q0FDRjtBQXBERCw0QkFvREM7QUFFRCxNQUFhLFdBQVc7SUFJdEIsWUFDUyxNQUE2QixFQUNwQixTQUFvQjtRQUQ3QixXQUFNLEdBQU4sTUFBTSxDQUF1QjtRQUNwQixjQUFTLEdBQVQsU0FBUyxDQUFXO1FBRXBDLElBQUksQ0FBQyxJQUFJLEdBQUcsOEJBQXVCLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3BELElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxpQkFBUyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUNsRSxDQUFDO0lBRU0sUUFBUTtRQUNiLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDbEUsT0FBTyxHQUFHLElBQUksQ0FBQyxJQUFJLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsRUFBRSxHQUFHLFNBQVMsRUFBRSxDQUFDO0lBQzVFLENBQUM7Q0FDRjtBQWhCRCxrQ0FnQkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDYWxsYWJsZSwgTWV0aG9kLCBQYXJhbWV0ZXIsIFByb3BlcnR5IH0gZnJvbSAnanNpaS1yZWZsZWN0JztcblxuaW1wb3J0IHsganNpaVRvUGFzY2FsQ2FzZSB9IGZyb20gJy4uLy4uLy4uL25hbWluZy11dGlsJztcbmltcG9ydCB7IFNwZWNpYWxEZXBlbmRlbmNpZXMgfSBmcm9tICcuLi9kZXBlbmRlbmNpZXMnO1xuaW1wb3J0IHsgRW1pdENvbnRleHQgfSBmcm9tICcuLi9lbWl0LWNvbnRleHQnO1xuaW1wb3J0IHsgR2V0UHJvcGVydHksIEpTSUlfUlRfQUxJQVMsIFNldFByb3BlcnR5IH0gZnJvbSAnLi4vcnVudGltZSc7XG5pbXBvcnQgeyBzdWJzdGl0dXRlUmVzZXJ2ZWRXb3JkcyB9IGZyb20gJy4uL3V0aWwnO1xuXG5pbXBvcnQgeyBHb0NsYXNzLCBHb1R5cGUsIEdvSW50ZXJmYWNlLCBHb1R5cGVSZWYgfSBmcm9tICcuL2luZGV4JztcblxuLypcbiAqIFN0cnVjdHVyZSBmb3IgQ2xhc3MgYW5kIEludGVyZmFjZSBtZXRob2RzLiBVc2VmdWwgZm9yIHNoYXJpbmcgbG9naWMgZm9yIGRlcGVuZGVuY3kgcmVzb2x1dGlvblxuICovXG5leHBvcnQgaW50ZXJmYWNlIEdvVHlwZU1lbWJlciB7XG4gIG5hbWU6IHN0cmluZztcbiAgcGFyZW50OiBHb1R5cGU7XG4gIHJlZmVyZW5jZT86IEdvVHlwZVJlZjtcbiAgcmV0dXJuVHlwZTogc3RyaW5nO1xuXG4gIHNwZWNpYWxEZXBlbmRlbmNpZXM6IFNwZWNpYWxEZXBlbmRlbmNpZXM7XG59XG5cbi8qXG4gKiBHb1Byb3BlcnR5IGVuY2Fwc3VsYXRlcyBsb2dpYyBmb3IgcHVibGljIHByb3BlcnRpZXMgb24gYSBjb25jcmV0ZSBzdHJ1Y3QsIHdoaWNoIGNvdWxkIHJlcHJlc2VudFxuIGVpdGhlciBhIEpTSUkgY2xhc3MgcHJveHkgb3IgZGF0YXR5cGUgaW50ZXJmYWNlIHByb3h5XG4qL1xuZXhwb3J0IGNsYXNzIEdvUHJvcGVydHkgaW1wbGVtZW50cyBHb1R5cGVNZW1iZXIge1xuICBwdWJsaWMgcmVhZG9ubHkgbmFtZTogc3RyaW5nO1xuICBwdWJsaWMgcmVhZG9ubHkgcmVmZXJlbmNlPzogR29UeXBlUmVmO1xuICBwdWJsaWMgcmVhZG9ubHkgaW1tdXRhYmxlOiBib29sZWFuO1xuXG4gIHB1YmxpYyBjb25zdHJ1Y3RvcihcbiAgICBwdWJsaWMgcGFyZW50OiBHb1R5cGUsXG4gICAgcHVibGljIHJlYWRvbmx5IHByb3BlcnR5OiBQcm9wZXJ0eSxcbiAgKSB7XG4gICAgdGhpcy5uYW1lID0ganNpaVRvUGFzY2FsQ2FzZSh0aGlzLnByb3BlcnR5Lm5hbWUpO1xuICAgIHRoaXMuaW1tdXRhYmxlID0gcHJvcGVydHkuaW1tdXRhYmxlO1xuXG4gICAgaWYgKHByb3BlcnR5LnR5cGUpIHtcbiAgICAgIHRoaXMucmVmZXJlbmNlID0gbmV3IEdvVHlwZVJlZihwYXJlbnQucGtnLnJvb3QsIHByb3BlcnR5LnR5cGUpO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBnZXQgc3BlY2lhbERlcGVuZGVuY2llcygpOiBTcGVjaWFsRGVwZW5kZW5jaWVzIHtcbiAgICByZXR1cm4ge1xuICAgICAgcnVudGltZTogdHJ1ZSxcbiAgICAgIGluaXQ6IHRoaXMuc3RhdGljLFxuICAgICAgaW50ZXJuYWw6IGZhbHNlLFxuICAgICAgdGltZTogISF0aGlzLnJlZmVyZW5jZT8uc3BlY2lhbERlcGVuZGVuY2llcy50aW1lLFxuICAgIH07XG4gIH1cblxuICBwdWJsaWMgZ2V0IHN0YXRpYygpOiBib29sZWFuIHtcbiAgICByZXR1cm4gISF0aGlzLnByb3BlcnR5LnN0YXRpYztcbiAgfVxuXG4gIHB1YmxpYyBnZXQgcmV0dXJuVHlwZSgpOiBzdHJpbmcge1xuICAgIHJldHVybiAoXG4gICAgICB0aGlzLnJlZmVyZW5jZT8uc2NvcGVkUmVmZXJlbmNlKHRoaXMucGFyZW50LnBrZykgPz9cbiAgICAgIHRoaXMucHJvcGVydHkudHlwZS50b1N0cmluZygpXG4gICAgKTtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgaW5zdGFuY2VBcmcoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5wYXJlbnQucHJveHlOYW1lLnN1YnN0cmluZygwLCAxKS50b0xvd2VyQ2FzZSgpO1xuICB9XG5cbiAgcHVibGljIGdldCBvdmVycmlkZSgpOiBzdHJpbmcge1xuICAgIHJldHVybiBgJHtKU0lJX1JUX0FMSUFTfS5NZW1iZXJQcm9wZXJ0eXtKc2lpUHJvcGVydHk6IFwiJHt0aGlzLnByb3BlcnR5Lm5hbWV9XCIsIEdvR2V0dGVyOiBcIiR7dGhpcy5uYW1lfVwifWA7XG4gIH1cblxuICBwdWJsaWMgZW1pdFN0cnVjdE1lbWJlcih7IGNvZGUsIGRvY3VtZW50ZXIgfTogRW1pdENvbnRleHQpIHtcbiAgICBkb2N1bWVudGVyLmVtaXQodGhpcy5wcm9wZXJ0eS5kb2NzKTtcbiAgICBjb25zdCBtZW1iZXJUeXBlID1cbiAgICAgIHRoaXMucmVmZXJlbmNlPy50eXBlPy5uYW1lID09PSB0aGlzLnBhcmVudC5uYW1lXG4gICAgICAgID8gYCoke3RoaXMucmV0dXJuVHlwZX1gXG4gICAgICAgIDogdGhpcy5yZXR1cm5UeXBlO1xuXG4gICAgLy8gQWRkcyBqc29uIHRhZ3MgZm9yIGVhc3kgZGVzZXJpYWxpemF0aW9uXG4gICAgY29kZS5saW5lKGAke3RoaXMubmFtZX0gJHttZW1iZXJUeXBlfSBcXGBqc29uOlwiJHt0aGlzLnByb3BlcnR5Lm5hbWV9XCJcXGBgKTtcbiAgICAvLyBUT0RPIGFkZCBuZXdsaW5lIGlmIG5vdCB0aGUgbGFzdCBtZW1iZXJcbiAgfVxuXG4gIHB1YmxpYyBlbWl0R2V0dGVyRGVjbChjb250ZXh0OiBFbWl0Q29udGV4dCkge1xuICAgIGNvbnN0IHsgY29kZSB9ID0gY29udGV4dDtcbiAgICBjb2RlLmxpbmUoYCR7dGhpcy5uYW1lfSgpICR7dGhpcy5yZXR1cm5UeXBlfWApO1xuICB9XG5cbiAgcHVibGljIGVtaXRHZXR0ZXIoeyBjb2RlLCBkb2N1bWVudGVyIH06IEVtaXRDb250ZXh0KTogdm9pZCB7XG4gICAgY29uc3QgcmVjZWl2ZXIgPSB0aGlzLnBhcmVudC5uYW1lO1xuICAgIGNvbnN0IGluc3RhbmNlQXJnID0gcmVjZWl2ZXIuc3Vic3RyaW5nKDAsIDEpLnRvTG93ZXJDYXNlKCk7XG5cbiAgICBkb2N1bWVudGVyLmVtaXQodGhpcy5wcm9wZXJ0eS5kb2NzKTtcbiAgICBjb2RlLm9wZW5CbG9jayhcbiAgICAgIGBmdW5jICgke2luc3RhbmNlQXJnfSAqJHtyZWNlaXZlcn0pIEdldCR7dGhpcy5uYW1lfSgpICR7dGhpcy5yZXR1cm5UeXBlfWAsXG4gICAgKTtcbiAgICBjb2RlLmxpbmUoYHJldHVybiAke2luc3RhbmNlQXJnfS4ke3RoaXMubmFtZX1gKTtcbiAgICBjb2RlLmNsb3NlQmxvY2soKTtcbiAgfVxuXG4gIHB1YmxpYyBlbWl0U2V0dGVyRGVjbChjb250ZXh0OiBFbWl0Q29udGV4dCkge1xuICAgIGNvbnN0IHsgY29kZSB9ID0gY29udGV4dDtcbiAgICBpZiAoIXRoaXMuaW1tdXRhYmxlKSB7XG4gICAgICBjb2RlLmxpbmUoYFNldCR7dGhpcy5uYW1lfSh2YWwgJHt0aGlzLnJldHVyblR5cGV9KWApO1xuICAgIH1cbiAgfVxuXG4gIC8vIEVtaXRzIGdldHRlciBtZXRob2RzIG9uIHRoZSBzdHJ1Y3QgZm9yIGVhY2ggcHJvcGVydHlcbiAgcHVibGljIGVtaXRHZXR0ZXJQcm94eShjb250ZXh0OiBFbWl0Q29udGV4dCkge1xuICAgIGNvbnN0IHsgY29kZSB9ID0gY29udGV4dDtcbiAgICBjb25zdCByZWNlaXZlciA9IHRoaXMucGFyZW50LnByb3h5TmFtZTtcbiAgICBjb25zdCBpbnN0YW5jZUFyZyA9IHJlY2VpdmVyLnN1YnN0cmluZygwLCAxKS50b0xvd2VyQ2FzZSgpO1xuXG4gICAgY29kZS5vcGVuQmxvY2soXG4gICAgICBgZnVuYyAoJHtpbnN0YW5jZUFyZ30gKiR7cmVjZWl2ZXJ9KSAke3RoaXMubmFtZX0oKSAke3RoaXMucmV0dXJuVHlwZX1gLFxuICAgICk7XG5cbiAgICBuZXcgR2V0UHJvcGVydHkodGhpcykuZW1pdChjb2RlKTtcblxuICAgIGNvZGUuY2xvc2VCbG9jaygpO1xuICAgIGNvZGUubGluZSgpO1xuICB9XG5cbiAgcHVibGljIGVtaXRTZXR0ZXJQcm94eShjb250ZXh0OiBFbWl0Q29udGV4dCkge1xuICAgIGlmICghdGhpcy5pbW11dGFibGUpIHtcbiAgICAgIGNvbnN0IHsgY29kZSB9ID0gY29udGV4dDtcbiAgICAgIGNvbnN0IHJlY2VpdmVyID0gdGhpcy5wYXJlbnQucHJveHlOYW1lO1xuICAgICAgY29uc3QgaW5zdGFuY2VBcmcgPSByZWNlaXZlci5zdWJzdHJpbmcoMCwgMSkudG9Mb3dlckNhc2UoKTtcblxuICAgICAgY29kZS5vcGVuQmxvY2soXG4gICAgICAgIGBmdW5jICgke2luc3RhbmNlQXJnfSAqJHtyZWNlaXZlcn0pIFNldCR7dGhpcy5uYW1lfSh2YWwgJHt0aGlzLnJldHVyblR5cGV9KWAsXG4gICAgICApO1xuXG4gICAgICBuZXcgU2V0UHJvcGVydHkodGhpcykuZW1pdChjb2RlKTtcblxuICAgICAgY29kZS5jbG9zZUJsb2NrKCk7XG4gICAgICBjb2RlLmxpbmUoKTtcbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IGFic3RyYWN0IGNsYXNzIEdvTWV0aG9kIGltcGxlbWVudHMgR29UeXBlTWVtYmVyIHtcbiAgcHVibGljIHJlYWRvbmx5IG5hbWU6IHN0cmluZztcbiAgcHVibGljIHJlYWRvbmx5IHJlZmVyZW5jZT86IEdvVHlwZVJlZjtcbiAgcHVibGljIHJlYWRvbmx5IHBhcmFtZXRlcnM6IEdvUGFyYW1ldGVyW107XG5cbiAgcHVibGljIGNvbnN0cnVjdG9yKFxuICAgIHB1YmxpYyByZWFkb25seSBwYXJlbnQ6IEdvQ2xhc3MgfCBHb0ludGVyZmFjZSxcbiAgICBwdWJsaWMgcmVhZG9ubHkgbWV0aG9kOiBDYWxsYWJsZSxcbiAgKSB7XG4gICAgdGhpcy5uYW1lID0ganNpaVRvUGFzY2FsQ2FzZShtZXRob2QubmFtZSk7XG4gICAgaWYgKE1ldGhvZC5pc01ldGhvZChtZXRob2QpICYmIG1ldGhvZC5yZXR1cm5zLnR5cGUpIHtcbiAgICAgIHRoaXMucmVmZXJlbmNlID0gbmV3IEdvVHlwZVJlZihwYXJlbnQucGtnLnJvb3QsIG1ldGhvZC5yZXR1cm5zLnR5cGUpO1xuICAgIH1cbiAgICB0aGlzLnBhcmFtZXRlcnMgPSB0aGlzLm1ldGhvZC5wYXJhbWV0ZXJzLm1hcChcbiAgICAgIChwYXJhbSkgPT4gbmV3IEdvUGFyYW1ldGVyKHBhcmVudCwgcGFyYW0pLFxuICAgICk7XG4gIH1cblxuICBwdWJsaWMgYWJzdHJhY3QgZW1pdChjb250ZXh0OiBFbWl0Q29udGV4dCk6IHZvaWQ7XG5cbiAgcHVibGljIGFic3RyYWN0IGdldCBzcGVjaWFsRGVwZW5kZW5jaWVzKCk6IFNwZWNpYWxEZXBlbmRlbmNpZXM7XG5cbiAgcHVibGljIGdldCByZXR1cm5zUmVmKCk6IGJvb2xlYW4ge1xuICAgIGlmIChcbiAgICAgIHRoaXMucmVmZXJlbmNlPy50eXBlPy50eXBlLmlzQ2xhc3NUeXBlKCkgfHxcbiAgICAgIHRoaXMucmVmZXJlbmNlPy50eXBlPy50eXBlLmlzSW50ZXJmYWNlVHlwZSgpXG4gICAgKSB7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG5cbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICBwdWJsaWMgZ2V0IHJldHVyblR5cGUoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gKFxuICAgICAgdGhpcy5yZWZlcmVuY2U/LnNjb3BlZFJlZmVyZW5jZSh0aGlzLnBhcmVudC5wa2cpID8/IHRoaXMubWV0aG9kLnRvU3RyaW5nKClcbiAgICApO1xuICB9XG5cbiAgcHVibGljIGdldCBpbnN0YW5jZUFyZygpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLnBhcmVudC5uYW1lLnN1YnN0cmluZygwLCAxKS50b0xvd2VyQ2FzZSgpO1xuICB9XG5cbiAgcHVibGljIGdldCBvdmVycmlkZSgpOiBzdHJpbmcge1xuICAgIHJldHVybiBgJHtKU0lJX1JUX0FMSUFTfS5NZW1iZXJNZXRob2R7SnNpaU1ldGhvZDogXCIke3RoaXMubWV0aG9kLm5hbWV9XCIsIEdvTWV0aG9kOiBcIiR7dGhpcy5uYW1lfVwifWA7XG4gIH1cblxuICBwdWJsaWMgcGFyYW1TdHJpbmcoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5wYXJhbWV0ZXJzLmxlbmd0aCA9PT0gMFxuICAgICAgPyAnJ1xuICAgICAgOiB0aGlzLnBhcmFtZXRlcnMubWFwKChwKSA9PiBwLnRvU3RyaW5nKCkpLmpvaW4oJywgJyk7XG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIEdvUGFyYW1ldGVyIHtcbiAgcHVibGljIHJlYWRvbmx5IG5hbWU6IHN0cmluZztcbiAgcHVibGljIHJlYWRvbmx5IHJlZmVyZW5jZTogR29UeXBlUmVmO1xuXG4gIHB1YmxpYyBjb25zdHJ1Y3RvcihcbiAgICBwdWJsaWMgcGFyZW50OiBHb0NsYXNzIHwgR29JbnRlcmZhY2UsXG4gICAgcHVibGljIHJlYWRvbmx5IHBhcmFtZXRlcjogUGFyYW1ldGVyLFxuICApIHtcbiAgICB0aGlzLm5hbWUgPSBzdWJzdGl0dXRlUmVzZXJ2ZWRXb3JkcyhwYXJhbWV0ZXIubmFtZSk7XG4gICAgdGhpcy5yZWZlcmVuY2UgPSBuZXcgR29UeXBlUmVmKHBhcmVudC5wa2cucm9vdCwgcGFyYW1ldGVyLnR5cGUpO1xuICB9XG5cbiAgcHVibGljIHRvU3RyaW5nKCk6IHN0cmluZyB7XG4gICAgY29uc3QgcGFyYW1UeXBlID0gdGhpcy5yZWZlcmVuY2Uuc2NvcGVkUmVmZXJlbmNlKHRoaXMucGFyZW50LnBrZyk7XG4gICAgcmV0dXJuIGAke3RoaXMubmFtZX0gJHt0aGlzLnBhcmFtZXRlci52YXJpYWRpYyA/ICcuLi4nIDogJyd9JHtwYXJhbVR5cGV9YDtcbiAgfVxufVxuIl19