"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.GoInterface = void 0;
const comparators = require("../comparators");
const runtime_1 = require("../runtime");
const util_1 = require("../util");
const go_type_1 = require("./go-type");
const go_type_reference_1 = require("./go-type-reference");
const type_member_1 = require("./type-member");
class GoInterface extends go_type_1.GoType {
    constructor(pkg, type) {
        super(pkg, type);
        this.type = type;
        this.methods = type.ownMethods
            .map((method) => new InterfaceMethod(this, method))
            .sort(comparators.byName);
        this.properties = type.ownProperties
            .map((prop) => new InterfaceProperty(this, prop))
            .sort(comparators.byName);
        // If there is more than one base, and any ancestor (including transitive)
        // comes from a different assembly, we will re-implement all members on the
        // proxy struct, as otherwise we run the risk of un-promotable methods
        // caused by inheriting the same interface via multiple paths (since we have
        // to represent those as embedded types).
        if (type.interfaces.length > 1 &&
            type
                .getInterfaces(true)
                .some((ancestor) => ancestor.assembly.fqn !== type.assembly.fqn)) {
            this.reimplementedMethods = type.allMethods
                .filter((method) => !method.static && method.definingType !== type)
                .map((method) => new InterfaceMethod(this, method))
                .sort(comparators.byName);
            this.reimplementedProperties = type.allProperties
                .filter((property) => !property.static && property.definingType !== type)
                .map((property) => new InterfaceProperty(this, property))
                .sort(comparators.byName);
        }
    }
    emit(context) {
        var _a, _b;
        this.emitDocs(context);
        const { code } = context;
        code.openBlock(`type ${this.name} interface`);
        // embed extended interfaces
        for (const iface of this.extends) {
            code.line(new go_type_reference_1.GoTypeRef(this.pkg.root, iface.type.reference).scopedName(this.pkg));
        }
        for (const method of this.methods) {
            method.emitDecl(context);
        }
        for (const prop of this.properties) {
            prop.emit(context);
        }
        code.closeBlock();
        code.line();
        code.line(`// The jsii proxy for ${this.name}`);
        code.openBlock(`type ${this.proxyName} struct`);
        if (this.extends.length === 0) {
            // Ensure this is not 0-width
            code.line('_ byte // padding');
        }
        else {
            for (const base of this.extends) {
                code.line(this.pkg.resolveEmbeddedType(base).embed);
            }
        }
        code.closeBlock();
        code.line();
        for (const method of this.methods) {
            method.emit(context);
        }
        for (const method of (_a = this.reimplementedMethods) !== null && _a !== void 0 ? _a : []) {
            method.emit(context);
        }
        for (const prop of this.properties) {
            prop.emitGetterProxy(context);
            if (!prop.immutable) {
                prop.emitSetterProxy(context);
            }
        }
        for (const prop of (_b = this.reimplementedProperties) !== null && _b !== void 0 ? _b : []) {
            prop.emitGetterProxy(context);
            if (!prop.immutable) {
                prop.emitSetterProxy(context);
            }
        }
    }
    emitRegistration(code) {
        code.open(`${runtime_1.JSII_RT_ALIAS}.RegisterInterface(`);
        code.line(`"${this.fqn}",`);
        code.line(`reflect.TypeOf((*${this.name})(nil)).Elem(),`);
        const allMembers = [
            ...this.type.allMethods
                .filter((method) => !method.static)
                .map((method) => new InterfaceMethod(this, method)),
            ...this.type.allProperties
                .filter((property) => !property.static)
                .map((property) => new type_member_1.GoProperty(this, property)),
        ].sort(comparators.byName);
        if (allMembers.length === 0) {
            code.line('nil, // no members');
        }
        else {
            code.open(`[]${runtime_1.JSII_RT_ALIAS}.Member{`);
            for (const member of allMembers) {
                code.line(`${member.override},`);
            }
            code.close('},');
        }
        this.emitProxyMakerFunction(code, this.extends);
        code.close(')');
    }
    get specialDependencies() {
        return [
            ...this.properties.map((p) => p.specialDependencies),
            ...this.methods.map((m) => m.specialDependencies),
        ].reduce((acc, elt) => ({
            runtime: acc.runtime || elt.runtime,
            init: acc.init || elt.init,
            internal: acc.internal,
            time: acc.time || elt.time,
        }), {
            runtime: false,
            init: false,
            internal: this.extends.some((base) => this.pkg.isExternalType(base)),
            time: false,
        });
    }
    get extends() {
        return this.type.interfaces
            .map((iface) => this.pkg.root.findType(iface.fqn))
            .sort(comparators.byName);
    }
    get extendsDependencies() {
        const packages = [];
        for (const ifaceRef of this.extends) {
            const pkg = ifaceRef.pkg;
            if (pkg) {
                packages.push(pkg);
            }
        }
        return packages;
    }
    get dependencies() {
        return [
            ...this.extendsDependencies,
            ...util_1.getMemberDependencies(this.methods),
            ...util_1.getParamDependencies(this.methods),
            ...util_1.getMemberDependencies(this.properties),
        ];
    }
}
exports.GoInterface = GoInterface;
class InterfaceProperty extends type_member_1.GoProperty {
    constructor(parent, property) {
        super(parent, property);
        this.parent = parent;
        this.property = property;
    }
    get returnType() {
        var _a, _b;
        return ((_b = (_a = this.reference) === null || _a === void 0 ? void 0 : _a.scopedReference(this.parent.pkg)) !== null && _b !== void 0 ? _b : this.property.type.toString());
    }
    emit({ code, documenter }) {
        documenter.emit(this.property.docs);
        code.line(`${this.name}() ${this.returnType}`);
        if (!this.property.immutable) {
            documenter.emit(this.property.docs);
            code.line(`Set${this.name}(${this.name[0].toLowerCase()} ${this.returnType})`);
        }
    }
}
class InterfaceMethod extends type_member_1.GoMethod {
    constructor(parent, method) {
        super(parent, method);
        this.parent = parent;
        this.method = method;
        this.runtimeCall = new runtime_1.MethodCall(this);
    }
    emitDecl(context) {
        const docs = this.method.docs;
        if (docs) {
            context.documenter.emit(docs);
        }
        const { code } = context;
        code.line(`${this.name}(${this.paramString()})${this.returnTypeString}`);
    }
    emit({ code }) {
        const name = this.name;
        code.openBlock(`func (${this.instanceArg} *${this.parent.proxyName}) ${name}(${this.paramString()})${this.returnTypeString}`);
        this.runtimeCall.emit(code);
        code.closeBlock();
        code.line();
    }
    get specialDependencies() {
        var _a;
        return {
            runtime: true,
            init: false,
            internal: false,
            time: this.parameters.some((p) => p.reference.specialDependencies.time) ||
                !!((_a = this.reference) === null || _a === void 0 ? void 0 : _a.specialDependencies.time),
        };
    }
    get returnTypeString() {
        var _a;
        return ((_a = this.reference) === null || _a === void 0 ? void 0 : _a.void) ? '' : ` ${this.returnType}`;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW50ZXJmYWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiaW50ZXJmYWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUdBLDhDQUE4QztBQUk5Qyx3Q0FBdUQ7QUFDdkQsa0NBQXNFO0FBQ3RFLHVDQUFtQztBQUNuQywyREFBZ0Q7QUFDaEQsK0NBQXFEO0FBRXJELE1BQWEsV0FBWSxTQUFRLGdCQUFNO0lBTXJDLFlBQW1CLEdBQVksRUFBUyxJQUFtQjtRQUN6RCxLQUFLLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxDQUFDO1FBRHFCLFNBQUksR0FBSixJQUFJLENBQWU7UUFHekQsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUMsVUFBVTthQUMzQixHQUFHLENBQUMsQ0FBQyxNQUFNLEVBQUUsRUFBRSxDQUFDLElBQUksZUFBZSxDQUFDLElBQUksRUFBRSxNQUFNLENBQUMsQ0FBQzthQUNsRCxJQUFJLENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBRTVCLElBQUksQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDLGFBQWE7YUFDakMsR0FBRyxDQUFDLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxJQUFJLGlCQUFpQixDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQzthQUNoRCxJQUFJLENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBRTVCLDBFQUEwRTtRQUMxRSwyRUFBMkU7UUFDM0Usc0VBQXNFO1FBQ3RFLDRFQUE0RTtRQUM1RSx5Q0FBeUM7UUFDekMsSUFDRSxJQUFJLENBQUMsVUFBVSxDQUFDLE1BQU0sR0FBRyxDQUFDO1lBQzFCLElBQUk7aUJBQ0QsYUFBYSxDQUFDLElBQUksQ0FBQztpQkFDbkIsSUFBSSxDQUFDLENBQUMsUUFBUSxFQUFFLEVBQUUsQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLEdBQUcsS0FBSyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxFQUNsRTtZQUNBLElBQUksQ0FB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QUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLENBQUM7Z0JBQ2pFLENBQUMsUUFBQyxJQUFJLENBQUMsU0FBUywwQ0FBRSxtQkFBbUIsQ0FBQyxJQUFJLENBQUE7U0FDN0MsQ0FBQztJQUNKLENBQUM7SUFFRCxJQUFZLGdCQUFnQjs7UUFDMUIsT0FBTyxPQUFBLElBQUksQ0FBQyxTQUFTLDBDQUFFLElBQUksRUFBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQztJQUMzRCxDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb2RlTWFrZXIgfSBmcm9tICdjb2RlbWFrZXInO1xuaW1wb3J0IHsgSW50ZXJmYWNlVHlwZSwgTWV0aG9kLCBQcm9wZXJ0eSB9IGZyb20gJ2pzaWktcmVmbGVjdCc7XG5cbmltcG9ydCAqIGFzIGNvbXBhcmF0b3JzIGZyb20gJy4uL2NvbXBhcmF0b3JzJztcbmltcG9ydCB7IFNwZWNpYWxEZXBlbmRlbmNpZXMgfSBmcm9tICcuLi9kZXBlbmRlbmNpZXMnO1xuaW1wb3J0IHsgRW1pdENvbnRleHQgfSBmcm9tICcuLi9lbWl0LWNvbnRleHQnO1xuaW1wb3J0IHsgUGFja2FnZSB9IGZyb20gJy4uL3BhY2thZ2UnO1xuaW1wb3J0IHsgSlNJSV9SVF9BTElBUywgTWV0aG9kQ2FsbCB9IGZyb20gJy4uL3J1bnRpbWUnO1xuaW1wb3J0IHsgZ2V0TWVtYmVyRGVwZW5kZW5jaWVzLCBnZXRQYXJhbURlcGVuZGVuY2llcyB9IGZyb20gJy4uL3V0aWwnO1xuaW1wb3J0IHsgR29UeXBlIH0gZnJvbSAnLi9nby10eXBlJztcbmltcG9ydCB7IEdvVHlwZVJlZiB9IGZyb20gJy4vZ28tdHlwZS1yZWZlcmVuY2UnO1xuaW1wb3J0IHsgR29NZXRob2QsIEdvUHJvcGVydHkgfSBmcm9tICcuL3R5cGUtbWVtYmVyJztcblxuZXhwb3J0IGNsYXNzIEdvSW50ZXJmYWNlIGV4dGVuZHMgR29UeXBlIHtcbiAgcHVibGljIHJlYWRvbmx5IG1ldGhvZHM6IEludGVyZmFjZU1ldGhvZFtdO1xuICBwdWJsaWMgcmVhZG9ubHkgcmVpbXBsZW1lbnRlZE1ldGhvZHM/OiByZWFkb25seSBJbnRlcmZhY2VNZXRob2RbXTtcbiAgcHVibGljIHJlYWRvbmx5IHByb3BlcnRpZXM6IEludGVyZmFjZVByb3BlcnR5W107XG4gIHB1YmxpYyByZWFkb25seSByZWltcGxlbWVudGVkUHJvcGVydGllcz86IHJlYWRvbmx5IEludGVyZmFjZVByb3BlcnR5W107XG5cbiAgcHVibGljIGNvbnN0cnVjdG9yKHBrZzogUGFja2FnZSwgcHVibGljIHR5cGU6IEludGVyZmFjZVR5cGUpIHtcbiAgICBzdXBlcihwa2csIHR5cGUpO1xuXG4gICAgdGhpcy5tZXRob2RzID0gdHlwZS5vd25NZXRob2RzXG4gICAgICAubWFwKChtZXRob2QpID0+IG5ldyBJbnRlcmZhY2VNZXRob2QodGhpcywgbWV0aG9kKSlcbiAgICAgIC5zb3J0KGNvbXBhcmF0b3JzLmJ5TmFtZSk7XG5cbiAgICB0aGlzLnByb3BlcnRpZXMgPSB0eXBlLm93blByb3BlcnRpZXNcbiAgICAgIC5tYXAoKHByb3ApID0+IG5ldyBJbnRlcmZhY2VQcm9wZXJ0eSh0aGlzLCBwcm9wKSlcbiAgICAgIC5zb3J0KGNvbXBhcmF0b3JzLmJ5TmFtZSk7XG5cbiAgICAvLyBJZiB0aGVyZSBpcyBtb3JlIHRoYW4gb25lIGJhc2UsIGFuZCBhbnkgYW5jZXN0b3IgKGluY2x1ZGluZyB0cmFuc2l0aXZlKVxuICAgIC8vIGNvbWVzIGZyb20gYSBkaWZmZXJlbnQgYXNzZW1ibHksIHdlIHdpbGwgcmUtaW1wbGVtZW50IGFsbCBtZW1iZXJzIG9uIHRoZVxuICAgIC8vIHByb3h5IHN0cnVjdCwgYXMgb3RoZXJ3aXNlIHdlIHJ1biB0aGUgcmlzayBvZiB1bi1wcm9tb3RhYmxlIG1ldGhvZHNcbiAgICAvLyBjYXVzZWQgYnkgaW5oZXJpdGluZyB0aGUgc2FtZSBpbnRlcmZhY2UgdmlhIG11bHRpcGxlIHBhdGhzIChzaW5jZSB3ZSBoYXZlXG4gICAgLy8gdG8gcmVwcmVzZW50IHRob3NlIGFzIGVtYmVkZGVkIHR5cGVzKS5cbiAgICBpZiAoXG4gICAgICB0eXBlLmludGVyZmFjZXMubGVuZ3RoID4gMSAmJlxuICAgICAgdHlwZVxuICAgICAgICAuZ2V0SW50ZXJmYWNlcyh0cnVlKVxuICAgICAgICAuc29tZSgoYW5jZXN0b3IpID0+IGFuY2VzdG9yLmFzc2VtYmx5LmZxbiAhPT0gdHlwZS5hc3NlbWJseS5mcW4pXG4gICAgKSB7XG4gICAgICB0aGlzLnJlaW1wbGVtZW50ZWRNZXRob2RzID0gdHlwZS5hbGxNZXRob2RzXG4gICAgICAgIC5maWx0ZXIoKG1ldGhvZCkgPT4gIW1ldGhvZC5zdGF0aWMgJiYgbWV0aG9kLmRlZmluaW5nVHlwZSAhPT0gdHlwZSlcbiAgICAgICAgLm1hcCgobWV0aG9kKSA9PiBuZXcgSW50ZXJmYWNlTWV0aG9kKHRoaXMsIG1ldGhvZCkpXG4gICAgICAgIC5zb3J0KGNvbXBhcmF0b3JzLmJ5TmFtZSk7XG5cbiAgICAgIHRoaXMucmVpbXBsZW1lbnRlZFByb3BlcnRpZXMgPSB0eXBlLmFsbFByb3BlcnRpZXNcbiAgICAgICAgLmZpbHRlcihcbiAgICAgICAgICAocHJvcGVydHkpID0+ICFwcm9wZXJ0eS5zdGF0aWMgJiYgcHJvcGVydHkuZGVmaW5pbmdUeXBlICE9PSB0eXBlLFxuICAgICAgICApXG4gICAgICAgIC5tYXAoKHByb3BlcnR5KSA9PiBuZXcgSW50ZXJmYWNlUHJvcGVydHkodGhpcywgcHJvcGVydHkpKVxuICAgICAgICAuc29ydChjb21wYXJhdG9ycy5ieU5hbWUpO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBlbWl0KGNvbnRleHQ6IEVtaXRDb250ZXh0KSB7XG4gICAgdGhpcy5lbWl0RG9jcyhjb250ZXh0KTtcblxuICAgIGNvbnN0IHsgY29kZSB9ID0gY29udGV4dDtcbiAgICBjb2RlLm9wZW5CbG9jayhgdHlwZSAke3RoaXMubmFtZX0gaW50ZXJmYWNlYCk7XG5cbiAgICAvLyBlbWJlZCBleHRlbmRlZCBpbnRlcmZhY2VzXG4gICAgZm9yIChjb25zdCBpZmFjZSBvZiB0aGlzLmV4dGVuZHMpIHtcbiAgICAgIGNvZGUubGluZShcbiAgICAgICAgbmV3IEdvVHlwZVJlZih0aGlzLnBrZy5yb290LCBpZmFjZS50eXBlLnJlZmVyZW5jZSkuc2NvcGVkTmFtZSh0aGlzLnBrZyksXG4gICAgICApO1xuICAgIH1cblxuICAgIGZvciAoY29uc3QgbWV0aG9kIG9mIHRoaXMubWV0aG9kcykge1xuICAgICAgbWV0aG9kLmVtaXREZWNsKGNvbnRleHQpO1xuICAgIH1cblxuICAgIGZvciAoY29uc3QgcHJvcCBvZiB0aGlzLnByb3BlcnRpZXMpIHtcbiAgICAgIHByb3AuZW1pdChjb250ZXh0KTtcbiAgICB9XG5cbiAgICBjb2RlLmNsb3NlQmxvY2soKTtcbiAgICBjb2RlLmxpbmUoKTtcblxuICAgIGNvZGUubGluZShgLy8gVGhlIGpzaWkgcHJveHkgZm9yICR7dGhpcy5uYW1lfWApO1xuICAgIGNvZGUub3BlbkJsb2NrKGB0eXBlICR7dGhpcy5wcm94eU5hbWV9IHN0cnVjdGApO1xuICAgIGlmICh0aGlzLmV4dGVuZHMubGVuZ3RoID09PSAwKSB7XG4gICAgICAvLyBFbnN1cmUgdGhpcyBpcyBub3QgMC13aWR0aFxuICAgICAgY29kZS5saW5lKCdfIGJ5dGUgLy8gcGFkZGluZycpO1xuICAgIH0gZWxzZSB7XG4gICAgICBmb3IgKGNvbnN0IGJhc2Ugb2YgdGhpcy5leHRlbmRzKSB7XG4gICAgICAgIGNvZGUubGluZSh0aGlzLnBrZy5yZXNvbHZlRW1iZWRkZWRUeXBlKGJhc2UpLmVtYmVkKTtcbiAgICAgIH1cbiAgICB9XG4gICAgY29kZS5jbG9zZUJsb2NrKCk7XG4gICAgY29kZS5saW5lKCk7XG5cbiAgICBmb3IgKGNvbnN0IG1ldGhvZCBvZiB0aGlzLm1ldGhvZHMpIHtcbiAgICAgIG1ldGhvZC5lbWl0KGNvbnRleHQpO1xuICAgIH1cblxuICAgIGZvciAoY29uc3QgbWV0aG9kIG9mIHRoaXMucmVpbXBsZW1lbnRlZE1ldGhvZHMgPz8gW10pIHtcbiAgICAgIG1ldGhvZC5lbWl0KGNvbnRleHQpO1xuICAgIH1cblxuICAgIGZvciAoY29uc3QgcHJvcCBvZiB0aGlzLnByb3BlcnRpZXMpIHtcbiAgICAgIHByb3AuZW1pdEdldHRlclByb3h5KGNvbnRleHQpO1xuXG4gICAgICBpZiAoIXByb3AuaW1tdXRhYmxlKSB7XG4gICAgICAgIHByb3AuZW1pdFNldHRlclByb3h5KGNvbnRleHQpO1xuICAgICAgfVxuICAgIH1cblxuICAgIGZvciAoY29uc3QgcHJvcCBvZiB0aGlzLnJlaW1wbGVtZW50ZWRQcm9wZXJ0aWVzID8/IFtdKSB7XG4gICAgICBwcm9wLmVtaXRHZXR0ZXJQcm94eShjb250ZXh0KTtcblxuICAgICAgaWYgKCFwcm9wLmltbXV0YWJsZSkge1xuICAgICAgICBwcm9wLmVtaXRTZXR0ZXJQcm94eShjb250ZXh0KTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwdWJsaWMgZW1pdFJlZ2lzdHJhdGlvbihjb2RlOiBDb2RlTWFrZXIpOiB2b2lkIHtcbiAgICBjb2RlLm9wZW4oYCR7SlNJSV9SVF9BTElBU30uUmVnaXN0ZXJJbnRlcmZhY2UoYCk7XG4gICAgY29kZS5saW5lKGBcIiR7dGhpcy5mcW59XCIsYCk7XG4gICAgY29kZS5saW5lKGByZWZsZWN0LlR5cGVPZigoKiR7dGhpcy5uYW1lfSkobmlsKSkuRWxlbSgpLGApO1xuXG4gICAgY29uc3QgYWxsTWVtYmVycyA9IFtcbiAgICAgIC4uLnRoaXMudHlwZS5hbGxNZXRob2RzXG4gICAgICAgIC5maWx0ZXIoKG1ldGhvZCkgPT4gIW1ldGhvZC5zdGF0aWMpXG4gICAgICAgIC5tYXAoKG1ldGhvZCkgPT4gbmV3IEludGVyZmFjZU1ldGhvZCh0aGlzLCBtZXRob2QpKSxcbiAgICAgIC4uLnRoaXMudHlwZS5hbGxQcm9wZXJ0aWVzXG4gICAgICAgIC5maWx0ZXIoKHByb3BlcnR5KSA9PiAhcHJvcGVydHkuc3RhdGljKVxuICAgICAgICAubWFwKChwcm9wZXJ0eSkgPT4gbmV3IEdvUHJvcGVydHkodGhpcywgcHJvcGVydHkpKSxcbiAgICBdLnNvcnQoY29tcGFyYXRvcnMuYnlOYW1lKTtcbiAgICBpZiAoYWxsTWVtYmVycy5sZW5ndGggPT09IDApIHtcbiAgICAgIGNvZGUubGluZSgnbmlsLCAvLyBubyBtZW1iZXJzJyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvZGUub3BlbihgW10ke0pTSUlfUlRfQUxJQVN9Lk1lbWJlcntgKTtcbiAgICAgIGZvciAoY29uc3QgbWVtYmVyIG9mIGFsbE1lbWJlcnMpIHtcbiAgICAgICAgY29kZS5saW5lKGAke21lbWJlci5vdmVycmlkZX0sYCk7XG4gICAgICB9XG4gICAgICBjb2RlLmNsb3NlKCd9LCcpO1xuICAgIH1cblxuICAgIHRoaXMuZW1pdFByb3h5TWFrZXJGdW5jdGlvbihjb2RlLCB0aGlzLmV4dGVuZHMpO1xuICAgIGNvZGUuY2xvc2UoJyknKTtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgc3BlY2lhbERlcGVuZGVuY2llcygpOiBTcGVjaWFsRGVwZW5kZW5jaWVzIHtcbiAgICByZXR1cm4gW1xuICAgICAgLi4udGhpcy5wcm9wZXJ0aWVzLm1hcCgocCkgPT4gcC5zcGVjaWFsRGVwZW5kZW5jaWVzKSxcbiAgICAgIC4uLnRoaXMubWV0aG9kcy5tYXAoKG0pID0+IG0uc3BlY2lhbERlcGVuZGVuY2llcyksXG4gICAgXS5yZWR1Y2UoXG4gICAgICAoYWNjLCBlbHQpID0+ICh7XG4gICAgICAgIHJ1bnRpbWU6IGFjYy5ydW50aW1lIHx8IGVsdC5ydW50aW1lLFxuICAgICAgICBpbml0OiBhY2MuaW5pdCB8fCBlbHQuaW5pdCxcbiAgICAgICAgaW50ZXJuYWw6IGFjYy5pbnRlcm5hbCxcbiAgICAgICAgdGltZTogYWNjLnRpbWUgfHwgZWx0LnRpbWUsXG4gICAgICB9KSxcbiAgICAgIHtcbiAgICAgICAgcnVudGltZTogZmFsc2UsXG4gICAgICAgIGluaXQ6IGZhbHNlLFxuICAgICAgICBpbnRlcm5hbDogdGhpcy5leHRlbmRzLnNvbWUoKGJhc2UpID0+IHRoaXMucGtnLmlzRXh0ZXJuYWxUeXBlKGJhc2UpKSxcbiAgICAgICAgdGltZTogZmFsc2UsXG4gICAgICB9LFxuICAgICk7XG4gIH1cblxuICBwdWJsaWMgZ2V0IGV4dGVuZHMoKTogR29JbnRlcmZhY2VbXSB7XG4gICAgcmV0dXJuIHRoaXMudHlwZS5pbnRlcmZhY2VzXG4gICAgICAubWFwKChpZmFjZSkgPT4gdGhpcy5wa2cucm9vdC5maW5kVHlwZShpZmFjZS5mcW4pIGFzIEdvSW50ZXJmYWNlKVxuICAgICAgLnNvcnQoY29tcGFyYXRvcnMuYnlOYW1lKTtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgZXh0ZW5kc0RlcGVuZGVuY2llcygpOiBQYWNrYWdlW10ge1xuICAgIGNvbnN0IHBhY2thZ2VzOiBQYWNrYWdlW10gPSBbXTtcbiAgICBmb3IgKGNvbnN0IGlmYWNlUmVmIG9mIHRoaXMuZXh0ZW5kcykge1xuICAgICAgY29uc3QgcGtnID0gaWZhY2VSZWYucGtnO1xuICAgICAgaWYgKHBrZykge1xuICAgICAgICBwYWNrYWdlcy5wdXNoKHBrZyk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHBhY2thZ2VzO1xuICB9XG5cbiAgcHVibGljIGdldCBkZXBlbmRlbmNpZXMoKTogUGFja2FnZVtdIHtcbiAgICByZXR1cm4gW1xuICAgICAgLi4udGhpcy5leHRlbmRzRGVwZW5kZW5jaWVzLFxuICAgICAgLi4uZ2V0TWVtYmVyRGVwZW5kZW5jaWVzKHRoaXMubWV0aG9kcyksXG4gICAgICAuLi5nZXRQYXJhbURlcGVuZGVuY2llcyh0aGlzLm1ldGhvZHMpLFxuICAgICAgLi4uZ2V0TWVtYmVyRGVwZW5kZW5jaWVzKHRoaXMucHJvcGVydGllcyksXG4gICAgXTtcbiAgfVxufVxuXG5jbGFzcyBJbnRlcmZhY2VQcm9wZXJ0eSBleHRlbmRzIEdvUHJvcGVydHkge1xuICBwdWJsaWMgcmVhZG9ubHkgcmVmZXJlbmNlPzogR29UeXBlUmVmO1xuXG4gIHB1YmxpYyBjb25zdHJ1Y3RvcihcbiAgICBwdWJsaWMgcmVhZG9ubHkgcGFyZW50OiBHb0ludGVyZmFjZSxcbiAgICBwdWJsaWMgcmVhZG9ubHkgcHJvcGVydHk6IFByb3BlcnR5LFxuICApIHtcbiAgICBzdXBlcihwYXJlbnQsIHByb3BlcnR5KTtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgcmV0dXJuVHlwZSgpOiBzdHJpbmcge1xuICAgIHJldHVybiAoXG4gICAgICB0aGlzLnJlZmVyZW5jZT8uc2NvcGVkUmVmZXJlbmNlKHRoaXMucGFyZW50LnBrZykgPz9cbiAgICAgIHRoaXMucHJvcGVydHkudHlwZS50b1N0cmluZygpXG4gICAgKTtcbiAgfVxuXG4gIHB1YmxpYyBlbWl0KHsgY29kZSwgZG9jdW1lbnRlciB9OiBFbWl0Q29udGV4dCkge1xuICAgIGRvY3VtZW50ZXIuZW1pdCh0aGlzLnByb3BlcnR5LmRvY3MpO1xuICAgIGNvZGUubGluZShgJHt0aGlzLm5hbWV9KCkgJHt0aGlzLnJldHVyblR5cGV9YCk7XG5cbiAgICBpZiAoIXRoaXMucHJvcGVydHkuaW1tdXRhYmxlKSB7XG4gICAgICBkb2N1bWVudGVyLmVtaXQodGhpcy5wcm9wZXJ0eS5kb2NzKTtcbiAgICAgIGNvZGUubGluZShcbiAgICAgICAgYFNldCR7dGhpcy5uYW1lfSgke3RoaXMubmFtZVswXS50b0xvd2VyQ2FzZSgpfSAke3RoaXMucmV0dXJuVHlwZX0pYCxcbiAgICAgICk7XG4gICAgfVxuICB9XG59XG5cbmNsYXNzIEludGVyZmFjZU1ldGhvZCBleHRlbmRzIEdvTWV0aG9kIHtcbiAgcHVibGljIHJlYWRvbmx5IHJ1bnRpbWVDYWxsOiBNZXRob2RDYWxsO1xuXG4gIHB1YmxpYyBjb25zdHJ1Y3RvcihcbiAgICBwdWJsaWMgcmVhZG9ubHkgcGFyZW50OiBHb0ludGVyZmFjZSxcbiAgICBwdWJsaWMgcmVhZG9ubHkgbWV0aG9kOiBNZXRob2QsXG4gICkge1xuICAgIHN1cGVyKHBhcmVudCwgbWV0aG9kKTtcbiAgICB0aGlzLnJ1bnRpbWVDYWxsID0gbmV3IE1ldGhvZENhbGwodGhpcyk7XG4gIH1cblxuICBwdWJsaWMgZW1pdERlY2woY29udGV4dDogRW1pdENvbnRleHQpIHtcbiAgICBjb25zdCBkb2NzID0gdGhpcy5tZXRob2QuZG9jcztcbiAgICBpZiAoZG9jcykge1xuICAgICAgY29udGV4dC5kb2N1bWVudGVyLmVtaXQoZG9jcyk7XG4gICAgfVxuICAgIGNvbnN0IHsgY29kZSB9ID0gY29udGV4dDtcbiAgICBjb2RlLmxpbmUoYCR7dGhpcy5uYW1lfSgke3RoaXMucGFyYW1TdHJpbmcoKX0pJHt0aGlzLnJldHVyblR5cGVTdHJpbmd9YCk7XG4gIH1cblxuICBwdWJsaWMgZW1pdCh7IGNvZGUgfTogRW1pdENvbnRleHQpIHtcbiAgICBjb25zdCBuYW1lID0gdGhpcy5uYW1lO1xuICAgIGNvZGUub3BlbkJsb2NrKFxuICAgICAgYGZ1bmMgKCR7dGhpcy5pbnN0YW5jZUFyZ30gKiR7XG4gICAgICAgIHRoaXMucGFyZW50LnByb3h5TmFtZVxuICAgICAgfSkgJHtuYW1lfSgke3RoaXMucGFyYW1TdHJpbmcoKX0pJHt0aGlzLnJldHVyblR5cGVTdHJpbmd9YCxcbiAgICApO1xuXG4gICAgdGhpcy5ydW50aW1lQ2FsbC5lbWl0KGNvZGUpO1xuXG4gICAgY29kZS5jbG9zZUJsb2NrKCk7XG4gICAgY29kZS5saW5lKCk7XG4gIH1cblxuICBwdWJsaWMgZ2V0IHNwZWNpYWxEZXBlbmRlbmNpZXMoKTogU3BlY2lhbERlcGVuZGVuY2llcyB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHJ1bnRpbWU6IHRydWUsXG4gICAgICBpbml0OiBmYWxzZSxcbiAgICAgIGludGVybmFsOiBmYWxzZSxcbiAgICAgIHRpbWU6XG4gICAgICAgIHRoaXMucGFyYW1ldGVycy5zb21lKChwKSA9PiBwLnJlZmVyZW5jZS5zcGVjaWFsRGVwZW5kZW5jaWVzLnRpbWUpIHx8XG4gICAgICAgICEhdGhpcy5yZWZlcmVuY2U/LnNwZWNpYWxEZXBlbmRlbmNpZXMudGltZSxcbiAgICB9O1xuICB9XG5cbiAgcHJpdmF0ZSBnZXQgcmV0dXJuVHlwZVN0cmluZygpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLnJlZmVyZW5jZT8udm9pZCA/ICcnIDogYCAke3RoaXMucmV0dXJuVHlwZX1gO1xuICB9XG59XG4iXX0=