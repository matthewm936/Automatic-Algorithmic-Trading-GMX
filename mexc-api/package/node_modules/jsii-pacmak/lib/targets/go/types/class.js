"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.StaticMethod = exports.ClassMethod = exports.GoClassConstructor = exports.GoClass = void 0;
const naming_util_1 = require("../../../naming-util");
const comparators = require("../comparators");
const runtime_1 = require("../runtime");
const util_1 = require("../util");
const go_type_1 = require("./go-type");
const go_type_reference_1 = require("./go-type-reference");
const type_member_1 = require("./type-member");
/*
 * GoClass wraps a Typescript class as a Go custom struct type
 */
class GoClass extends go_type_1.GoType {
    constructor(pkg, type) {
        super(pkg, type);
        this.type = type;
        const methods = new Array();
        const staticMethods = new Array();
        for (const method of type.allMethods) {
            if (method.static) {
                staticMethods.push(new StaticMethod(this, method));
            }
            else {
                methods.push(new ClassMethod(this, method));
            }
        }
        // Ensure consistent order, mostly cosmetic.
        this.methods = methods.sort(comparators.byName);
        this.staticMethods = staticMethods.sort(comparators.byName);
        const properties = new Array();
        const staticProperties = new Array();
        for (const prop of type.allProperties) {
            if (prop.static) {
                staticProperties.push(new type_member_1.GoProperty(this, prop));
            }
            else {
                properties.push(new type_member_1.GoProperty(this, prop));
            }
        }
        // Ensure consistent order, mostly cosmetic.
        this.properties = properties.sort(comparators.byName);
        this.staticProperties = staticProperties.sort(comparators.byName);
        if (type.initializer) {
            this.initializer = new GoClassConstructor(this, type.initializer);
        }
    }
    get extends() {
        // Cannot compute in constructor, as dependencies may not have finished
        // resolving just yet.
        if (this._extends === undefined) {
            this._extends = this.type.base
                ? this.pkg.root.findType(this.type.base.fqn)
                : null;
        }
        return this._extends == null ? undefined : this._extends;
    }
    get implements() {
        // Cannot compute in constructor, as dependencies may not have finished
        // resolving just yet.
        if (this._implements === undefined) {
            this._implements = this.type.interfaces
                .map((iface) => this.pkg.root.findType(iface.fqn))
                // Ensure consistent order, mostly cosmetic.
                .sort((l, r) => l.fqn.localeCompare(r.fqn));
        }
        return this._implements;
    }
    get baseTypes() {
        return [...(this.extends ? [this.extends] : []), ...this.implements];
    }
    emit(context) {
        this.emitInterface(context);
        this.emitStruct(context);
        this.emitGetters(context);
        if (this.initializer) {
            this.initializer.emit(context);
        }
        this.emitSetters(context);
        for (const method of this.staticMethods) {
            method.emit(context);
        }
        for (const prop of this.staticProperties) {
            this.emitStaticProperty(context, prop);
        }
        for (const method of this.methods) {
            method.emit(context);
        }
    }
    emitRegistration(code) {
        code.open(`${runtime_1.JSII_RT_ALIAS}.RegisterClass(`);
        code.line(`"${this.fqn}",`);
        code.line(`reflect.TypeOf((*${this.name})(nil)).Elem(),`);
        const allMembers = [
            ...this.type.allMethods
                .filter((method) => !method.static)
                .map((method) => new ClassMethod(this, method)),
            ...this.type.allProperties
                .filter((property) => !property.static)
                .map((property) => new type_member_1.GoProperty(this, property)),
        ].sort(comparators.byName);
        if (allMembers.length === 0) {
            code.line('nil, // no members');
        }
        else {
            code.open(`[]${runtime_1.JSII_RT_ALIAS}.Member{`);
            for (const member of allMembers) {
                code.line(`${member.override},`);
            }
            code.close('},');
        }
        this.emitProxyMakerFunction(code, this.baseTypes);
        code.close(')');
    }
    get members() {
        return [
            ...(this.initializer ? [this.initializer] : []),
            ...this.methods,
            ...this.properties,
            ...this.staticMethods,
            ...this.staticProperties,
        ];
    }
    get specialDependencies() {
        var _a;
        return {
            runtime: this.initializer != null || this.members.length > 0,
            init: this.initializer != null ||
                this.members.some((m) => m.specialDependencies.init),
            internal: this.baseTypes.some((base) => this.pkg.isExternalType(base)),
            time: !!((_a = this.initializer) === null || _a === void 0 ? void 0 : _a.specialDependencies.time) ||
                this.members.some((m) => m.specialDependencies.time),
        };
    }
    emitInterface(context) {
        const { code, documenter } = context;
        documenter.emit(this.type.docs);
        code.openBlock(`type ${this.name} interface`);
        // embed extended interfaces
        if (this.extends) {
            code.line(new go_type_reference_1.GoTypeRef(this.pkg.root, this.extends.type.reference).scopedName(this.pkg));
        }
        for (const iface of this.implements) {
            code.line(new go_type_reference_1.GoTypeRef(this.pkg.root, iface.type.reference).scopedName(this.pkg));
        }
        for (const property of this.properties) {
            property.emitGetterDecl(context);
            property.emitSetterDecl(context);
        }
        for (const method of this.methods) {
            method.emitDecl(context);
        }
        code.closeBlock();
        code.line();
    }
    emitGetters(context) {
        if (this.properties.length === 0) {
            return;
        }
        for (const property of this.properties) {
            property.emitGetterProxy(context);
        }
        context.code.line();
    }
    emitStruct({ code }) {
        code.line(`// The jsii proxy struct for ${this.name}`);
        code.openBlock(`type ${this.proxyName} struct`);
        // Make sure this is not 0-width
        if (this.baseTypes.length === 0) {
            code.line('_ byte // padding');
        }
        else {
            for (const base of this.baseTypes) {
                code.line(this.pkg.resolveEmbeddedType(base).embed);
            }
        }
        code.closeBlock();
        code.line();
    }
    emitStaticProperty({ code }, prop) {
        const getCaller = new runtime_1.StaticGetProperty(prop);
        const propertyName = naming_util_1.jsiiToPascalCase(prop.name);
        const name = `${this.name}_${propertyName}`;
        code.openBlock(`func ${name}() ${prop.returnType}`);
        getCaller.emit(code);
        code.closeBlock();
        code.line();
        if (!prop.immutable) {
            const setCaller = new runtime_1.StaticSetProperty(prop);
            const name = `${this.name}_Set${propertyName}`;
            code.openBlock(`func ${name}(val ${prop.returnType})`);
            setCaller.emit(code);
            code.closeBlock();
            code.line();
        }
    }
    // emits the implementation of the setters for the struct
    emitSetters(context) {
        for (const property of this.properties) {
            property.emitSetterProxy(context);
        }
    }
    get dependencies() {
        // need to add dependencies of method arguments and constructor arguments
        return [
            ...this.baseTypes.map((ref) => ref.pkg),
            ...util_1.getMemberDependencies(this.members),
            ...util_1.getParamDependencies(this.members.filter(isGoMethod)),
        ];
    }
    /*
     * Get fqns of interfaces the class implements
     */
    get interfaces() {
        return this.type.interfaces.map((iFace) => iFace.fqn);
    }
}
exports.GoClass = GoClass;
class GoClassConstructor extends type_member_1.GoMethod {
    constructor(parent, type) {
        super(parent, type);
        this.parent = parent;
        this.type = type;
        this.constructorRuntimeCall = new runtime_1.ClassConstructor(this);
    }
    get specialDependencies() {
        return {
            runtime: true,
            init: true,
            internal: false,
            time: this.parameters.some((p) => p.reference.specialDependencies.time),
        };
    }
    emit(context) {
        var _a, _b;
        // Abstract classes cannot be directly created
        if (!this.parent.type.abstract) {
            this.emitNew(context);
        }
        // Subclassable classes (the default) get an _Overrides constructor
        if ((_b = (_a = this.parent.type.spec.docs) === null || _a === void 0 ? void 0 : _a.subclassable) !== null && _b !== void 0 ? _b : true) {
            this.emitOverride(context);
        }
    }
    emitNew({ code, documenter }) {
        const constr = `New${this.parent.name}`;
        const paramString = this.parameters.length === 0
            ? ''
            : this.parameters.map((p) => p.toString()).join(', ');
        documenter.emit(this.type.docs);
        code.openBlock(`func ${constr}(${paramString}) ${this.parent.name}`);
        this.constructorRuntimeCall.emit(code);
        code.closeBlock();
        code.line();
    }
    emitOverride({ code, documenter }) {
        const constr = `New${this.parent.name}_Override`;
        const params = this.parameters.map((p) => p.toString());
        const instanceVar = runtime_1.slugify(this.parent.name[0].toLowerCase(), params);
        params.unshift(`${instanceVar} ${this.parent.name}`);
        documenter.emit(this.type.docs);
        code.openBlock(`func ${constr}(${params.join(', ')})`);
        this.constructorRuntimeCall.emitOverride(code, instanceVar);
        code.closeBlock();
        code.line();
    }
}
exports.GoClassConstructor = GoClassConstructor;
class ClassMethod extends type_member_1.GoMethod {
    constructor(parent, method) {
        super(parent, method);
        this.parent = parent;
        this.method = method;
        this.runtimeCall = new runtime_1.MethodCall(this);
    }
    /* emit generates method implementation on the class */
    emit({ code, documenter }) {
        var _a;
        const name = this.name;
        const returnTypeString = ((_a = this.reference) === null || _a === void 0 ? void 0 : _a.void) ? '' : ` ${this.returnType}`;
        documenter.emit(this.method.docs);
        code.openBlock(`func (${this.instanceArg} *${this.parent.proxyName}) ${name}(${this.paramString()})${returnTypeString}`);
        this.runtimeCall.emit(code);
        code.closeBlock();
        code.line();
    }
    /* emitDecl generates method declaration in the class interface */
    emitDecl(context) {
        var _a;
        const { code } = context;
        const returnTypeString = ((_a = this.reference) === null || _a === void 0 ? void 0 : _a.void) ? '' : ` ${this.returnType}`;
        code.line(`${this.name}(${this.paramString()})${returnTypeString}`);
    }
    get instanceArg() {
        return this.parent.name.substring(0, 1).toLowerCase();
    }
    get specialDependencies() {
        var _a;
        return {
            runtime: true,
            init: this.method.static,
            internal: false,
            time: !!this.parameters.some((p) => p.reference.specialDependencies.time) ||
                !!((_a = this.reference) === null || _a === void 0 ? void 0 : _a.specialDependencies.time),
        };
    }
}
exports.ClassMethod = ClassMethod;
class StaticMethod extends ClassMethod {
    constructor(parent, method) {
        super(parent, method);
        this.parent = parent;
        this.method = method;
    }
    emit({ code, documenter }) {
        var _a;
        const name = `${this.parent.name}_${this.name}`;
        const returnTypeString = ((_a = this.reference) === null || _a === void 0 ? void 0 : _a.void) ? '' : ` ${this.returnType}`;
        documenter.emit(this.method.docs);
        code.openBlock(`func ${name}(${this.paramString()})${returnTypeString}`);
        this.runtimeCall.emit(code);
        code.closeBlock();
        code.line();
    }
}
exports.StaticMethod = StaticMethod;
function isGoMethod(m) {
    return m instanceof type_member_1.GoMethod;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2xhc3MuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJjbGFzcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFHQSxzREFBd0Q7QUFDeEQsOENBQThDO0FBSTlDLHdDQU9vQjtBQUNwQixrQ0FBc0U7QUFDdEUsdUNBQW1DO0FBQ25DLDJEQUFnRDtBQUVoRCwrQ0FBbUU7QUFFbkU7O0dBRUc7QUFDSCxNQUFhLE9BQVEsU0FBUSxnQkFBTTtJQVdqQyxZQUFtQixHQUFZLEVBQVMsSUFBZTtRQUNyRCxLQUFLLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxDQUFDO1FBRHFCLFNBQUksR0FBSixJQUFJLENBQVc7UUFHckQsTUFBTSxPQUFPLEdBQUcsSUFBSSxLQUFLLEVBQWUsQ0FBQztRQUN6QyxNQUFNLGFBQWEsR0FBRyxJQUFJLEtBQUssRUFBZ0IsQ0FBQztRQUNoRCxLQUFLLE1BQU0sTUFBTSxJQUFJLElBQUksQ0FBQyxVQUFVLEVBQUU7WUFDcEMsSUFBSSxNQUFNLENBQUMsTUFBTSxFQUFFO2dCQUNqQixhQUFhLENBQUMsSUFBSSxDQUFDLElBQUksWUFBWSxDQUFDLElBQUksRUFBRSxNQUFNLENBQUMsQ0FBQyxDQUFDO2FBQ3BEO2lCQUFNO2dCQUNMLE9BQU8sQ0FBQyxJQUFJLENBQUMsSUFBSSxXQUFXLENBQUMsSUFBSSxFQUFFLE1BQU0sQ0FBQyxDQUFDLENBQUM7YUFDN0M7U0FDRjtRQUNELDRDQUE0QztRQUM1QyxJQUFJLENBQUMsT0FBTyxHQUFHLE9BQU8sQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQ2hELElBQUksQ0FBQyxhQUFhLEdBQUcsYUFBYSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLENBQUM7UUFFNUQsTUFBTSxVQUFVLEdBQUcsSUFBSSxLQUFLLEVBQWMsQ0FBQztRQUMzQyxNQUFNLGdCQUFnQixHQUFHLElBQUksS0FBSyxFQUFjLENBQUM7UUFDakQsS0FBSyxNQUFNLElB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QUFDLENBQUM7UUFFekUsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7UUFFNUIsSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFDO1FBQ2xCLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUNkLENBQUM7Q0FDRjtBQXBCRCxvQ0FvQkM7QUFFRCxTQUFTLFVBQVUsQ0FBQyxDQUFlO0lBQ2pDLE9BQU8sQ0FBQyxZQUFZLHNCQUFRLENBQUM7QUFDL0IsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvZGVNYWtlciB9IGZyb20gJ2NvZGVtYWtlcic7XG5pbXBvcnQgeyBNZXRob2QsIENsYXNzVHlwZSwgSW5pdGlhbGl6ZXIgfSBmcm9tICdqc2lpLXJlZmxlY3QnO1xuXG5pbXBvcnQgeyBqc2lpVG9QYXNjYWxDYXNlIH0gZnJvbSAnLi4vLi4vLi4vbmFtaW5nLXV0aWwnO1xuaW1wb3J0ICogYXMgY29tcGFyYXRvcnMgZnJvbSAnLi4vY29tcGFyYXRvcnMnO1xuaW1wb3J0IHsgU3BlY2lhbERlcGVuZGVuY2llcyB9IGZyb20gJy4uL2RlcGVuZGVuY2llcyc7XG5pbXBvcnQgeyBFbWl0Q29udGV4dCB9IGZyb20gJy4uL2VtaXQtY29udGV4dCc7XG5pbXBvcnQgeyBQYWNrYWdlIH0gZnJvbSAnLi4vcGFja2FnZSc7XG5pbXBvcnQge1xuICBDbGFzc0NvbnN0cnVjdG9yLFxuICBKU0lJX1JUX0FMSUFTLFxuICBNZXRob2RDYWxsLFxuICBzbHVnaWZ5LFxuICBTdGF0aWNHZXRQcm9wZXJ0eSxcbiAgU3RhdGljU2V0UHJvcGVydHksXG59IGZyb20gJy4uL3J1bnRpbWUnO1xuaW1wb3J0IHsgZ2V0TWVtYmVyRGVwZW5kZW5jaWVzLCBnZXRQYXJhbURlcGVuZGVuY2llcyB9IGZyb20gJy4uL3V0aWwnO1xuaW1wb3J0IHsgR29UeXBlIH0gZnJvbSAnLi9nby10eXBlJztcbmltcG9ydCB7IEdvVHlwZVJlZiB9IGZyb20gJy4vZ28tdHlwZS1yZWZlcmVuY2UnO1xuaW1wb3J0IHsgR29JbnRlcmZhY2UgfSBmcm9tICcuL2ludGVyZmFjZSc7XG5pbXBvcnQgeyBHb01ldGhvZCwgR29Qcm9wZXJ0eSwgR29UeXBlTWVtYmVyIH0gZnJvbSAnLi90eXBlLW1lbWJlcic7XG5cbi8qXG4gKiBHb0NsYXNzIHdyYXBzIGEgVHlwZXNjcmlwdCBjbGFzcyBhcyBhIEdvIGN1c3RvbSBzdHJ1Y3QgdHlwZVxuICovXG5leHBvcnQgY2xhc3MgR29DbGFzcyBleHRlbmRzIEdvVHlwZSB7XG4gIHB1YmxpYyByZWFkb25seSBtZXRob2RzOiBDbGFzc01ldGhvZFtdO1xuICBwdWJsaWMgcmVhZG9ubHkgc3RhdGljTWV0aG9kczogU3RhdGljTWV0aG9kW107XG4gIHB1YmxpYyByZWFkb25seSBwcm9wZXJ0aWVzOiBHb1Byb3BlcnR5W107XG4gIHB1YmxpYyByZWFkb25seSBzdGF0aWNQcm9wZXJ0aWVzOiBHb1Byb3BlcnR5W107XG5cbiAgcHJpdmF0ZSBfZXh0ZW5kcz86IEdvQ2xhc3MgfCBudWxsO1xuICBwcml2YXRlIF9pbXBsZW1lbnRzPzogcmVhZG9ubHkgR29JbnRlcmZhY2VbXTtcblxuICBwcml2YXRlIHJlYWRvbmx5IGluaXRpYWxpemVyPzogR29DbGFzc0NvbnN0cnVjdG9yO1xuXG4gIHB1YmxpYyBjb25zdHJ1Y3Rvcihwa2c6IFBhY2thZ2UsIHB1YmxpYyB0eXBlOiBDbGFzc1R5cGUpIHtcbiAgICBzdXBlcihwa2csIHR5cGUpO1xuXG4gICAgY29uc3QgbWV0aG9kcyA9IG5ldyBBcnJheTxDbGFzc01ldGhvZD4oKTtcbiAgICBjb25zdCBzdGF0aWNNZXRob2RzID0gbmV3IEFycmF5PFN0YXRpY01ldGhvZD4oKTtcbiAgICBmb3IgKGNvbnN0IG1ldGhvZCBvZiB0eXBlLmFsbE1ldGhvZHMpIHtcbiAgICAgIGlmIChtZXRob2Quc3RhdGljKSB7XG4gICAgICAgIHN0YXRpY01ldGhvZHMucHVzaChuZXcgU3RhdGljTWV0aG9kKHRoaXMsIG1ldGhvZCkpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbWV0aG9kcy5wdXNoKG5ldyBDbGFzc01ldGhvZCh0aGlzLCBtZXRob2QpKTtcbiAgICAgIH1cbiAgICB9XG4gICAgLy8gRW5zdXJlIGNvbnNpc3RlbnQgb3JkZXIsIG1vc3RseSBjb3NtZXRpYy5cbiAgICB0aGlzLm1ldGhvZHMgPSBtZXRob2RzLnNvcnQoY29tcGFyYXRvcnMuYnlOYW1lKTtcbiAgICB0aGlzLnN0YXRpY01ldGhvZHMgPSBzdGF0aWNNZXRob2RzLnNvcnQoY29tcGFyYXRvcnMuYnlOYW1lKTtcblxuICAgIGNvbnN0IHByb3BlcnRpZXMgPSBuZXcgQXJyYXk8R29Qcm9wZXJ0eT4oKTtcbiAgICBjb25zdCBzdGF0aWNQcm9wZXJ0aWVzID0gbmV3IEFycmF5PEdvUHJvcGVydHk+KCk7XG4gICAgZm9yIChjb25zdCBwcm9wIG9mIHR5cGUuYWxsUHJvcGVydGllcykge1xuICAgICAgaWYgKHByb3Auc3RhdGljKSB7XG4gICAgICAgIHN0YXRpY1Byb3BlcnRpZXMucHVzaChuZXcgR29Qcm9wZXJ0eSh0aGlzLCBwcm9wKSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBwcm9wZXJ0aWVzLnB1c2gobmV3IEdvUHJvcGVydHkodGhpcywgcHJvcCkpO1xuICAgICAgfVxuICAgIH1cbiAgICAvLyBFbnN1cmUgY29uc2lzdGVudCBvcmRlciwgbW9zdGx5IGNvc21ldGljLlxuICAgIHRoaXMucHJvcGVydGllcyA9IHByb3BlcnRpZXMuc29ydChjb21wYXJhdG9ycy5ieU5hbWUpO1xuICAgIHRoaXMuc3RhdGljUHJvcGVydGllcyA9IHN0YXRpY1Byb3BlcnRpZXMuc29ydChjb21wYXJhdG9ycy5ieU5hbWUpO1xuXG4gICAgaWYgKHR5cGUuaW5pdGlhbGl6ZXIpIHtcbiAgICAgIHRoaXMuaW5pdGlhbGl6ZXIgPSBuZXcgR29DbGFzc0NvbnN0cnVjdG9yKHRoaXMsIHR5cGUuaW5pdGlhbGl6ZXIpO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBnZXQgZXh0ZW5kcygpOiBHb0NsYXNzIHwgdW5kZWZpbmVkIHtcbiAgICAvLyBDYW5ub3QgY29tcHV0ZSBpbiBjb25zdHJ1Y3RvciwgYXMgZGVwZW5kZW5jaWVzIG1heSBub3QgaGF2ZSBmaW5pc2hlZFxuICAgIC8vIHJlc29sdmluZyBqdXN0IHlldC5cbiAgICBpZiAodGhpcy5fZXh0ZW5kcyA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICB0aGlzLl9leHRlbmRzID0gdGhpcy50eXBlLmJhc2VcbiAgICAgICAgPyAodGhpcy5wa2cucm9vdC5maW5kVHlwZSh0aGlzLnR5cGUuYmFzZS5mcW4pIGFzIEdvQ2xhc3MpXG4gICAgICAgIDogbnVsbDtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuX2V4dGVuZHMgPT0gbnVsbCA/IHVuZGVmaW5lZCA6IHRoaXMuX2V4dGVuZHM7XG4gIH1cblxuICBwdWJsaWMgZ2V0IGltcGxlbWVudHMoKTogcmVhZG9ubHkgR29JbnRlcmZhY2VbXSB7XG4gICAgLy8gQ2Fubm90IGNvbXB1dGUgaW4gY29uc3RydWN0b3IsIGFzIGRlcGVuZGVuY2llcyBtYXkgbm90IGhhdmUgZmluaXNoZWRcbiAgICAvLyByZXNvbHZpbmcganVzdCB5ZXQuXG4gICAgaWYgKHRoaXMuX2ltcGxlbWVudHMgPT09IHVuZGVmaW5lZCkge1xuICAgICAgdGhpcy5faW1wbGVtZW50cyA9IHRoaXMudHlwZS5pbnRlcmZhY2VzXG4gICAgICAgIC5tYXAoKGlmYWNlKSA9PiB0aGlzLnBrZy5yb290LmZpbmRUeXBlKGlmYWNlLmZxbikgYXMgR29JbnRlcmZhY2UpXG4gICAgICAgIC8vIEVuc3VyZSBjb25zaXN0ZW50IG9yZGVyLCBtb3N0bHkgY29zbWV0aWMuXG4gICAgICAgIC5zb3J0KChsLCByKSA9PiBsLmZxbi5sb2NhbGVDb21wYXJlKHIuZnFuKSk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLl9pbXBsZW1lbnRzO1xuICB9XG5cbiAgcHVibGljIGdldCBiYXNlVHlwZXMoKTogUmVhZG9ubHlBcnJheTxHb0NsYXNzIHwgR29JbnRlcmZhY2U+IHtcbiAgICByZXR1cm4gWy4uLih0aGlzLmV4dGVuZHMgPyBbdGhpcy5leHRlbmRzXSA6IFtdKSwgLi4udGhpcy5pbXBsZW1lbnRzXTtcbiAgfVxuXG4gIHB1YmxpYyBlbWl0KGNvbnRleHQ6IEVtaXRDb250ZXh0KTogdm9pZCB7XG4gICAgdGhpcy5lbWl0SW50ZXJmYWNlKGNvbnRleHQpO1xuICAgIHRoaXMuZW1pdFN0cnVjdChjb250ZXh0KTtcbiAgICB0aGlzLmVtaXRHZXR0ZXJzKGNvbnRleHQpO1xuXG4gICAgaWYgKHRoaXMuaW5pdGlhbGl6ZXIpIHtcbiAgICAgIHRoaXMuaW5pdGlhbGl6ZXIuZW1pdChjb250ZXh0KTtcbiAgICB9XG5cbiAgICB0aGlzLmVtaXRTZXR0ZXJzKGNvbnRleHQpO1xuXG4gICAgZm9yIChjb25zdCBtZXRob2Qgb2YgdGhpcy5zdGF0aWNNZXRob2RzKSB7XG4gICAgICBtZXRob2QuZW1pdChjb250ZXh0KTtcbiAgICB9XG5cbiAgICBmb3IgKGNvbnN0IHByb3Agb2YgdGhpcy5zdGF0aWNQcm9wZXJ0aWVzKSB7XG4gICAgICB0aGlzLmVtaXRTdGF0aWNQcm9wZXJ0eShjb250ZXh0LCBwcm9wKTtcbiAgICB9XG5cbiAgICBmb3IgKGNvbnN0IG1ldGhvZCBvZiB0aGlzLm1ldGhvZHMpIHtcbiAgICAgIG1ldGhvZC5lbWl0KGNvbnRleHQpO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBlbWl0UmVnaXN0cmF0aW9uKGNvZGU6IENvZGVNYWtlcik6IHZvaWQge1xuICAgIGNvZGUub3BlbihgJHtKU0lJX1JUX0FMSUFTfS5SZWdpc3RlckNsYXNzKGApO1xuICAgIGNvZGUubGluZShgXCIke3RoaXMuZnFufVwiLGApO1xuICAgIGNvZGUubGluZShgcmVmbGVjdC5UeXBlT2YoKCoke3RoaXMubmFtZX0pKG5pbCkpLkVsZW0oKSxgKTtcblxuICAgIGNvbnN0IGFsbE1lbWJlcnMgPSBbXG4gICAgICAuLi50aGlzLnR5cGUuYWxsTWV0aG9kc1xuICAgICAgICAuZmlsdGVyKChtZXRob2QpID0+ICFtZXRob2Quc3RhdGljKVxuICAgICAgICAubWFwKChtZXRob2QpID0+IG5ldyBDbGFzc01ldGhvZCh0aGlzLCBtZXRob2QpKSxcbiAgICAgIC4uLnRoaXMudHlwZS5hbGxQcm9wZXJ0aWVzXG4gICAgICAgIC5maWx0ZXIoKHByb3BlcnR5KSA9PiAhcHJvcGVydHkuc3RhdGljKVxuICAgICAgICAubWFwKChwcm9wZXJ0eSkgPT4gbmV3IEdvUHJvcGVydHkodGhpcywgcHJvcGVydHkpKSxcbiAgICBdLnNvcnQoY29tcGFyYXRvcnMuYnlOYW1lKTtcbiAgICBpZiAoYWxsTWVtYmVycy5sZW5ndGggPT09IDApIHtcbiAgICAgIGNvZGUubGluZSgnbmlsLCAvLyBubyBtZW1iZXJzJyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvZGUub3BlbihgW10ke0pTSUlfUlRfQUxJQVN9Lk1lbWJlcntgKTtcbiAgICAgIGZvciAoY29uc3QgbWVtYmVyIG9mIGFsbE1lbWJlcnMpIHtcbiAgICAgICAgY29kZS5saW5lKGAke21lbWJlci5vdmVycmlkZX0sYCk7XG4gICAgICB9XG4gICAgICBjb2RlLmNsb3NlKCd9LCcpO1xuICAgIH1cblxuICAgIHRoaXMuZW1pdFByb3h5TWFrZXJGdW5jdGlvbihjb2RlLCB0aGlzLmJhc2VUeXBlcyk7XG4gICAgY29kZS5jbG9zZSgnKScpO1xuICB9XG5cbiAgcHVibGljIGdldCBtZW1iZXJzKCk6IEdvVHlwZU1lbWJlcltdIHtcbiAgICByZXR1cm4gW1xuICAgICAgLi4uKHRoaXMuaW5pdGlhbGl6ZXIgPyBbdGhpcy5pbml0aWFsaXplcl0gOiBbXSksXG4gICAgICAuLi50aGlzLm1ldGhvZHMsXG4gICAgICAuLi50aGlzLnByb3BlcnRpZXMsXG4gICAgICAuLi50aGlzLnN0YXRpY01ldGhvZHMsXG4gICAgICAuLi50aGlzLnN0YXRpY1Byb3BlcnRpZXMsXG4gICAgXTtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgc3BlY2lhbERlcGVuZGVuY2llcygpOiBTcGVjaWFsRGVwZW5kZW5jaWVzIHtcbiAgICByZXR1cm4ge1xuICAgICAgcnVudGltZTogdGhpcy5pbml0aWFsaXplciAhPSBudWxsIHx8IHRoaXMubWVtYmVycy5sZW5ndGggPiAwLFxuICAgICAgaW5pdDpcbiAgICAgICAgdGhpcy5pbml0aWFsaXplciAhPSBudWxsIHx8XG4gICAgICAgIHRoaXMubWVtYmVycy5zb21lKChtKSA9PiBtLnNwZWNpYWxEZXBlbmRlbmNpZXMuaW5pdCksXG4gICAgICBpbnRlcm5hbDogdGhpcy5iYXNlVHlwZXMuc29tZSgoYmFzZSkgPT4gdGhpcy5wa2cuaXNFeHRlcm5hbFR5cGUoYmFzZSkpLFxuICAgICAgdGltZTpcbiAgICAgICAgISF0aGlzLmluaXRpYWxpemVyPy5zcGVjaWFsRGVwZW5kZW5jaWVzLnRpbWUgfHxcbiAgICAgICAgdGhpcy5tZW1iZXJzLnNvbWUoKG0pID0+IG0uc3BlY2lhbERlcGVuZGVuY2llcy50aW1lKSxcbiAgICB9O1xuICB9XG5cbiAgcHJvdGVjdGVkIGVtaXRJbnRlcmZhY2UoY29udGV4dDogRW1pdENvbnRleHQpOiB2b2lkIHtcbiAgICBjb25zdCB7IGNvZGUsIGRvY3VtZW50ZXIgfSA9IGNvbnRleHQ7XG4gICAgZG9jdW1lbnRlci5lbWl0KHRoaXMudHlwZS5kb2NzKTtcbiAgICBjb2RlLm9wZW5CbG9jayhgdHlwZSAke3RoaXMubmFtZX0gaW50ZXJmYWNlYCk7XG5cbiAgICAvLyBlbWJlZCBleHRlbmRlZCBpbnRlcmZhY2VzXG4gICAgaWYgKHRoaXMuZXh0ZW5kcykge1xuICAgICAgY29kZS5saW5lKFxuICAgICAgICBuZXcgR29UeXBlUmVmKHRoaXMucGtnLnJvb3QsIHRoaXMuZXh0ZW5kcy50eXBlLnJlZmVyZW5jZSkuc2NvcGVkTmFtZShcbiAgICAgICAgICB0aGlzLnBrZyxcbiAgICAgICAgKSxcbiAgICAgICk7XG4gICAgfVxuICAgIGZvciAoY29uc3QgaWZhY2Ugb2YgdGhpcy5pbXBsZW1lbnRzKSB7XG4gICAgICBjb2RlLmxpbmUoXG4gICAgICAgIG5ldyBHb1R5cGVSZWYodGhpcy5wa2cucm9vdCwgaWZhY2UudHlwZS5yZWZlcmVuY2UpLnNjb3BlZE5hbWUodGhpcy5wa2cpLFxuICAgICAgKTtcbiAgICB9XG5cbiAgICBmb3IgKGNvbnN0IHByb3BlcnR5IG9mIHRoaXMucHJvcGVydGllcykge1xuICAgICAgcHJvcGVydHkuZW1pdEdldHRlckRlY2woY29udGV4dCk7XG4gICAgICBwcm9wZXJ0eS5lbWl0U2V0dGVyRGVjbChjb250ZXh0KTtcbiAgICB9XG5cbiAgICBmb3IgKGNvbnN0IG1ldGhvZCBvZiB0aGlzLm1ldGhvZHMpIHtcbiAgICAgIG1ldGhvZC5lbWl0RGVjbChjb250ZXh0KTtcbiAgICB9XG5cbiAgICBjb2RlLmNsb3NlQmxvY2soKTtcbiAgICBjb2RlLmxpbmUoKTtcbiAgfVxuXG4gIHByaXZhdGUgZW1pdEdldHRlcnMoY29udGV4dDogRW1pdENvbnRleHQpIHtcbiAgICBpZiAodGhpcy5wcm9wZXJ0aWVzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBmb3IgKGNvbnN0IHByb3BlcnR5IG9mIHRoaXMucHJvcGVydGllcykge1xuICAgICAgcHJvcGVydHkuZW1pdEdldHRlclByb3h5KGNvbnRleHQpO1xuICAgIH1cbiAgICBjb250ZXh0LmNvZGUubGluZSgpO1xuICB9XG5cbiAgcHJpdmF0ZSBlbWl0U3RydWN0KHsgY29kZSB9OiBFbWl0Q29udGV4dCk6IHZvaWQge1xuICAgIGNvZGUubGluZShgLy8gVGhlIGpzaWkgcHJveHkgc3RydWN0IGZvciAke3RoaXMubmFtZX1gKTtcbiAgICBjb2RlLm9wZW5CbG9jayhgdHlwZSAke3RoaXMucHJveHlOYW1lfSBzdHJ1Y3RgKTtcblxuICAgIC8vIE1ha2Ugc3VyZSB0aGlzIGlzIG5vdCAwLXdpZHRoXG4gICAgaWYgKHRoaXMuYmFzZVR5cGVzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgY29kZS5saW5lKCdfIGJ5dGUgLy8gcGFkZGluZycpO1xuICAgIH0gZWxzZSB7XG4gICAgICBmb3IgKGNvbnN0IGJhc2Ugb2YgdGhpcy5iYXNlVHlwZXMpIHtcbiAgICAgICAgY29kZS5saW5lKHRoaXMucGtnLnJlc29sdmVFbWJlZGRlZFR5cGUoYmFzZSkuZW1iZWQpO1xuICAgICAgfVxuICAgIH1cblxuICAgIGNvZGUuY2xvc2VCbG9jaygpO1xuICAgIGNvZGUubGluZSgpO1xuICB9XG5cbiAgcHJpdmF0ZSBlbWl0U3RhdGljUHJvcGVydHkoeyBjb2RlIH06IEVtaXRDb250ZXh0LCBwcm9wOiBHb1Byb3BlcnR5KTogdm9pZCB7XG4gICAgY29uc3QgZ2V0Q2FsbGVyID0gbmV3IFN0YXRpY0dldFByb3BlcnR5KHByb3ApO1xuXG4gICAgY29uc3QgcHJvcGVydHlOYW1lID0ganNpaVRvUGFzY2FsQ2FzZShwcm9wLm5hbWUpO1xuICAgIGNvbnN0IG5hbWUgPSBgJHt0aGlzLm5hbWV9XyR7cHJvcGVydHlOYW1lfWA7XG5cbiAgICBjb2RlLm9wZW5CbG9jayhgZnVuYyAke25hbWV9KCkgJHtwcm9wLnJldHVyblR5cGV9YCk7XG4gICAgZ2V0Q2FsbGVyLmVtaXQoY29kZSk7XG5cbiAgICBjb2RlLmNsb3NlQmxvY2soKTtcbiAgICBjb2RlLmxpbmUoKTtcblxuICAgIGlmICghcHJvcC5pbW11dGFibGUpIHtcbiAgICAgIGNvbnN0IHNldENhbGxlciA9IG5ldyBTdGF0aWNTZXRQcm9wZXJ0eShwcm9wKTtcbiAgICAgIGNvbnN0IG5hbWUgPSBgJHt0aGlzLm5hbWV9X1NldCR7cHJvcGVydHlOYW1lfWA7XG4gICAgICBjb2RlLm9wZW5CbG9jayhgZnVuYyAke25hbWV9KHZhbCAke3Byb3AucmV0dXJuVHlwZX0pYCk7XG4gICAgICBzZXRDYWxsZXIuZW1pdChjb2RlKTtcblxuICAgICAgY29kZS5jbG9zZUJsb2NrKCk7XG4gICAgICBjb2RlLmxpbmUoKTtcbiAgICB9XG4gIH1cblxuICAvLyBlbWl0cyB0aGUgaW1wbGVtZW50YXRpb24gb2YgdGhlIHNldHRlcnMgZm9yIHRoZSBzdHJ1Y3RcbiAgcHJpdmF0ZSBlbWl0U2V0dGVycyhjb250ZXh0OiBFbWl0Q29udGV4dCk6IHZvaWQge1xuICAgIGZvciAoY29uc3QgcHJvcGVydHkgb2YgdGhpcy5wcm9wZXJ0aWVzKSB7XG4gICAgICBwcm9wZXJ0eS5lbWl0U2V0dGVyUHJveHkoY29udGV4dCk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGdldCBkZXBlbmRlbmNpZXMoKTogUGFja2FnZVtdIHtcbiAgICAvLyBuZWVkIHRvIGFkZCBkZXBlbmRlbmNpZXMgb2YgbWV0aG9kIGFyZ3VtZW50cyBhbmQgY29uc3RydWN0b3IgYXJndW1lbnRzXG4gICAgcmV0dXJuIFtcbiAgICAgIC4uLnRoaXMuYmFzZVR5cGVzLm1hcCgocmVmKSA9PiByZWYucGtnKSxcbiAgICAgIC4uLmdldE1lbWJlckRlcGVuZGVuY2llcyh0aGlzLm1lbWJlcnMpLFxuICAgICAgLi4uZ2V0UGFyYW1EZXBlbmRlbmNpZXModGhpcy5tZW1iZXJzLmZpbHRlcihpc0dvTWV0aG9kKSksXG4gICAgXTtcbiAgfVxuXG4gIC8qXG4gICAqIEdldCBmcW5zIG9mIGludGVyZmFjZXMgdGhlIGNsYXNzIGltcGxlbWVudHNcbiAgICovXG4gIHB1YmxpYyBnZXQgaW50ZXJmYWNlcygpOiBzdHJpbmdbXSB7XG4gICAgcmV0dXJuIHRoaXMudHlwZS5pbnRlcmZhY2VzLm1hcCgoaUZhY2UpID0+IGlGYWNlLmZxbik7XG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIEdvQ2xhc3NDb25zdHJ1Y3RvciBleHRlbmRzIEdvTWV0aG9kIHtcbiAgcHJpdmF0ZSByZWFkb25seSBjb25zdHJ1Y3RvclJ1bnRpbWVDYWxsOiBDbGFzc0NvbnN0cnVjdG9yO1xuXG4gIHB1YmxpYyBjb25zdHJ1Y3RvcihcbiAgICBwdWJsaWMgcmVhZG9ubHkgcGFyZW50OiBHb0NsYXNzLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgdHlwZTogSW5pdGlhbGl6ZXIsXG4gICkge1xuICAgIHN1cGVyKHBhcmVudCwgdHlwZSk7XG4gICAgdGhpcy5jb25zdHJ1Y3RvclJ1bnRpbWVDYWxsID0gbmV3IENsYXNzQ29uc3RydWN0b3IodGhpcyk7XG4gIH1cblxuICBwdWJsaWMgZ2V0IHNwZWNpYWxEZXBlbmRlbmNpZXMoKTogU3BlY2lhbERlcGVuZGVuY2llcyB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHJ1bnRpbWU6IHRydWUsXG4gICAgICBpbml0OiB0cnVlLFxuICAgICAgaW50ZXJuYWw6IGZhbHNlLFxuICAgICAgdGltZTogdGhpcy5wYXJhbWV0ZXJzLnNvbWUoKHApID0+IHAucmVmZXJlbmNlLnNwZWNpYWxEZXBlbmRlbmNpZXMudGltZSksXG4gICAgfTtcbiAgfVxuXG4gIHB1YmxpYyBlbWl0KGNvbnRleHQ6IEVtaXRDb250ZXh0KSB7XG4gICAgLy8gQWJzdHJhY3QgY2xhc3NlcyBjYW5ub3QgYmUgZGlyZWN0bHkgY3JlYXRlZFxuICAgIGlmICghdGhpcy5wYXJlbnQudHlwZS5hYnN0cmFjdCkge1xuICAgICAgdGhpcy5lbWl0TmV3KGNvbnRleHQpO1xuICAgIH1cbiAgICAvLyBTdWJjbGFzc2FibGUgY2xhc3NlcyAodGhlIGRlZmF1bHQpIGdldCBhbiBfT3ZlcnJpZGVzIGNvbnN0cnVjdG9yXG4gICAgaWYgKHRoaXMucGFyZW50LnR5cGUuc3BlYy5kb2NzPy5zdWJjbGFzc2FibGUgPz8gdHJ1ZSkge1xuICAgICAgdGhpcy5lbWl0T3ZlcnJpZGUoY29udGV4dCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBlbWl0TmV3KHsgY29kZSwgZG9jdW1lbnRlciB9OiBFbWl0Q29udGV4dCkge1xuICAgIGNvbnN0IGNvbnN0ciA9IGBOZXcke3RoaXMucGFyZW50Lm5hbWV9YDtcbiAgICBjb25zdCBwYXJhbVN0cmluZyA9XG4gICAgICB0aGlzLnBhcmFtZXRlcnMubGVuZ3RoID09PSAwXG4gICAgICAgID8gJydcbiAgICAgICAgOiB0aGlzLnBhcmFtZXRlcnMubWFwKChwKSA9PiBwLnRvU3RyaW5nKCkpLmpvaW4oJywgJyk7XG5cbiAgICBkb2N1bWVudGVyLmVtaXQodGhpcy50eXBlLmRvY3MpO1xuICAgIGNvZGUub3BlbkJsb2NrKGBmdW5jICR7Y29uc3RyfSgke3BhcmFtU3RyaW5nfSkgJHt0aGlzLnBhcmVudC5uYW1lfWApO1xuICAgIHRoaXMuY29uc3RydWN0b3JSdW50aW1lQ2FsbC5lbWl0KGNvZGUpO1xuICAgIGNvZGUuY2xvc2VCbG9jaygpO1xuXG4gICAgY29kZS5saW5lKCk7XG4gIH1cblxuICBwcml2YXRlIGVtaXRPdmVycmlkZSh7IGNvZGUsIGRvY3VtZW50ZXIgfTogRW1pdENvbnRleHQpIHtcbiAgICBjb25zdCBjb25zdHIgPSBgTmV3JHt0aGlzLnBhcmVudC5uYW1lfV9PdmVycmlkZWA7XG4gICAgY29uc3QgcGFyYW1zID0gdGhpcy5wYXJhbWV0ZXJzLm1hcCgocCkgPT4gcC50b1N0cmluZygpKTtcblxuICAgIGNvbnN0IGluc3RhbmNlVmFyID0gc2x1Z2lmeSh0aGlzLnBhcmVudC5uYW1lWzBdLnRvTG93ZXJDYXNlKCksIHBhcmFtcyk7XG4gICAgcGFyYW1zLnVuc2hpZnQoYCR7aW5zdGFuY2VWYXJ9ICR7dGhpcy5wYXJlbnQubmFtZX1gKTtcblxuICAgIGRvY3VtZW50ZXIuZW1pdCh0aGlzLnR5cGUuZG9jcyk7XG4gICAgY29kZS5vcGVuQmxvY2soYGZ1bmMgJHtjb25zdHJ9KCR7cGFyYW1zLmpvaW4oJywgJyl9KWApO1xuICAgIHRoaXMuY29uc3RydWN0b3JSdW50aW1lQ2FsbC5lbWl0T3ZlcnJpZGUoY29kZSwgaW5zdGFuY2VWYXIpO1xuICAgIGNvZGUuY2xvc2VCbG9jaygpO1xuICAgIGNvZGUubGluZSgpO1xuICB9XG59XG5cbmV4cG9ydCBjbGFzcyBDbGFzc01ldGhvZCBleHRlbmRzIEdvTWV0aG9kIHtcbiAgcHVibGljIHJlYWRvbmx5IHJ1bnRpbWVDYWxsOiBNZXRob2RDYWxsO1xuXG4gIHB1YmxpYyBjb25zdHJ1Y3RvcihcbiAgICBwdWJsaWMgcmVhZG9ubHkgcGFyZW50OiBHb0NsYXNzLFxuICAgIHB1YmxpYyByZWFkb25seSBtZXRob2Q6IE1ldGhvZCxcbiAgKSB7XG4gICAgc3VwZXIocGFyZW50LCBtZXRob2QpO1xuICAgIHRoaXMucnVudGltZUNhbGwgPSBuZXcgTWV0aG9kQ2FsbCh0aGlzKTtcbiAgfVxuXG4gIC8qIGVtaXQgZ2VuZXJhdGVzIG1ldGhvZCBpbXBsZW1lbnRhdGlvbiBvbiB0aGUgY2xhc3MgKi9cbiAgcHVibGljIGVtaXQoeyBjb2RlLCBkb2N1bWVudGVyIH06IEVtaXRDb250ZXh0KSB7XG4gICAgY29uc3QgbmFtZSA9IHRoaXMubmFtZTtcbiAgICBjb25zdCByZXR1cm5UeXBlU3RyaW5nID0gdGhpcy5yZWZlcmVuY2U/LnZvaWQgPyAnJyA6IGAgJHt0aGlzLnJldHVyblR5cGV9YDtcblxuICAgIGRvY3VtZW50ZXIuZW1pdCh0aGlzLm1ldGhvZC5kb2NzKTtcbiAgICBjb2RlLm9wZW5CbG9jayhcbiAgICAgIGBmdW5jICgke3RoaXMuaW5zdGFuY2VBcmd9ICoke1xuICAgICAgICB0aGlzLnBhcmVudC5wcm94eU5hbWVcbiAgICAgIH0pICR7bmFtZX0oJHt0aGlzLnBhcmFtU3RyaW5nKCl9KSR7cmV0dXJuVHlwZVN0cmluZ31gLFxuICAgICk7XG5cbiAgICB0aGlzLnJ1bnRpbWVDYWxsLmVtaXQoY29kZSk7XG5cbiAgICBjb2RlLmNsb3NlQmxvY2soKTtcbiAgICBjb2RlLmxpbmUoKTtcbiAgfVxuXG4gIC8qIGVtaXREZWNsIGdlbmVyYXRlcyBtZXRob2QgZGVjbGFyYXRpb24gaW4gdGhlIGNsYXNzIGludGVyZmFjZSAqL1xuICBwdWJsaWMgZW1pdERlY2woY29udGV4dDogRW1pdENvbnRleHQpIHtcbiAgICBjb25zdCB7IGNvZGUgfSA9IGNvbnRleHQ7XG4gICAgY29uc3QgcmV0dXJuVHlwZVN0cmluZyA9IHRoaXMucmVmZXJlbmNlPy52b2lkID8gJycgOiBgICR7dGhpcy5yZXR1cm5UeXBlfWA7XG4gICAgY29kZS5saW5lKGAke3RoaXMubmFtZX0oJHt0aGlzLnBhcmFtU3RyaW5nKCl9KSR7cmV0dXJuVHlwZVN0cmluZ31gKTtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgaW5zdGFuY2VBcmcoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5wYXJlbnQubmFtZS5zdWJzdHJpbmcoMCwgMSkudG9Mb3dlckNhc2UoKTtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgc3BlY2lhbERlcGVuZGVuY2llcygpOiBTcGVjaWFsRGVwZW5kZW5jaWVzIHtcbiAgICByZXR1cm4ge1xuICAgICAgcnVudGltZTogdHJ1ZSxcbiAgICAgIGluaXQ6IHRoaXMubWV0aG9kLnN0YXRpYyxcbiAgICAgIGludGVybmFsOiBmYWxzZSxcbiAgICAgIHRpbWU6XG4gICAgICAgICEhdGhpcy5wYXJhbWV0ZXJzLnNvbWUoKHApID0+IHAucmVmZXJlbmNlLnNwZWNpYWxEZXBlbmRlbmNpZXMudGltZSkgfHxcbiAgICAgICAgISF0aGlzLnJlZmVyZW5jZT8uc3BlY2lhbERlcGVuZGVuY2llcy50aW1lLFxuICAgIH07XG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIFN0YXRpY01ldGhvZCBleHRlbmRzIENsYXNzTWV0aG9kIHtcbiAgcHVibGljIGNvbnN0cnVjdG9yKFxuICAgIHB1YmxpYyByZWFkb25seSBwYXJlbnQ6IEdvQ2xhc3MsXG4gICAgcHVibGljIHJlYWRvbmx5IG1ldGhvZDogTWV0aG9kLFxuICApIHtcbiAgICBzdXBlcihwYXJlbnQsIG1ldGhvZCk7XG4gIH1cblxuICBwdWJsaWMgZW1pdCh7IGNvZGUsIGRvY3VtZW50ZXIgfTogRW1pdENvbnRleHQpIHtcbiAgICBjb25zdCBuYW1lID0gYCR7dGhpcy5wYXJlbnQubmFtZX1fJHt0aGlzLm5hbWV9YDtcbiAgICBjb25zdCByZXR1cm5UeXBlU3RyaW5nID0gdGhpcy5yZWZlcmVuY2U/LnZvaWQgPyAnJyA6IGAgJHt0aGlzLnJldHVyblR5cGV9YDtcblxuICAgIGRvY3VtZW50ZXIuZW1pdCh0aGlzLm1ldGhvZC5kb2NzKTtcbiAgICBjb2RlLm9wZW5CbG9jayhgZnVuYyAke25hbWV9KCR7dGhpcy5wYXJhbVN0cmluZygpfSkke3JldHVyblR5cGVTdHJpbmd9YCk7XG5cbiAgICB0aGlzLnJ1bnRpbWVDYWxsLmVtaXQoY29kZSk7XG5cbiAgICBjb2RlLmNsb3NlQmxvY2soKTtcbiAgICBjb2RlLmxpbmUoKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBpc0dvTWV0aG9kKG06IEdvVHlwZU1lbWJlcik6IG0gaXMgR29NZXRob2Qge1xuICByZXR1cm4gbSBpbnN0YW5jZW9mIEdvTWV0aG9kO1xufVxuIl19