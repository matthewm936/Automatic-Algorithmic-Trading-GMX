"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.md2html = exports.md2rst = void 0;
const commonmark = require("commonmark");
/**
 * Convert MarkDown to RST
 */
function md2rst(text) {
    const parser = new commonmark.Parser({ smart: false });
    const ast = parser.parse(text);
    const doc = new DocumentBuilder();
    function directive(name, opening) {
        if (opening) {
            doc.appendLine(`.. ${name}::`);
            doc.paraBreak();
            doc.pushPrefix('   ');
        }
        else {
            doc.popPrefix();
        }
    }
    function textOf(node) {
        var _a, _b;
        return (_b = (_a = node.literal) === null || _a === void 0 ? void 0 : _a.replace(/\\/g, '\\\\')) !== null && _b !== void 0 ? _b : '';
    }
    pump(ast, {
        block_quote(_node, entering) {
            directive('epigraph', entering);
        },
        heading(node, _entering) {
            var _a;
            doc.appendLine((_a = node.literal) !== null && _a !== void 0 ? _a : '');
            doc.appendLine(headings[node.level - 1].repeat(textOf(node).length));
        },
        paragraph(node, entering) {
            var _a;
            // If we're going to a paragraph that's not in a list, open a block.
            if (entering && node.parent && node.parent.type !== 'item') {
                doc.paraBreak();
            }
            // If we're coming out of a paragraph that's being followed by
            // a code block, make sure the current line ends in '::':
            if (!entering && node.next && ((_a = node.next) === null || _a === void 0 ? void 0 : _a.type) === 'code_block') {
                doc.transformLastLine((lastLine) => {
                    const appended = lastLine.replace(/[\W]$/, '::');
                    if (appended !== lastLine) {
                        return appended;
                    }
                    return `${lastLine} Example::`;
                });
            }
            // End of paragraph at least implies line break.
            if (!entering) {
                doc.newline();
            }
        },
        text(node) {
            doc.append(textOf(node));
        },
        softbreak() {
            doc.newline();
        },
        linebreak() {
            doc.newline();
        },
        thematic_break() {
            doc.appendLine('------');
        },
        code(node) {
            doc.append(`\`\`${textOf(node)}\`\``);
        },
        strong() {
            doc.append('**');
        },
        emph() {
            doc.append('*');
        },
        list() {
            doc.paraBreak();
        },
        link(node, entering) {
            var _a;
            if (entering) {
                doc.append('`');
            }
            else {
                doc.append(` <${(_a = node.destination) !== null && _a !== void 0 ? _a : ''}>\`_`);
            }
        },
        item(node, entering) {
            // AST hierarchy looks like list -> item -> paragraph -> text
            if (entering) {
                if (node.listType === 'bullet') {
                    doc.pushBulletPrefix('- ');
                }
                else {
                    doc.pushBulletPrefix(`${node.listStart}. `);
                }
            }
            else {
                doc.popPrefix();
            }
        },
        code_block(node) {
            doc.paraBreak();
            // If there's no paragraph just before me, add the word "Example::".
            if (!node.prev || node.prev.type !== 'paragraph') {
                doc.appendLine('Example::');
                doc.paraBreak();
            }
            doc.pushBulletPrefix('   ');
            for (const l of textOf(node).replace(/\n+$/, '').split('\n')) {
                doc.appendLine(l);
            }
            doc.popPrefix();
        },
    });
    return doc.toString();
}
exports.md2rst = md2rst;
function md2html(text) {
    const parser = new commonmark.Parser({ smart: false });
    const renderer = new commonmark.HtmlRenderer({ smart: false, safe: true });
    return renderer.render(parser.parse(text));
}
exports.md2html = md2html;
/**
 * Build a document incrementally
 */
class DocumentBuilder {
    constructor() {
        this.prefix = new Array();
        this.lines = new Array();
        this.queuedNewline = false;
        this.lines.push([]);
    }
    pushPrefix(prefix) {
        this.prefix.push(prefix);
    }
    popPrefix() {
        this.prefix.pop();
    }
    paraBreak() {
        if (this.lines.length > 0 && partsToString(this.lastLine) !== '') {
            this.newline();
        }
    }
    get length() {
        return this.lines.length;
    }
    get lastLine() {
        return this.lines[this.length - 1];
    }
    append(text) {
        this.flushQueuedNewline();
        this.lastLine.push(text);
    }
    appendLine(...lines) {
        for (const line of lines) {
            this.append(line);
            this.newline();
        }
    }
    pushBulletPrefix(prefix) {
        this.append(prefix);
        this.pushPrefix(' '.repeat(prefix.length));
    }
    transformLastLine(block) {
        if (this.length >= 0) {
            this.lines[this.length - 1].splice(0, this.lastLine.length, block(partsToString(this.lastLine)));
        }
        else {
            this.lines.push([block('')]);
        }
    }
    newline() {
        this.flushQueuedNewline();
        // Don't do the newline here, wait to apply the correct indentation when and if we add more text.
        this.queuedNewline = true;
    }
    toString() {
        return this.lines.map(partsToString).join('\n').replace(/\n+$/, '');
    }
    flushQueuedNewline() {
        if (this.queuedNewline) {
            this.lines.push([...this.prefix]);
            this.queuedNewline = false;
        }
    }
}
/**
 * Turn a list of string fragments into a string
 */
function partsToString(parts) {
    return parts.join('').trimRight();
}
const headings = ['=', '-', '^', '"'];
/**
 * Pump a CommonMark AST tree through a set of handlers
 */
function pump(ast, handlers) {
    const walker = ast.walker();
    let event = walker.next();
    while (event) {
        const h = handlers[event.node.type];
        if (h) {
            h(event.node, event.entering);
        }
        event = walker.next();
    }
}
/*
  A typical AST looks like this:

  document
   ├─┬ paragraph
   │ └── text
   └─┬ list
     ├─┬ item
     │ └─┬ paragraph
     │   ├── text
     │   ├── softbreak
     │   └── text
     └─┬ item
       └─┬ paragraph
         ├── text
         ├─┬ emph
         │ └── text
         └── text

 */
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFya2Rvd24uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJtYXJrZG93bi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSx5Q0FBeUM7QUFFekM7O0dBRUc7QUFDSCxTQUFnQixNQUFNLENBQUMsSUFBWTtJQUNqQyxNQUFNLE1BQU0sR0FBRyxJQUFJLFVBQVUsQ0FBQyxNQUFNLENBQUMsRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQztJQUN2RCxNQUFNLEdBQUcsR0FBRyxNQUFNLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBRS9CLE1BQU0sR0FBRyxHQUFHLElBQUksZUFBZSxFQUFFLENBQUM7SUFFbEMsU0FBUyxTQUFTLENBQUMsSUFBWSxFQUFFLE9BQWdCO1FBQy9DLElBQUksT0FBTyxFQUFFO1lBQ1gsR0FBRyxDQUFDLFVBQVUsQ0FBQyxNQUFNLElBQUksSUFBSSxDQUFDLENBQUM7WUFDL0IsR0FBRyxDQUFDLFNBQVMsRUFBRSxDQUFDO1lBQ2hCLEdBQUcsQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLENBQUM7U0FDdkI7YUFBTTtZQUNMLEdBQUcsQ0FBQyxTQUFTLEVBQUUsQ0FBQztTQUNqQjtJQUNILENBQUM7SUFFRCxTQUFTLE1BQU0sQ0FBQyxJQUFxQjs7UUFDbkMsbUJBQU8sSUFBSSxDQUFDLE9BQU8sMENBQUUsT0FBTyxDQUFDLEtBQUssRUFBRSxNQUFNLG9DQUFLLEVBQUUsQ0FBQztJQUNwRCxDQUFDO0lBRUQsSUFBSSxDQUFDLEdBQUcsRUFBRTtRQUNSLFdBQVcsQ0FBQyxLQUFLLEVBQUUsUUFBUTtZQUN6QixTQUFTLENBQUMsVUFBVSxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBQ2xDLENBQUM7UUFFRCxPQUFPLENBQUMsSUFBSSxFQUFFLFNBQVM7O1lBQ3JCLEdBQUcsQ0FBQyxVQUFVLE9BQUMsSUFBSSxDQUFDLE9BQU8sbUNBQUksRUFBRSxDQUFDLENBQUM7WUFDbkMsR0FBRyxDQUFDLFVBQVUs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QUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0FBS3RDOztHQUVHO0FBQ0gsU0FBUyxJQUFJLENBQUMsR0FBb0IsRUFBRSxRQUFrQjtJQUNwRCxNQUFNLE1BQU0sR0FBRyxHQUFHLENBQUMsTUFBTSxFQUFFLENBQUM7SUFDNUIsSUFBSSxLQUFLLEdBQUcsTUFBTSxDQUFDLElBQUksRUFBRSxDQUFDO0lBQzFCLE9BQU8sS0FBSyxFQUFFO1FBQ1osTUFBTSxDQUFDLEdBQUcsUUFBUSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDcEMsSUFBSSxDQUFDLEVBQUU7WUFDTCxDQUFDLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxLQUFLLENBQUMsUUFBUSxDQUFDLENBQUM7U0FDL0I7UUFFRCxLQUFLLEdBQUcsTUFBTSxDQUFDLElBQUksRUFBRSxDQUFDO0tBQ3ZCO0FBQ0gsQ0FBQztBQUVEOzs7Ozs7Ozs7Ozs7Ozs7Ozs7O0dBbUJHIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgY29tbW9ubWFyayBmcm9tICdjb21tb25tYXJrJztcblxuLyoqXG4gKiBDb252ZXJ0IE1hcmtEb3duIHRvIFJTVFxuICovXG5leHBvcnQgZnVuY3Rpb24gbWQycnN0KHRleHQ6IHN0cmluZykge1xuICBjb25zdCBwYXJzZXIgPSBuZXcgY29tbW9ubWFyay5QYXJzZXIoeyBzbWFydDogZmFsc2UgfSk7XG4gIGNvbnN0IGFzdCA9IHBhcnNlci5wYXJzZSh0ZXh0KTtcblxuICBjb25zdCBkb2MgPSBuZXcgRG9jdW1lbnRCdWlsZGVyKCk7XG5cbiAgZnVuY3Rpb24gZGlyZWN0aXZlKG5hbWU6IHN0cmluZywgb3BlbmluZzogYm9vbGVhbikge1xuICAgIGlmIChvcGVuaW5nKSB7XG4gICAgICBkb2MuYXBwZW5kTGluZShgLi4gJHtuYW1lfTo6YCk7XG4gICAgICBkb2MucGFyYUJyZWFrKCk7XG4gICAgICBkb2MucHVzaFByZWZpeCgnICAgJyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGRvYy5wb3BQcmVmaXgoKTtcbiAgICB9XG4gIH1cblxuICBmdW5jdGlvbiB0ZXh0T2Yobm9kZTogY29tbW9ubWFyay5Ob2RlKSB7XG4gICAgcmV0dXJuIG5vZGUubGl0ZXJhbD8ucmVwbGFjZSgvXFxcXC9nLCAnXFxcXFxcXFwnKSA/PyAnJztcbiAgfVxuXG4gIHB1bXAoYXN0LCB7XG4gICAgYmxvY2tfcXVvdGUoX25vZGUsIGVudGVyaW5nKSB7XG4gICAgICBkaXJlY3RpdmUoJ2VwaWdyYXBoJywgZW50ZXJpbmcpO1xuICAgIH0sXG5cbiAgICBoZWFkaW5nKG5vZGUsIF9lbnRlcmluZykge1xuICAgICAgZG9jLmFwcGVuZExpbmUobm9kZS5saXRlcmFsID8/ICcnKTtcbiAgICAgIGRvYy5hcHBlbmRMaW5lKGhlYWRpbmdzW25vZGUubGV2ZWwgLSAxXS5yZXBlYXQodGV4dE9mKG5vZGUpLmxlbmd0aCkpO1xuICAgIH0sXG5cbiAgICBwYXJhZ3JhcGgobm9kZSwgZW50ZXJpbmcpIHtcbiAgICAgIC8vIElmIHdlJ3JlIGdvaW5nIHRvIGEgcGFyYWdyYXBoIHRoYXQncyBub3QgaW4gYSBsaXN0LCBvcGVuIGEgYmxvY2suXG4gICAgICBpZiAoZW50ZXJpbmcgJiYgbm9kZS5wYXJlbnQgJiYgbm9kZS5wYXJlbnQudHlwZSAhPT0gJ2l0ZW0nKSB7XG4gICAgICAgIGRvYy5wYXJhQnJlYWsoKTtcbiAgICAgIH1cblxuICAgICAgLy8gSWYgd2UncmUgY29taW5nIG91dCBvZiBhIHBhcmFncmFwaCB0aGF0J3MgYmVpbmcgZm9sbG93ZWQgYnlcbiAgICAgIC8vIGEgY29kZSBibG9jaywgbWFrZSBzdXJlIHRoZSBjdXJyZW50IGxpbmUgZW5kcyBpbiAnOjonOlxuICAgICAgaWYgKCFlbnRlcmluZyAmJiBub2RlLm5leHQgJiYgbm9kZS5uZXh0Py50eXBlID09PSAnY29kZV9ibG9jaycpIHtcbiAgICAgICAgZG9jLnRyYW5zZm9ybUxhc3RMaW5lKChsYXN0TGluZSkgPT4ge1xuICAgICAgICAgIGNvbnN0IGFwcGVuZGVkID0gbGFzdExpbmUucmVwbGFjZSgvW1xcV10kLywgJzo6Jyk7XG4gICAgICAgICAgaWYgKGFwcGVuZGVkICE9PSBsYXN0TGluZSkge1xuICAgICAgICAgICAgcmV0dXJuIGFwcGVuZGVkO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIHJldHVybiBgJHtsYXN0TGluZX0gRXhhbXBsZTo6YDtcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIC8vIEVuZCBvZiBwYXJhZ3JhcGggYXQgbGVhc3QgaW1wbGllcyBsaW5lIGJyZWFrLlxuICAgICAgaWYgKCFlbnRlcmluZykge1xuICAgICAgICBkb2MubmV3bGluZSgpO1xuICAgICAgfVxuICAgIH0sXG5cbiAgICB0ZXh0KG5vZGUpIHtcbiAgICAgIGRvYy5hcHBlbmQodGV4dE9mKG5vZGUpKTtcbiAgICB9LFxuICAgIHNvZnRicmVhaygpIHtcbiAgICAgIGRvYy5uZXdsaW5lKCk7XG4gICAgfSxcbiAgICBsaW5lYnJlYWsoKSB7XG4gICAgICBkb2MubmV3bGluZSgpO1xuICAgIH0sXG4gICAgdGhlbWF0aWNfYnJlYWsoKSB7XG4gICAgICBkb2MuYXBwZW5kTGluZSgnLS0tLS0tJyk7XG4gICAgfSxcbiAgICBjb2RlKG5vZGUpIHtcbiAgICAgIGRvYy5hcHBlbmQoYFxcYFxcYCR7dGV4dE9mKG5vZGUpfVxcYFxcYGApO1xuICAgIH0sXG4gICAgc3Ryb25nKCkge1xuICAgICAgZG9jLmFwcGVuZCgnKionKTtcbiAgICB9LFxuICAgIGVtcGgoKSB7XG4gICAgICBkb2MuYXBwZW5kKCcqJyk7XG4gICAgfSxcblxuICAgIGxpc3QoKSB7XG4gICAgICBkb2MucGFyYUJyZWFrKCk7XG4gICAgfSxcblxuICAgIGxpbmsobm9kZSwgZW50ZXJpbmcpIHtcbiAgICAgIGlmIChlbnRlcmluZykge1xuICAgICAgICBkb2MuYXBwZW5kKCdgJyk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBkb2MuYXBwZW5kKGAgPCR7bm9kZS5kZXN0aW5hdGlvbiA/PyAnJ30+XFxgX2ApO1xuICAgICAgfVxuICAgIH0sXG5cbiAgICBpdGVtKG5vZGUsIGVudGVyaW5nKSB7XG4gICAgICAvLyBBU1QgaGllcmFyY2h5IGxvb2tzIGxpa2UgbGlzdCAtPiBpdGVtIC0+IHBhcmFncmFwaCAtPiB0ZXh0XG4gICAgICBpZiAoZW50ZXJpbmcpIHtcbiAgICAgICAgaWYgKG5vZGUubGlzdFR5cGUgPT09ICdidWxsZXQnKSB7XG4gICAgICAgICAgZG9jLnB1c2hCdWxsZXRQcmVmaXgoJy0gJyk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgZG9jLnB1c2hCdWxsZXRQcmVmaXgoYCR7bm9kZS5saXN0U3RhcnR9LiBgKTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgZG9jLnBvcFByZWZpeCgpO1xuICAgICAgfVxuICAgIH0sXG5cbiAgICBjb2RlX2Jsb2NrKG5vZGUpIHtcbiAgICAgIGRvYy5wYXJhQnJlYWsoKTtcblxuICAgICAgLy8gSWYgdGhlcmUncyBubyBwYXJhZ3JhcGgganVzdCBiZWZvcmUgbWUsIGFkZCB0aGUgd29yZCBcIkV4YW1wbGU6OlwiLlxuICAgICAgaWYgKCFub2RlLnByZXYgfHwgbm9kZS5wcmV2LnR5cGUgIT09ICdwYXJhZ3JhcGgnKSB7XG4gICAgICAgIGRvYy5hcHBlbmRMaW5lKCdFeGFtcGxlOjonKTtcbiAgICAgICAgZG9jLnBhcmFCcmVhaygpO1xuICAgICAgfVxuXG4gICAgICBkb2MucHVzaEJ1bGxldFByZWZpeCgnICAgJyk7XG5cbiAgICAgIGZvciAoY29uc3QgbCBvZiB0ZXh0T2Yobm9kZSkucmVwbGFjZSgvXFxuKyQvLCAnJykuc3BsaXQoJ1xcbicpKSB7XG4gICAgICAgIGRvYy5hcHBlbmRMaW5lKGwpO1xuICAgICAgfVxuXG4gICAgICBkb2MucG9wUHJlZml4KCk7XG4gICAgfSxcbiAgfSk7XG5cbiAgcmV0dXJuIGRvYy50b1N0cmluZygpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gbWQyaHRtbCh0ZXh0OiBzdHJpbmcpOiBzdHJpbmcge1xuICBjb25zdCBwYXJzZXIgPSBuZXcgY29tbW9ubWFyay5QYXJzZXIoeyBzbWFydDogZmFsc2UgfSk7XG4gIGNvbnN0IHJlbmRlcmVyID0gbmV3IGNvbW1vbm1hcmsuSHRtbFJlbmRlcmVyKHsgc21hcnQ6IGZhbHNlLCBzYWZlOiB0cnVlIH0pO1xuICByZXR1cm4gcmVuZGVyZXIucmVuZGVyKHBhcnNlci5wYXJzZSh0ZXh0KSk7XG59XG5cbi8qKlxuICogQnVpbGQgYSBkb2N1bWVudCBpbmNyZW1lbnRhbGx5XG4gKi9cbmNsYXNzIERvY3VtZW50QnVpbGRlciB7XG4gIHByaXZhdGUgcmVhZG9ubHkgcHJlZml4ID0gbmV3IEFycmF5PHN0cmluZz4oKTtcbiAgcHJpdmF0ZSByZWFkb25seSBsaW5lcyA9IG5ldyBBcnJheTxzdHJpbmdbXT4oKTtcbiAgcHJpdmF0ZSBxdWV1ZWROZXdsaW5lID0gZmFsc2U7XG5cbiAgcHVibGljIGNvbnN0cnVjdG9yKCkge1xuICAgIHRoaXMubGluZXMucHVzaChbXSk7XG4gIH1cblxuICBwdWJsaWMgcHVzaFByZWZpeChwcmVmaXg6IHN0cmluZykge1xuICAgIHRoaXMucHJlZml4LnB1c2gocHJlZml4KTtcbiAgfVxuXG4gIHB1YmxpYyBwb3BQcmVmaXgoKSB7XG4gICAgdGhpcy5wcmVmaXgucG9wKCk7XG4gIH1cblxuICBwdWJsaWMgcGFyYUJyZWFrKCkge1xuICAgIGlmICh0aGlzLmxpbmVzLmxlbmd0aCA+IDAgJiYgcGFydHNUb1N0cmluZyh0aGlzLmxhc3RMaW5lKSAhPT0gJycpIHtcbiAgICAgIHRoaXMubmV3bGluZSgpO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBnZXQgbGVuZ3RoKCkge1xuICAgIHJldHVybiB0aGlzLmxpbmVzLmxlbmd0aDtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgbGFzdExpbmUoKSB7XG4gICAgcmV0dXJuIHRoaXMubGluZXNbdGhpcy5sZW5ndGggLSAxXTtcbiAgfVxuXG4gIHB1YmxpYyBhcHBlbmQodGV4dDogc3RyaW5nKSB7XG4gICAgdGhpcy5mbHVzaFF1ZXVlZE5ld2xpbmUoKTtcbiAgICB0aGlzLmxhc3RMaW5lLnB1c2godGV4dCk7XG4gIH1cblxuICBwdWJsaWMgYXBwZW5kTGluZSguLi5saW5lczogc3RyaW5nW10pIHtcbiAgICBmb3IgKGNvbnN0IGxpbmUgb2YgbGluZXMpIHtcbiAgICAgIHRoaXMuYXBwZW5kKGxpbmUpO1xuICAgICAgdGhpcy5uZXdsaW5lKCk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIHB1c2hCdWxsZXRQcmVmaXgocHJlZml4OiBzdHJpbmcpIHtcbiAgICB0aGlzLmFwcGVuZChwcmVmaXgpO1xuICAgIHRoaXMucHVzaFByZWZpeCgnICcucmVwZWF0KHByZWZpeC5sZW5ndGgpKTtcbiAgfVxuXG4gIHB1YmxpYyB0cmFuc2Zvcm1MYXN0TGluZShibG9jazogKHg6IHN0cmluZykgPT4gc3RyaW5nKSB7XG4gICAgaWYgKHRoaXMubGVuZ3RoID49IDApIHtcbiAgICAgIHRoaXMubGluZXNbdGhpcy5sZW5ndGggLSAxXS5zcGxpY2UoXG4gICAgICAgIDAsXG4gICAgICAgIHRoaXMubGFzdExpbmUubGVuZ3RoLFxuICAgICAgICBibG9jayhwYXJ0c1RvU3RyaW5nKHRoaXMubGFzdExpbmUpKSxcbiAgICAgICk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMubGluZXMucHVzaChbYmxvY2soJycpXSk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIG5ld2xpbmUoKSB7XG4gICAgdGhpcy5mbHVzaFF1ZXVlZE5ld2xpbmUoKTtcbiAgICAvLyBEb24ndCBkbyB0aGUgbmV3bGluZSBoZXJlLCB3YWl0IHRvIGFwcGx5IHRoZSBjb3JyZWN0IGluZGVudGF0aW9uIHdoZW4gYW5kIGlmIHdlIGFkZCBtb3JlIHRleHQuXG4gICAgdGhpcy5xdWV1ZWROZXdsaW5lID0gdHJ1ZTtcbiAgfVxuXG4gIHB1YmxpYyB0b1N0cmluZygpIHtcbiAgICByZXR1cm4gdGhpcy5saW5lcy5tYXAocGFydHNUb1N0cmluZykuam9pbignXFxuJykucmVwbGFjZSgvXFxuKyQvLCAnJyk7XG4gIH1cblxuICBwcml2YXRlIGZsdXNoUXVldWVkTmV3bGluZSgpIHtcbiAgICBpZiAodGhpcy5xdWV1ZWROZXdsaW5lKSB7XG4gICAgICB0aGlzLmxpbmVzLnB1c2goWy4uLnRoaXMucHJlZml4XSk7XG4gICAgICB0aGlzLnF1ZXVlZE5ld2xpbmUgPSBmYWxzZTtcbiAgICB9XG4gIH1cbn1cblxuLyoqXG4gKiBUdXJuIGEgbGlzdCBvZiBzdHJpbmcgZnJhZ21lbnRzIGludG8gYSBzdHJpbmdcbiAqL1xuZnVuY3Rpb24gcGFydHNUb1N0cmluZyhwYXJ0czogc3RyaW5nW10pIHtcbiAgcmV0dXJuIHBhcnRzLmpvaW4oJycpLnRyaW1SaWdodCgpO1xufVxuXG5jb25zdCBoZWFkaW5ncyA9IFsnPScsICctJywgJ14nLCAnXCInXTtcblxudHlwZSBIYW5kbGVyID0gKG5vZGU6IGNvbW1vbm1hcmsuTm9kZSwgZW50ZXJpbmc6IGJvb2xlYW4pID0+IHZvaWQ7XG50eXBlIEhhbmRsZXJzID0geyBba2V5IGluIGNvbW1vbm1hcmsuTm9kZVR5cGVdPzogSGFuZGxlciB9O1xuXG4vKipcbiAqIFB1bXAgYSBDb21tb25NYXJrIEFTVCB0cmVlIHRocm91Z2ggYSBzZXQgb2YgaGFuZGxlcnNcbiAqL1xuZnVuY3Rpb24gcHVtcChhc3Q6IGNvbW1vbm1hcmsuTm9kZSwgaGFuZGxlcnM6IEhhbmRsZXJzKSB7XG4gIGNvbnN0IHdhbGtlciA9IGFzdC53YWxrZXIoKTtcbiAgbGV0IGV2ZW50ID0gd2Fsa2VyLm5leHQoKTtcbiAgd2hpbGUgKGV2ZW50KSB7XG4gICAgY29uc3QgaCA9IGhhbmRsZXJzW2V2ZW50Lm5vZGUudHlwZV07XG4gICAgaWYgKGgpIHtcbiAgICAgIGgoZXZlbnQubm9kZSwgZXZlbnQuZW50ZXJpbmcpO1xuICAgIH1cblxuICAgIGV2ZW50ID0gd2Fsa2VyLm5leHQoKTtcbiAgfVxufVxuXG4vKlxuICBBIHR5cGljYWwgQVNUIGxvb2tzIGxpa2UgdGhpczpcblxuICBkb2N1bWVudFxuICAg4pSc4pSA4pSsIHBhcmFncmFwaFxuICAg4pSCIOKUlOKUgOKUgCB0ZXh0XG4gICDilJTilIDilKwgbGlzdFxuICAgICDilJzilIDilKwgaXRlbVxuICAgICDilIIg4pSU4pSA4pSsIHBhcmFncmFwaFxuICAgICDilIIgICDilJzilIDilIAgdGV4dFxuICAgICDilIIgICDilJzilIDilIAgc29mdGJyZWFrXG4gICAgIOKUgiAgIOKUlOKUgOKUgCB0ZXh0XG4gICAgIOKUlOKUgOKUrCBpdGVtXG4gICAgICAg4pSU4pSA4pSsIHBhcmFncmFwaFxuICAgICAgICAg4pSc4pSA4pSAIHRleHRcbiAgICAgICAgIOKUnOKUgOKUrCBlbXBoXG4gICAgICAgICDilIIg4pSU4pSA4pSAIHRleHRcbiAgICAgICAgIOKUlOKUgOKUgCB0ZXh0XG5cbiAqL1xuIl19